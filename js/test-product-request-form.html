<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/advanced-image-upload-service.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #007bff; border-radius: 10px; padding: 30px; text-align: center; margin: 20px 0; cursor: pointer; background: #f8f9fa; }
        .upload-area:hover { background: #e3f2fd; }
        .uploaded { border-color: #28a745; background: #d4edda; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 5px; margin: 10px 0; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¸ Ø§Ø®ØªØ¨Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ·</h1>

        <div class="status info">
            <strong>Ø§Ù„Ù…ÙŠØ²Ø§Øª:</strong>
            <ul style="text-align: right; margin: 10px 0;">
                <li>âœ… Ø¶ØºØ· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØµÙˆØ±</li>
                <li>ğŸ“ Ø­Ø¯ Ø£Ù‚ØµÙ‰ 1MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©</li>
                <li>ğŸ¨ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©</li>
            </ul>
        </div>

        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ -->
        <div class="upload-area" id="upload1">
            <h3>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</h3>
            <p>Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p>
            <input type="file" id="file1" accept="image/*">
        </div>

        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© -->
        <div class="upload-area" id="upload2">
            <h3>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</h3>
            <p>Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p>
            <input type="file" id="file2" accept="image/*">
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="test-btn" class="btn">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let uploadService = null;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

            try {
                // ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø±ÙØ¹
                uploadService = new AdvancedImageUploadService({
                    maxFileSize: 1024 * 1024,
                    maxWidth: 1200,
                    maxHeight: 1200,
                    quality: 0.85,
                    alwaysCompress: true
                });

                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ø±ÙØ¹');

                // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                setupUploadAreas();

                // Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                document.getElementById('test-btn').addEventListener('click', testSystem);

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
            }
        });

        function setupUploadAreas() {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£ÙˆÙ„
            setupUploadArea('upload1', 'file1');

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ
            setupUploadArea('upload2', 'file2');
        }

        function setupUploadArea(areaId, fileId) {
            const area = document.getElementById(areaId);
            const fileInput = document.getElementById(fileId);

            // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹
            area.addEventListener('click', () => {
                fileInput.click();
            });

            // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                await handleFileUpload(area, file);
            });
        }

        async function handleFileUpload(area, file) {
            try {
                console.log(`ğŸ“ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ${file.name} (${formatBytes(file.size)})`);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                area.innerHTML = `
                    <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</h3>
                    <div class="status info">â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                `;

                // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                const result = await uploadService.uploadImage(file);

                if (result.success) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­:', result.data);

                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    area.classList.add('uploaded');
                    area.innerHTML = `
                        <h3>âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</h3>
                        <img src="${result.data.url}" class="image-preview" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©">
                        <div class="status success">
                            <p><strong>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ:</strong> ${formatBytes(result.data.originalSize)}</p>
                            <p><strong>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø¶ØºÙˆØ·:</strong> ${formatBytes(result.data.processedSize)}</p>
                            <p><strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ØºØ·:</strong> ${result.data.compressionRatio}%</p>
                        </div>
                        <button class="btn" onclick="resetUpload('${area.id}')">âŒ Ø¥Ø²Ø§Ù„Ø©</button>
                    `;

                    showMessage('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error);

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹
                resetUpload(area.id);
                showMessage(`Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ${error.message}`, 'error');
            }
        }

        function resetUpload(areaId) {
            const area = document.getElementById(areaId);
            const fileInput = document.getElementById(areaId.replace('upload', 'file'));

            area.classList.remove('uploaded');
            area.innerHTML = `
                <h3>Ø§Ù„ØµÙˆØ±Ø© ${areaId === 'upload1' ? 'Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„Ø«Ø§Ù†ÙŠØ©'}</h3>
                <p>Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p>
            `;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø«
            area.addEventListener('click', () => {
                fileInput.click();
            });

            // Ù…Ø³Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            fileInput.value = '';
        }

        async function testSystem() {
            console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…...');

            const testBtn = document.getElementById('test-btn');
            testBtn.disabled = true;
            testBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';

            try {
                // Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                const testImage = await createTestImage();
                const testFile = new File([testImage], 'test-image.png', { type: 'image/png' });

                console.log(`ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ø®ØªØ¨Ø§Ø±: ${formatBytes(testFile.size)}`);

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙØ¹
                const result = await uploadService.uploadImage(testFile);

                if (result.success) {
                    showMessage('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!', 'success');
                    console.log('ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­:', result.data);
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showMessage(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
            }

            testBtn.disabled = false;
            testBtn.textContent = 'ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…';
        }

        async function createTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 800;
            canvas.height = 600;

            // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø©
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);

            // Ø¥Ø¶Ø§ÙØ© Ù†Øµ
            ctx.fillStyle = 'white';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ØµÙˆØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©', 400, 300);

            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/png', 0.9);
            });
        }

        function showMessage(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);

            // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø¹Ù„Ù‰
            setTimeout(() => {
                results.scrollTop = results.scrollHeight;
            }, 100);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>