<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/advanced-image-upload-service.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±</h1>

    <div id="results"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const results = document.getElementById('results');

            function addResult(message, type = 'info') {
                const div = document.createElement('div');
                div.className = `test-result ${type}`;
                div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
                results.appendChild(div);
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            addResult('ðŸš€ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±...', 'info');

            try {
                // Test 1: Initialize service
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 1: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø©', 'info');

                const service = new AdvancedImageUploadService({
                    maxFileSize: 1024 * 1024, // 1MB
                    maxWidth: 1200,
                    maxHeight: 1200,
                    quality: 0.85,
                    alwaysCompress: true
                });

                addResult('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');

                // Test 2: Check if service is ready
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 2: ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©', 'info');

                const isReady = await service.ensureInitialized();
                if (isReady) {
                    addResult('âœ… Ø§Ù„Ø®Ø¯Ù…Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'success');
                } else {
                    addResult('âŒ Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©', 'error');
                }

                // Test 3: Create test image
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 3: Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ø®ØªØ¨Ø§Ø±', 'info');

                const testImageBlob = await createTestImage();
                const testFile = new File([testImageBlob], 'test-image.png', { type: 'image/png' });

                addResult(`ðŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø­Ø¬Ù… ${formatBytes(testFile.size)}`, 'success');

                // Test 4: Process image without uploading
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 4: Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©', 'info');

                const metadata = await service.getImageMetadata(testFile);
                addResult(`ðŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø©: ${metadata.width}x${metadata.height}, ${formatBytes(testFile.size)}`, 'info');

                // Test 5: Test file validation
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 5: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù', 'info');

                const validation = service.validateFile(testFile);
                if (validation.valid) {
                    addResult('âœ… Ø§Ù„Ù…Ù„Ù ØµØ§Ù„Ø­ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'success');
                } else {
                    addResult(`âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­: ${validation.error}`, 'error');
                }

                // Test 6: Test compression
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 6: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¶ØºØ·', 'info');

                const compressedFile = await service.processImage(testFile);
                const compressionRatio = ((1 - compressedFile.size / testFile.size) * 100).toFixed(1);

                addResult(`ðŸ—œï¸ ØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©: ${formatBytes(testFile.size)} â†’ ${formatBytes(compressedFile.size)} (${compressionRatio}% ØªÙˆÙÙŠØ±)`, 'success');

                // Test 7: Test aggressive compression
                addResult('ðŸ“‹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± 7: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¹Ø¯ÙˆØ§Ù†ÙŠ', 'info');

                // Create a large test image
                const largeImageBlob = await createLargeTestImage();
                const largeFile = new File([largeImageBlob], 'large-test.jpg', { type: 'image/jpeg' });

                const aggressivelyCompressed = await service.aggressiveCompress(largeFile);
                const aggressiveRatio = ((1 - aggressivelyCompressed.size / largeFile.size) * 100).toFixed(1);

                addResult(`ðŸ’ª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¹Ø¯ÙˆØ§Ù†ÙŠ: ${formatBytes(largeFile.size)} â†’ ${formatBytes(aggressivelyCompressed.size)} (${aggressiveRatio}% ØªÙˆÙÙŠØ±)`, 'success');

                addResult('ðŸŽ‰ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¶ØºØ· Ø¨Ù†Ø¬Ø§Ø­!', 'success');

            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
                console.error('Test error details:', error);

                // Show stack trace if available
                if (error.stack) {
                    console.error('Stack trace:', error.stack);
                }
            }
        });

        // Helper function to create a test image
        async function createTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 800;
            canvas.height = 600;

            // Create a gradient background
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#ff6b6b');
            gradient.addColorStop(1, '#4ecdc4');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);

            // Add some text
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¶ØºØ·', 400, 300);

            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/png', 0.9);
            });
        }

        // Helper function to create a large test image
        async function createLargeTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 2000;
            canvas.height = 1500;

            // Create a pattern
            for (let i = 0; i < 2000; i += 50) {
                for (let j = 0; j < 1500; j += 50) {
                    ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 60%)`;
                    ctx.fillRect(i, j, 50, 50);
                }
            }

            // Add text
            ctx.fillStyle = 'black';
            ctx.font = '72px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 1000, 750);

            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.95);
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
