<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار ضغط الصور</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/advanced-image-upload-service.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>🧪 اختبار ضغط الصور</h1>

    <div id="results"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const results = document.getElementById('results');

            function addResult(message, type = 'info') {
                const div = document.createElement('div');
                div.className = `test-result ${type}`;
                div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
                results.appendChild(div);
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            addResult('🚀 بدء اختبار خدمة ضغط الصور...', 'info');

            try {
                // Test 1: Initialize service
                addResult('📋 الاختبار 1: تهيئة الخدمة', 'info');

                const service = new AdvancedImageUploadService({
                    maxFileSize: 1024 * 1024, // 1MB
                    maxWidth: 1200,
                    maxHeight: 1200,
                    quality: 0.85,
                    alwaysCompress: true
                });

                addResult('✅ تم تهيئة الخدمة بنجاح', 'success');

                // Test 2: Check if service is ready
                addResult('📋 الاختبار 2: فحص جاهزية الخدمة', 'info');

                const isReady = await service.ensureInitialized();
                if (isReady) {
                    addResult('✅ الخدمة جاهزة للاستخدام', 'success');
                } else {
                    addResult('❌ الخدمة غير جاهزة', 'error');
                }

                // Test 3: Create test image
                addResult('📋 الاختبار 3: إنشاء صورة اختبار', 'info');

                const testImageBlob = await createTestImage();
                const testFile = new File([testImageBlob], 'test-image.png', { type: 'image/png' });

                addResult(`📏 تم إنشاء صورة اختبار بحجم ${formatBytes(testFile.size)}`, 'success');

                // Test 4: Process image without uploading
                addResult('📋 الاختبار 4: اختبار معالجة الصورة', 'info');

                const metadata = await service.getImageMetadata(testFile);
                addResult(`📊 معلومات الصورة: ${metadata.width}x${metadata.height}, ${formatBytes(testFile.size)}`, 'info');

                // Test 5: Test file validation
                addResult('📋 الاختبار 5: اختبار التحقق من صحة الملف', 'info');

                const validation = service.validateFile(testFile);
                if (validation.valid) {
                    addResult('✅ الملف صالح للمعالجة', 'success');
                } else {
                    addResult(`❌ الملف غير صالح: ${validation.error}`, 'error');
                }

                // Test 6: Test compression
                addResult('📋 الاختبار 6: اختبار الضغط', 'info');

                const compressedFile = await service.processImage(testFile);
                const compressionRatio = ((1 - compressedFile.size / testFile.size) * 100).toFixed(1);

                addResult(`🗜️ تم ضغط الصورة: ${formatBytes(testFile.size)} → ${formatBytes(compressedFile.size)} (${compressionRatio}% توفير)`, 'success');

                // Test 7: Test aggressive compression
                addResult('📋 الاختبار 7: اختبار الضغط العدواني', 'info');

                // Create a large test image
                const largeImageBlob = await createLargeTestImage();
                const largeFile = new File([largeImageBlob], 'large-test.jpg', { type: 'image/jpeg' });

                const aggressivelyCompressed = await service.aggressiveCompress(largeFile);
                const aggressiveRatio = ((1 - aggressivelyCompressed.size / largeFile.size) * 100).toFixed(1);

                addResult(`💪 الضغط العدواني: ${formatBytes(largeFile.size)} → ${formatBytes(aggressivelyCompressed.size)} (${aggressiveRatio}% توفير)`, 'success');

                addResult('🎉 تم إكمال جميع اختبارات الضغط بنجاح!', 'success');

            } catch (error) {
                addResult(`❌ خطأ في الاختبار: ${error.message}`, 'error');
                console.error('Test error details:', error);

                // Show stack trace if available
                if (error.stack) {
                    console.error('Stack trace:', error.stack);
                }
            }
        });

        // Helper function to create a test image
        async function createTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 800;
            canvas.height = 600;

            // Create a gradient background
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#ff6b6b');
            gradient.addColorStop(1, '#4ecdc4');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);

            // Add some text
            ctx.fillStyle = 'white';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('اختبار الضغط', 400, 300);

            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/png', 0.9);
            });
        }

        // Helper function to create a large test image
        async function createLargeTestImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 2000;
            canvas.height = 1500;

            // Create a pattern
            for (let i = 0; i < 2000; i += 50) {
                for (let j = 0; j < 1500; j += 50) {
                    ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 60%)`;
                    ctx.fillRect(i, j, 50, 50);
                }
            }

            // Add text
            ctx.fillStyle = 'black';
            ctx.font = '72px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('صورة كبيرة للاختبار', 1000, 750);

            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.95);
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
