<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فحص الإعلانات - قاعدة البيانات</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .ad-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .ad-card.cake { border-left: 5px solid #f59e0b; }
        .field { margin: 5px 0; }
        .field label { font-weight: bold; color: #333; margin-left: 10px; }
        .field span { color: #666; }
        .btn { padding: 10px 20px; margin: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        .status { padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px; }
        .status.active { background: #10b981; }
        .status.inactive { background: #ef4444; }
        .missing { color: #ef4444; font-weight: bold; }
        .success { color: #10b981; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 فحص الإعلانات في قاعدة البيانات</h1>
        
        <div>
            <button class="btn" onclick="loadAllAds()">تحميل جميع الإعلانات</button>
            <button class="btn" onclick="loadCakeAds()">إعلانات التورتات فقط</button>
            <button class="btn" onclick="testCakeQuery()">اختبار استعلام التورتات</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // تهيئة Supabase
        let supabase = null;
        
        // انتظار تحميل Supabase
        function waitForSupabase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.supabaseClient) {
                        supabase = window.supabaseClient;
                        resolve(supabase);
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // تحميل جميع الإعلانات
        async function loadAllAds() {
            await waitForSupabase();
            
            try {
                console.log('🔍 جلب جميع الإعلانات...');
                const { data, error } = await supabase
                    .from('advertisements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayAds(data, 'جميع الإعلانات');
            } catch (error) {
                document.getElementById('results').innerHTML = `<p style="color: red;">خطأ: ${error.message}</p>`;
            }
        }

        // تحميل إعلانات التورتات
        async function loadCakeAds() {
            await waitForSupabase();
            
            try {
                console.log('🔍 جلب إعلانات التورتات...');
                const { data, error } = await supabase
                    .from('advertisements')
                    .select('*')
                    .eq('ad_type', 'featured')
                    .eq('is_active', true)
                    .eq('category_section', 'cake')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayAds(data, 'إعلانات التورتات (الشروط المطبقة)');
            } catch (error) {
                document.getElementById('results').innerHTML = `<p style="color: red;">خطأ: ${error.message}</p>`;
            }
        }

        // اختبار استعلام التورتات مع تفاصيل
        async function testCakeQuery() {
            await waitForSupabase();
            
            try {
                const results = document.getElementById('results');
                results.innerHTML = '<h3>🧪 اختبار تفصيلي لاستعلام التورتات...</h3>';

                // خطوة 1: البحث عن إعلانات مع product_category = cake
                console.log('1️⃣ البحث عن إعلانات مع product_category = cake');
                const { data: cakeProducts, error: error1 } = await supabase
                    .from('advertisements')
                    .select('*')
                    .eq('product_category', 'cake');
                
                results.innerHTML += `<div><strong>إعلانات مع product_category = 'cake':</strong> ${cakeProducts?.length || 0}</div>`;

                // خطوة 2: البحث عن إعلانات مع category_section = cake
                console.log('2️⃣ البحث عن إعلانات مع category_section = cake');
                const { data: cakeSection, error: error2 } = await supabase
                    .from('advertisements')
                    .select('*')
                    .eq('category_section', 'cake');
                
                results.innerHTML += `<div><strong>إعلانات مع category_section = 'cake':</strong> ${cakeSection?.length || 0}</div>`;

                // خطوة 3: البحث عن إعلانات featured نشطة
                console.log('3️⃣ البحث عن إعلانات featured نشطة');
                const { data: featuredActive, error: error3 } = await supabase
                    .from('advertisements')
                    .select('*')
                    .eq('ad_type', 'featured')
                    .eq('is_active', true);
                
                results.innerHTML += `<div><strong>إعلانات featured نشطة:</strong> ${featuredActive?.length || 0}</div>`;

                // خطوة 4: الاستعلام الكامل مثل النظام
                console.log('4️⃣ الاستعلام الكامل مثل النظام');
                const { data: finalQuery, error: error4 } = await supabase
                    .from('advertisements')
                    .select('*')
                    .eq('ad_type', 'featured')
                    .eq('is_active', true)
                    .eq('category_section', 'cake')
                    .order('priority', { ascending: false })
                    .order('created_at', { ascending: false });
                
                results.innerHTML += `<div><strong>الاستعلام الكامل (مثل النظام):</strong> ${finalQuery?.length || 0}</div>`;

                // عرض تفاصيل النتائج
                if (cakeProducts && cakeProducts.length > 0) {
                    results.innerHTML += '<h4>📋 تفاصيل الإعلانات المرتبطة بالتورتات:</h4>';
                    displayAds(cakeProducts, 'إعلانات متعلقة بالتورتات');
                }

            } catch (error) {
                document.getElementById('results').innerHTML += `<p style="color: red;">خطأ: ${error.message}</p>`;
            }
        }

        // عرض الإعلانات
        function displayAds(ads, title) {
            const results = document.getElementById('results');
            
            if (!ads || ads.length === 0) {
                results.innerHTML = `<h3>${title}</h3><p class="warning">لا توجد إعلانات!</p>`;
                return;
            }

            let html = `<h3>${title} (${ads.length} إعلان)</h3>`;
            
            ads.forEach((ad, index) => {
                const isCakeRelated = ad.product_category === 'cake' || ad.category_section === 'cake';
                const isActiveAndFeatured = ad.is_active && ad.ad_type === 'featured';
                const hasCategorySection = !!ad.category_section;
                
                html += `
                    <div class="ad-card ${isCakeRelated ? 'cake' : ''}">
                        <h4>إعلان #${index + 1} - ${ad.title || 'بدون عنوان'}</h4>
                        
                        <div class="field">
                            <label>ID:</label> <span>${ad.id}</span>
                        </div>
                        
                        <div class="field">
                            <label>نوع الإعلان:</label> 
                            <span class="${ad.ad_type === 'featured' ? 'success' : 'warning'}">${ad.ad_type}</span>
                            ${ad.ad_type !== 'featured' ? '<span class="missing"> ← يجب أن يكون "featured"</span>' : ''}
                        </div>
                        
                        <div class="field">
                            <label>الحالة:</label> 
                            <span class="status ${ad.is_active ? 'active' : 'inactive'}">${ad.is_active ? 'نشط' : 'غير نشط'}</span>
                            ${!ad.is_active ? '<span class="missing"> ← يجب أن يكون نشطاً</span>' : ''}
                        </div>
                        
                        <div class="field">
                            <label>تصنيف المنتج:</label> 
                            <span class="${ad.product_category === 'cake' ? 'success' : ''}">${ad.product_category || 'غير محدد'}</span>
                        </div>
                        
                        <div class="field">
                            <label>قسم التصنيف:</label> 
                            <span class="${ad.category_section === 'cake' ? 'success' : hasCategorySection ? 'warning' : 'missing'}">${ad.category_section || 'غير محدد'}</span>
                            ${ad.category_section !== 'cake' ? '<span class="missing"> ← يجب أن يكون "cake" للظهور في قسم التورتات</span>' : ''}
                        </div>
                        
                        <div class="field">
                            <label>الموضع:</label> <span>${ad.position || 'غير محدد'}</span>
                        </div>
                        
                        <div class="field">
                            <label>الأولوية:</label> <span>${ad.priority || 'غير محدد'}</span>
                        </div>
                        
                        <div class="field">
                            <label>تاريخ الإنشاء:</label> <span>${new Date(ad.created_at).toLocaleString('ar-EG')}</span>
                        </div>
                        
                        ${ad.end_date ? `<div class="field">
                            <label>تاريخ الانتهاء:</label> <span>${new Date(ad.end_date).toLocaleString('ar-EG')}</span>
                        </div>` : ''}
                        
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>📊 تحليل:</strong>
                            ${isActiveAndFeatured && ad.category_section === 'cake' 
                                ? '<span class="success">✅ هذا الإعلان يجب أن يظهر في قسم التورتات!</span>'
                                : '<span class="warning">⚠️ هذا الإعلان لن يظهر في قسم التورتات</span>'}
                        </div>
                    </div>
                `;
            });
            
            results.innerHTML = html;
        }

        // تحميل تلقائي عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 صفحة فحص الإعلانات جاهزة');
        });
    </script>
</body>
</html>
