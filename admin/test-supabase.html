<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js?v=2025-08-22-1"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            direction: rtl;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }
        .test-section h3 {
            color: #374151;
            margin-bottom: 15px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-button.danger {
            background: #ef4444;
        }
        .test-button.danger:hover {
            background: #dc2626;
        }
        .test-button.success {
            background: #10b981;
        }
        .test-button.success:hover {
            background: #059669;
        }
        .log-area {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-success {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10b981;
        }
        .log-error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
        }
        .log-info {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid #3b82f6;
        }
        .log-warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 4px solid #f59e0b;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .status-connected {
            background: #10b981;
        }
        .status-disconnected {
            background: #ef4444;
        }
        .status-loading {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 صفحة اختبار Supabase</h1>
        <p>هذه الصفحة لاختبار الاتصال بـ Supabase والتحديث</p>
        
        <!-- حالة الاتصال -->
        <div class="test-section">
            <h3>
                حالة الاتصال
                <span id="connection-status" class="status-indicator status-loading"></span>
            </h3>
            <button class="test-button" onclick="testConnection()">اختبار الاتصال</button>
            <button class="test-button" onclick="checkTables()">فحص الجداول</button>
        </div>
        
        <!-- اختبار التحديث -->
        <div class="test-section">
            <h3>اختبار التحديث</h3>
            <div class="form-group">
                <label>اسم الجدول:</label>
                <input type="text" id="table-name" value="product_requests" placeholder="مثال: product_requests">
            </div>
            <div class="form-group">
                <label>معرف المنتج:</label>
                <input type="text" id="product-id" placeholder="أدخل معرف المنتج">
            </div>
            <div class="form-group">
                <label>الوصف الجديد:</label>
                <textarea id="new-description" placeholder="أدخل وصف جديد للاختبار"></textarea>
            </div>
            <div class="form-group">
                <label>السعر الجديد:</label>
                <input type="number" id="new-price" placeholder="أدخل سعر جديد">
            </div>
            <button class="test-button success" onclick="testUpdate()">اختبار التحديث</button>
            <button class="test-button" onclick="testFetch()">جلب البيانات</button>
            <button class="test-button danger" onclick="clearLog()">مسح السجل</button>
        </div>
        
        <!-- اختبارات إضافية -->
        <div class="test-section">
            <h3>اختبارات إضافية</h3>
            <button class="test-button" onclick="testInsert()">اختبار الإدراج</button>
            <button class="test-button" onclick="testDelete()">اختبار الحذف</button>
            <button class="test-button" onclick="testComplexQuery()">استعلام معقد</button>
        </div>
        
        <!-- سجل الاختبارات -->
        <div class="test-section">
            <h3>سجل الاختبارات</h3>
            <div id="log-area" class="log-area">
                <div class="log-entry log-info">🚀 صفحة الاختبار جاهزة. اضغط "اختبار الاتصال" للبدء.</div>
            </div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let connectionStatus = 'disconnected';

        // تهيئة الصفحة
        window.onload = async function() {
            log('📱 تهيئة صفحة الاختبار...', 'info');
            
            // انتظار تحميل Supabase
            let attempts = 0;
            const maxAttempts = 50;
            
            while (!window.supabaseClient && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.supabaseClient) {
                supabaseClient = window.supabaseClient;
                log('✅ تم تحميل Supabase client', 'success');
                updateConnectionStatus('connected');
            } else {
                log('❌ فشل في تحميل Supabase client', 'error');
                updateConnectionStatus('disconnected');
            }
        };

        // تحديث حالة الاتصال
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const indicator = document.getElementById('connection-status');
            indicator.className = `status-indicator status-${status}`;
            
            if (status === 'connected') {
                indicator.title = 'متصل';
            } else if (status === 'disconnected') {
                indicator.title = 'غير متصل';
            } else {
                indicator.title = 'جاري الاتصال...';
            }
        }

        // إضافة رسالة للسجل
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // اختبار الاتصال
        async function testConnection() {
            log('🔍 اختبار الاتصال بـ Supabase...', 'info');
            updateConnectionStatus('loading');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client غير متاح');
                }
                
                log('📡 Supabase client متاح', 'success');
                log(`🔧 نوع العميل: ${typeof supabaseClient}`, 'info');
                log(`🔧 خصائص العميل: ${Object.getOwnPropertyNames(supabaseClient).join(', ')}`, 'info');
                
                // اختبار استعلام بسيط
                const { data, error } = await supabaseClient
                    .from('product_requests')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                log('✅ الاتصال ناجح! تم الوصول لقاعدة البيانات', 'success');
                updateConnectionStatus('connected');
                
            } catch (error) {
                log(`❌ فشل الاتصال: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // فحص الجداول
        async function checkTables() {
            log('🔍 فحص الجداول المتاحة...', 'info');
            
            try {
                const tables = ['product_requests', 'products_koshat', 'products_cake', 'products_mirr', 'products_other', 'products_invitations'];
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('count')
                            .limit(1);
                        
                        if (error) {
                            log(`❌ جدول ${table}: ${error.message}`, 'error');
                        } else {
                            log(`✅ جدول ${table}: متاح`, 'success');
                        }
                    } catch (tableError) {
                        log(`❌ جدول ${table}: ${tableError.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`❌ فشل في فحص الجداول: ${error.message}`, 'error');
            }
        }

        // اختبار التحديث
        async function testUpdate() {
            const tableName = document.getElementById('table-name').value.trim();
            const productId = document.getElementById('product-id').value.trim();
            const newDescription = document.getElementById('new-description').value.trim();
            const newPrice = document.getElementById('new-price').value.trim();
            
            if (!tableName || !productId) {
                log('❌ يرجى إدخال اسم الجدول ومعرف المنتج', 'error');
                return;
            }
            
            log(`🔍 اختبار التحديث في جدول ${tableName} للمنتج ${productId}...`, 'info');
            
            try {
                // أولاً: جلب البيانات الحالية
                log('📥 جلب البيانات الحالية...', 'info');
                const { data: currentData, error: fetchError } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (fetchError) {
                    throw new Error(`فشل في جلب البيانات: ${fetchError.message}`);
                }
                
                log('✅ تم جلب البيانات الحالية', 'success');
                log(`📊 البيانات الحالية: ${JSON.stringify(currentData, null, 2)}`, 'info');
                
                // إعداد بيانات التحديث
                const updateData = {
                    description: newDescription || currentData.description,
                    updated_at: new Date().toISOString()
                };
                
                if (newPrice && newPrice.trim() !== '') {
                    updateData.price = parseFloat(newPrice);
                }
                
                log(`📝 بيانات التحديث: ${JSON.stringify(updateData, null, 2)}`, 'info');
                
                // تنفيذ التحديث
                log('🔄 تنفيذ التحديث...', 'info');
                const { data: updateResult, error: updateError } = await supabaseClient
                    .from(tableName)
                    .update(updateData)
                    .eq('id', productId)
                    .select();
                
                if (updateError) {
                    throw new Error(`فشل في التحديث: ${updateError.message}`);
                }
                
                log('✅ تم التحديث بنجاح!', 'success');
                log(`📊 نتيجة التحديث: ${JSON.stringify(updateResult, null, 2)}`, 'info');
                
                // التحقق من التحديث
                log('🔍 التحقق من التحديث...', 'info');
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (verifyError) {
                    log(`⚠️ فشل في التحقق: ${verifyError.message}`, 'warning');
                } else {
                    log('✅ تم التحقق من التحديث', 'success');
                    log(`📊 البيانات بعد التحديث: ${JSON.stringify(verifyData, null, 2)}`, 'info');
                    
                    // مقارنة البيانات
                    const descriptionChanged = currentData.description !== verifyData.description;
                    const priceChanged = currentData.price !== verifyData.price;
                    
                    log(`🔄 مقارنة التغييرات:`, 'info');
                    log(`   - الوصف تغير: ${descriptionChanged ? 'نعم' : 'لا'}`, 'info');
                    log(`   - السعر تغير: ${priceChanged ? 'نعم' : 'لا'}`, 'info');
                }
                
            } catch (error) {
                log(`❌ فشل في اختبار التحديث: ${error.message}`, 'error');
            }
        }

        // اختبار جلب البيانات
        async function testFetch() {
            const tableName = document.getElementById('table-name').value.trim();
            const productId = document.getElementById('product-id').value.trim();
            
            if (!tableName || !productId) {
                log('❌ يرجى إدخال اسم الجدول ومعرف المنتج', 'error');
                return;
            }
            
            log(`🔍 جلب البيانات من جدول ${tableName} للمنتج ${productId}...`, 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (error) {
                    throw error;
                }
                
                log('✅ تم جلب البيانات بنجاح!', 'success');
                log(`📊 البيانات: ${JSON.stringify(data, null, 2)}`, 'info');
                
            } catch (error) {
                log(`❌ فشل في جلب البيانات: ${error.message}`, 'error');
            }
        }

        // اختبار الإدراج
        async function testInsert() {
            const tableName = document.getElementById('table-name').value.trim();
            
            if (!tableName) {
                log('❌ يرجى إدخال اسم الجدول', 'error');
                return;
            }
            
            log(`🔍 اختبار الإدراج في جدول ${tableName}...`, 'info');
            
            try {
                const testData = {
                    description: `اختبار إدراج - ${new Date().toLocaleString('ar-EG')}`,
                    price: Math.floor(Math.random() * 1000) + 100,
                    category: 'test',
                    governorate: 'القاهرة',
                    created_at: new Date().toISOString()
                };
                
                log(`📝 بيانات الإدراج: ${JSON.stringify(testData, null, 2)}`, 'info');
                
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .insert(testData)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log('✅ تم الإدراج بنجاح!', 'success');
                log(`📊 المنتج المضاف: ${JSON.stringify(data[0], null, 2)}`, 'info');
                
                // تحديث معرف المنتج في النموذج
                document.getElementById('product-id').value = data[0].id;
                
            } catch (error) {
                log(`❌ فشل في الإدراج: ${error.message}`, 'error');
            }
        }

        // اختبار الحذف
        async function testDelete() {
            const tableName = document.getElementById('table-name').value.trim();
            const productId = document.getElementById('product-id').value.trim();
            
            if (!tableName || !productId) {
                log('❌ يرجى إدخال اسم الجدول ومعرف المنتج', 'error');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف المنتج ${productId} من جدول ${tableName}؟`)) {
                return;
            }
            
            log(`🔍 اختبار الحذف من جدول ${tableName} للمنتج ${productId}...`, 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from(tableName)
                    .delete()
                    .eq('id', productId)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log('✅ تم الحذف بنجاح!', 'success');
                log(`📊 المنتج المحذوف: ${JSON.stringify(data[0], null, 2)}`, 'info');
                
                // مسح معرف المنتج من النموذج
                document.getElementById('product-id').value = '';
                
            } catch (error) {
                log(`❌ فشل في الحذف: ${error.message}`, 'error');
            }
        }

        // اختبار استعلام معقد
        async function testComplexQuery() {
            const tableName = document.getElementById('table-name').value.trim();
            
            if (!tableName) {
                log('❌ يرجى إدخال اسم الجدول', 'error');
                return;
            }
            
            log(`🔍 اختبار استعلام معقد في جدول ${tableName}...`, 'info');
            
            try {
                // جلب عدد المنتجات
                const { count, error: countError } = await supabaseClient
                    .from(tableName)
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    throw countError;
                }
                
                log(`📊 إجمالي المنتجات في الجدول: ${count}`, 'success');
                
                // جلب آخر 5 منتجات
                const { data: recentData, error: recentError } = await supabaseClient
                    .from(tableName)
                    .select('id, description, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (recentError) {
                    throw recentError;
                }
                
                log('📊 آخر 5 منتجات:', 'info');
                recentData.forEach((item, index) => {
                    log(`   ${index + 1}. ID: ${item.id}, الوصف: ${item.description}`, 'info');
                });
                
            } catch (error) {
                log(`❌ فشل في الاستعلام المعقد: ${error.message}`, 'error');
            }
        }

        // مسح السجل
        function clearLog() {
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '<div class="log-entry log-info">🧹 تم مسح السجل</div>';
        }
    </script>
</body>
</html>
