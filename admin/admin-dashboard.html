<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - الرئيسية</title>
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" as="script">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/admin-security.js"></script>
    <script src="../js/product-requests-service.js"></script>
    <script src="../js/advertising-service.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1994970196400389"
     crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            direction: rtl;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 15px;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
        }

        .quick-actions {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .action-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .action-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .recent-activity {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 1.5em;
            color: #667eea;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .activity-time {
            color: #666;
            font-size: 0.9em;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* Product Requests Styles */
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .filter-btn.debug-btn {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .filter-btn.debug-btn:hover {
            background: #d97706;
            border-color: #d97706;
        }

        .filter-btn.test-btn {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .filter-btn.test-btn:hover {
            background: #059669;
            border-color: #059669;
        }

        .request-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-approved {
            background: #d1fae5;
            color: #059669;
        }

        .status-rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .request-images {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .request-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-approve:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-reject {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-reject:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-view {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn-modal-secondary:hover {
            border-color: #9ca3af;
            color: #374151;
        }

        /* ===== تصميم محترف لنافذة إضافة الإعلان ===== */
        
        /* خلفية النافذة المنبثقة */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay[style*="display: flex"] {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* محتوى النافذة المنبثقة */
        .modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(-30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
        }
        
        .modal-overlay[style*="display: flex"] .modal-content {
            transform: translateY(0) scale(1);
        }
        
        /* رأس النافذة المنبثقة */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg) scale(1.1);
        }
        
        /* جسم النافذة المنبثقة */
        .modal-body {
            padding: 32px;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            position: relative;
        }
        
        .modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
        }
        
        /* تأثيرات إضافية للنافذة */
        .modal-content {
            position: relative;
        }
        
        .modal-content::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea);
            border-radius: 26px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-content:hover::after {
            opacity: 0.1;
        }
        
        /* تذييل النافذة المنبثقة */
        .modal-footer {
            padding: 28px 32px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 0 0 24px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* ===== تصميم محترف لحقول النموذج ===== */
        
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-group label:hover {
            color: #667eea;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 3px rgba(102, 126, 234, 0.1),
                0 4px 8px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }
        
        .form-group select:hover,
        .form-group input:hover,
        .form-group textarea:hover {
            border-color: #d1d5db;
            transform: translateY(-1px);
        }
        
        .form-group select:disabled {
            background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* تصميم الصفوف */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        /* تصميم الأزرار */
        .btn-modal-primary,
        .btn-modal-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .btn-modal-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-modal-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modal-primary:hover::before {
            left: 100%;
        }
        
        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-modal-primary:active {
            transform: translateY(0);
        }
        
        .btn-modal-secondary {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            border: 2px solid #d1d5db;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-modal-secondary:hover {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        
        .btn-modal-primary span,
        .btn-modal-secondary span {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        
        .btn-modal-primary:hover span,
        .btn-modal-secondary:hover span {
            transform: scale(1.1);
        }
        
        /* Request Details Styles */
        .request-detail-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .request-detail-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            display: block;
        }

        .request-detail-value {
            color: #6b7280;
            line-height: 1.5;
        }

        .request-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .request-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .request-image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            transition: transform 0.2s ease;
        }

        .request-image-item:hover img {
            transform: scale(1.05);
        }

        .request-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .request-image-item:hover .request-image-overlay {
            opacity: 1;
        }

        .request-image-overlay button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s ease;
        }

        .request-image-overlay button:hover {
            background: #2563eb;
        }

        /* أنماط الإعلانات */
        .advertising-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .tab-btn:hover:not(.active) {
            background: #f3f4f6;
        }

        .add-ad-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-ad-btn:hover {
            background: #059669;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ads-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            display: block;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
        }
        
        /* أنماط الإحصائيات الشاملة */
        .stats-overview {
            padding: 20px;
        }
        
        .stats-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .main-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .stat-card.primary {
            border-left: 4px solid #3b82f6;
        }
        
        .stat-card.success {
            border-left: 4px solid #10b981;
        }
        
        .stat-card.info {
            border-left: 4px solid #06b6d4;
        }
        
        .stat-card.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f3f4f6;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-content .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 5px;
        }
        
        .stat-content .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .performance-stats {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .performance-stats h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .performance-label {
            font-weight: 500;
            color: #374151;
        }
        
        .performance-value {
            font-weight: 600;
            color: #111827;
            font-size: 1.125rem;
        }
        
        .detailed-stats {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .detailed-stats h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .stats-section h5 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .stats-table-container {
            overflow-x: auto;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-table th {
            background: #f3f4f6;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .stats-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .stats-table tr:hover {
            background: #f9fafb;
        }
        
        .stats-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }

        .ads-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .ads-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ads-table th,
        .ads-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        /* أنماط بطاقات الإعلانات */
        .ads-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .ad-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .ad-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .ad-card-header .ad-type-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .ad-card-header .ad-status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .ad-card-header .ad-status-badge.active {
            background: #10b981;
            color: white;
        }

        .ad-card-header .ad-status-badge.paused {
            background: #f59e0b;
            color: white;
        }

        .ad-card-header .ad-status-badge.expired {
            background: #ef4444;
            color: white;
        }

        .ad-card-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ad-card-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .ad-card-body {
            padding: 20px;
        }

        .ad-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ad-info-item {
            display: flex;
            flex-direction: column;
        }

        .ad-info-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ad-info-value {
            font-size: 0.875rem;
            color: #1f2937;
            font-weight: 500;
        }

        .ad-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .ad-stat-item {
            text-align: center;
        }

        .ad-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            display: block;
        }

        .ad-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .ad-card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ad-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ad-action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .ad-action-btn.edit:hover {
            background: #2563eb;
        }

        .ad-action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .ad-action-btn.delete:hover {
            background: #dc2626;
        }

        .ad-action-btn.pause {
            background: #f59e0b;
            color: white;
        }

        .ad-action-btn.pause:hover {
            background: #d97706;
        }

        .ad-action-btn.activate {
            background: #10b981;
            color: white;
        }

        .ad-action-btn.activate:hover {
            background: #059669;
        }

        /* رسالة عدم وجود إعلانات */
        .no-ads-message {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-ads-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .no-ads-message h3 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .no-ads-message p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.125rem;
        }

        .ads-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .ads-table tr:hover {
            background: #f9fafb;
        }

        .requests-filters {
            margin-bottom: 20px;
        }

        .requests-filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-modal-success {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-success:hover {
            background: #059669;
        }

        .btn-modal-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-danger:hover {
            background: #dc2626;
        }

        /* معلومات المنتج المرتبط */
        .ad-product-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 15px 20px;
            overflow: hidden;
        }

        .ad-product-info.no-product {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .product-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ad-product-info.no-product .product-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .product-badge {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .product-category {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .no-product-badge {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .product-details {
            padding: 15px;
        }

        .product-name {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .product-description {
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .product-price {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 12px;
        }

        .product-location {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }

        .location-item {
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #374151;
        }

        .product-images {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .images-count {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .product-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
        }

        .product-social {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .social-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* التصميم الجديد للبطاقات */
        .ad-card-elegant {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            position: relative;
        }

        .ad-card-elegant:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .ad-card-image-container {
            position: relative;
            height: 250px;
            overflow: hidden;
        }

        .ad-card-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .ad-card-elegant:hover .ad-card-main-image {
            transform: scale(1.1);
        }

        .ad-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .ad-card-elegant:hover .ad-card-overlay {
            opacity: 1;
        }

        .ad-card-badges {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .ad-type-badge-elegant {
            background: rgba(255,255,255,0.9);
            color: #374151;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .ad-status-badge-elegant {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .ad-status-badge-elegant.active {
            background: rgba(16, 185, 129, 0.9);
        }

        .ad-status-badge-elegant.paused {
            background: rgba(245, 158, 11, 0.9);
        }

        .ad-status-badge-elegant.expired {
            background: rgba(239, 68, 68, 0.9);
        }

        .ad-card-hover-info {
            text-align: center;
            color: white;
        }

        .hover-text {
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .ad-card-content {
            padding: 20px;
        }

        .ad-card-header-elegant {
            margin-bottom: 15px;
        }

        .ad-card-title-elegant {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .ad-card-subtitle-elegant {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .ad-card-product-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .product-name-elegant {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .product-price-elegant {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 5px;
        }

        .product-category-elegant {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .ad-card-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .meta-icon {
            font-size: 1rem;
        }

        .meta-text {
            color: #475569;
            font-weight: 500;
        }

        .ad-card-actions-elegant {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ad-action-btn-elegant {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ad-action-btn-elegant.edit {
            background: #3b82f6;
            color: white;
        }

        .ad-action-btn-elegant.edit:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .ad-action-btn-elegant.delete {
            background: #ef4444;
            color: white;
        }

        .ad-action-btn-elegant.delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* تحسين عرض البطاقات */
        #active-ads-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }
    </style>
</head>
<body>
    <script>
        // التحقق من الأمان - سيتم تنفيذه بعد تحميل adminSecurity
        async function checkAuthOnLoad() {
            // انتظار تحميل Supabase أولاً
            let attempts = 0;
            while (!window.supabaseClient && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.supabaseClient) {
                console.error('Supabase client not available');
                window.location.href = 'admin-login.html';
                return;
            }
            
            // التحقق من وجود مستخدم مسجل دخول
            try {
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (!user) {
                    console.log('No user logged in, redirecting to login');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                // التحقق من المستخدم المسجل
                console.log('User in dashboard:', user);
                
                // السماح لجميع المستخدمين المسجلين بالدخول (مؤقتاً)
                if (user.email) {
                    console.log('✅ User authenticated successfully');
                } else {
                    console.log('User not authenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                console.log('✅ User authenticated successfully');
                
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'admin-login.html';
                return;
            }
            
            // إذا وصلنا هنا، المستخدم مسجل دخول ولديه صلاحيات
            // انتظار تحميل adminSecurity للوظائف الأخرى
            while (!window.adminSecurity) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        checkAuthOnLoad();
    </script>

    <header class="header">
        <div class="header-content">
            <h1>🏠 لوحة الإدارة</h1>
            <div class="nav-buttons">
                <a href="../index.html" class="nav-btn">🏠 الصفحة الرئيسية</a>
                <a href="admin-users.html" class="nav-btn">إدارة المستخدمين</a>
                <button class="nav-btn" onclick="showAdvertisingPanel()">📢 الإعلانات</button>
                <button class="nav-btn" onclick="handleLogout()">تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="welcome-section">
            <h1 class="welcome-title">مرحباً بك في لوحة الإدارة</h1>
            <p class="welcome-subtitle">إدارة شاملة لجميع جوانب النظام</p>
            <div class="user-info" id="userInfo">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
        </div>

        <!-- إحصائيات سريعة -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">إجمالي المستخدمين</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📦</div>
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">إجمالي المنتجات</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🖼️</div>
                <div class="stat-number" id="totalImages">0</div>
                <div class="stat-label">إجمالي الصور</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📸</div>
                <div class="stat-number" id="avgImagesPerProduct">0</div>
                <div class="stat-label">متوسط الصور/منتج</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">المستخدمين النشطين</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔔</div>
                <div class="stat-number" id="recentLogs">0</div>
                <div class="stat-label">الأحداث الأخيرة</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📝</div>
                <div class="stat-number" id="pendingRequests">0</div>
                <div class="stat-label">طلبات في الانتظار</div>
            </div>
        </div>

        <!-- إجراءات سريعة -->
        <div class="quick-actions">
            <h2 class="section-title">إجراءات سريعة</h2>
            <div class="actions-grid">
                <a href="../index.html" class="action-card">
                    <div class="action-icon">🏠</div>
                    <div class="action-title">الصفحة الرئيسية</div>
                    <div class="action-description">العودة للصفحة الرئيسية للموقع</div>
                </a>
                <a href="admin-users.html" class="action-card">
                    <div class="action-icon">👥</div>
                    <div class="action-title">إدارة المستخدمين</div>
                    <div class="action-description">إضافة وتعديل وحذف المستخدمين</div>
                </a>
                <a href="add-product.html" class="action-card">
                    <div class="action-icon">➕</div>
                    <div class="action-title">إضافة منتج</div>
                    <div class="action-description">إضافة منتج جديد للنظام</div>
                </a>
                <a href="admin-products.html" class="action-card">
                    <div class="action-icon">📋</div>
                    <div class="action-title">إدارة المنتجات</div>
                    <div class="action-description">عرض وتعديل جميع المنتجات</div>
                </a>
                <a href="#" class="action-card" onclick="showProductRequests()">
                    <div class="action-icon">📝</div>
                    <div class="action-title">طلبات المنتجات</div>
                    <div class="action-description">مراجعة طلبات إضافة المنتجات</div>
                </a>
                <a href="#" class="action-card" onclick="showReports()">
                    <div class="action-icon">📊</div>
                    <div class="action-title">التقارير</div>
                    <div class="action-description">عرض تقارير النظام</div>
                </a>
                <a href="#" class="action-card" onclick="showAdvertisingPanel()">
                    <div class="action-icon">📢</div>
                    <div class="action-title">إدارة الإعلانات</div>
                    <div class="action-description">إدارة المنتجات المميزة والإعلانات</div>
                </a>
            </div>
        </div>

        <!-- النشاط الأخير -->
        <div class="recent-activity">
            <h2 class="section-title">النشاط الأخير</h2>
            <ul class="activity-list" id="activityList">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </ul>
        </div>

        <!-- قسم إدارة طلبات المنتجات -->
        <div id="product-requests-section" class="recent-activity" style="display: none;">
            <h2 class="section-title">إدارة طلبات المنتجات</h2>
            
            <!-- فلتر الحالة -->
            <div class="mb-6 flex justify-center gap-4">
                <button class="filter-btn active" data-status="all">الكل</button>
                <button class="filter-btn" data-status="pending">في الانتظار</button>
                <button class="filter-btn" data-status="approved">تمت الموافقة</button>
                <button class="filter-btn" data-status="rejected">مرفوضة</button>
            </div>
            
            <!-- قائمة الطلبات -->
            <div id="requests-list" class="space-y-4">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
            
            <!-- رسالة عدم وجود طلبات -->
            <div id="no-requests-message" class="text-center py-8 text-gray-500" style="display: none;">
                لا توجد طلبات في هذه الفئة
            </div>
        </div>

        <!-- قسم التقارير -->
        <div id="reports-section" class="recent-activity" style="display: none;">
            <h2 class="section-title">📊 تقارير النظام</h2>
            
            <!-- أزرار التقرير -->
            <div class="mb-6 flex justify-center gap-4 flex-wrap">
                <button class="filter-btn active" data-report="products">📦 تقرير المنتجات</button>
                <button class="filter-btn" data-report="users">👥 تقرير المستخدمين</button>
                <button class="filter-btn" data-report="images">🖼️ تقرير الصور</button>
                <button class="filter-btn" data-report="performance">⚡ تقرير الأداء</button>
            </div>
            
            <!-- محتوى التقارير -->
            <div id="reports-content" class="space-y-6">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
        </div>

        <!-- قسم الإعلانات -->
        <div id="advertising-panel" class="recent-activity" style="display: none;">
            <h2 class="section-title">📢 إدارة الإعلانات والمنتجات المميزة</h2>
            
            <!-- تبويبات الإعلانات -->
            <div class="advertising-tabs">
                <button class="filter-btn active" onclick="switchAdvertisingTab('active-ads')">الإعلانات النشطة</button>
                <button class="filter-btn" onclick="switchAdvertisingTab('ad-requests')">طلبات الإعلانات</button>
                <button class="filter-btn" onclick="showAddAdForm()">➕ إضافة إعلان جديد</button>
                <button class="filter-btn" onclick="showSystemStatistics()">📊 الإحصائيات الشاملة</button>
            </div>

            <!-- تبويب الإعلانات النشطة -->
            <div id="active-ads-tab" class="tab-content active">
                <div class="ads-stats">
                    <div class="stat-item">
                        <span class="stat-label">إعلانات نشطة:</span>
                        <span class="stat-value" id="active-ads-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">إجمالي النقرات:</span>
                        <span class="stat-value" id="total-clicks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">إجمالي الظهورات:</span>
                        <span class="stat-value" id="total-impressions">0</span>
                    </div>
                </div>
                
                <!-- بطاقات الإعلانات النشطة -->
                <div id="active-ads-cards" class="ads-cards-container">
                    <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                </div>
                
                <!-- رسالة عدم وجود إعلانات -->
                <div id="no-ads-message" class="no-ads-message" style="display: none;">
                    <div class="no-ads-icon">📢</div>
                    <h3>لا توجد إعلانات نشطة</h3>
                    <p>ابدأ بإضافة إعلان جديد لجذب المزيد من العملاء</p>
                    <button class="btn-primary" onclick="showAddAdForm()">
                        <span>➕</span>
                        إضافة إعلان جديد
                    </button>
                </div>
            </div>

            <!-- تبويب طلبات الإعلانات -->
            <div id="ad-requests-tab" class="tab-content" style="display: none;">
                <div class="requests-filters">
                    <select id="request-status-filter" onchange="filterAdRequests()">
                        <option value="">جميع الحالات</option>
                        <option value="pending">في الانتظار</option>
                        <option value="approved">مقبول</option>
                        <option value="rejected">مرفوض</option>
                        <option value="cancelled">ملغي</option>
                    </select>
                </div>
                
                <div class="requests-table-container">
                    <table class="ads-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>البائع</th>
                                <th>النوع</th>
                                <th>الموضع</th>
                                <th>المدة (أيام)</th>
                                <th>الميزانية</th>
                                <th>الرسالة</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ad-requests-table">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تبويب الإحصائيات الشاملة -->
            <div id="system-stats-tab" class="tab-content" style="display: none;">
                <div class="stats-overview">
                    <h3 class="stats-title">📊 نظرة عامة على النظام</h3>
                    
                    <!-- الإحصائيات الرئيسية -->
                    <div class="main-stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-icon">📢</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-ads-stat">0</div>
                                <div class="stat-label">إجمالي الإعلانات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">✅</div>
                            <div class="stat-content">
                                <div class="stat-value" id="active-ads-stat">0</div>
                                <div class="stat-label">الإعلانات النشطة</div>
                            </div>
                        </div>
                        
                        <div class="stat-card info">
                            <div class="stat-icon">👁️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-impressions-stat">0</div>
                                <div class="stat-label">إجمالي الظهورات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">🖱️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-clicks-stat">0</div>
                                <div class="stat-label">إجمالي النقرات</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- معدلات الأداء -->
                    <div class="performance-stats">
                        <h4>معدلات الأداء</h4>
                        <div class="performance-grid">
                            <div class="performance-item">
                                <span class="performance-label">معدل النقر الإجمالي:</span>
                                <span class="performance-value" id="overall-ctr-stat">0%</span>
                            </div>
                            <div class="performance-item">
                                <span class="performance-label">متوسط الظهورات لكل إعلان:</span>
                                <span class="performance-value" id="avg-impressions-stat">0</span>
                            </div>
                            <div class="performance-item">
                                <span class="performance-label">متوسط النقرات لكل إعلان:</span>
                                <span class="performance-value" id="avg-clicks-stat">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الإحصائيات التفصيلية -->
                    <div class="detailed-stats">
                        <h4>الإحصائيات التفصيلية</h4>
                        
                        <!-- حسب النوع -->
                        <div class="stats-section">
                            <h5>حسب نوع الإعلان</h5>
                            <div id="type-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                        
                        <!-- حسب الموضع -->
                        <div class="stats-section">
                            <h5>حسب موضع الإعلان</h5>
                            <div id="position-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                        
                        <!-- حسب التصنيف -->
                        <div class="stats-section">
                            <h5>حسب تصنيف المنتج</h5>
                            <div id="category-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- زر تحديث الإحصائيات -->
                    <div class="stats-actions">
                        <button class="btn-primary" onclick="refreshSystemStatistics()">
                            <span>🔄</span>
                            تحديث الإحصائيات
                        </button>
                        <button class="btn-secondary" onclick="exportStatistics()">
                            <span>📥</span>
                            تصدير الإحصائيات
                        </button>
                    </div>
                </div>
            </div>
                <div class="requests-filters">
                    <select id="request-status-filter" onchange="filterAdRequests()">
                        <option value="">جميع الحالات</option>
                        <option value="pending">في الانتظار</option>
                        <option value="approved">مقبول</option>
                        <option value="rejected">مرفوض</option>
                        <option value="cancelled">ملغي</option>
                    </select>
                </div>
                
                <div class="requests-table-container">
                    <table class="ads-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>البائع</th>
                                <th>النوع</th>
                                <th>الموضع</th>
                                <th>المدة (أيام)</th>
                                <th>الميزانية</th>
                                <th>الرسالة</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ad-requests-table">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- نافذة تفاصيل الطلب -->
        <div id="request-details-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الطلب</h3>
                    <button class="modal-close" onclick="closeRequestDetails(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="request-details-content">
                        <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="closeRequestDetails(); return false;">إغلاق</button>
                </div>
            </div>
        </div>

        <!-- نموذج إضافة إعلان جديد -->
        <div id="add-ad-form" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">إضافة إعلان جديد</h3>
                    <button class="modal-close" onclick="hideAddAdForm(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="new-ad-form">
                        <div class="form-group">
                            <label for="ad-category">التصنيف:</label>
                            <select id="ad-category" required onchange="loadProductsForCategory()">
                                <option value="">اختر التصنيف</option>
                                <option value="cake">تورتات</option>
                                <option value="koshat">كوشات</option>
                                <option value="mirr">مرايا</option>
                                <option value="other">ديكورات متنوعة</option>
                                <option value="invitations">دعوات وتوزيعات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-product">المنتج:</label>
                            <select id="ad-product" required disabled>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-type">نوع الإعلان:</label>
                            <select id="ad-type" required onchange="updateAdPositions()">
                                <option value="">اختر النوع</option>
                                <option value="featured">مميز</option>
                                <option value="recommended">موصى به</option>
                                <option value="banner">بانر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-position">الموضع:</label>
                            <select id="ad-position" required>
                                <option value="">اختر الموضع</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ad-start-date">تاريخ البداية:</label>
                                <input type="datetime-local" id="ad-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="ad-end-date">تاريخ الانتهاء:</label>
                                <input type="datetime-local" id="ad-end-date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ad-priority">الأولوية:</label>
                                <input type="number" id="ad-priority" min="1" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="ad-budget">الميزانية:</label>
                                <input type="number" id="ad-budget" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideAddAdForm(); return false;">
                        <span>❌</span>
                        إلغاء
                    </button>
                    <button class="btn-modal-primary" onclick="createNewAdvertisement(); return false;">
                        <span>✨</span>
                        إضافة الإعلان
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج تعديل الإعلان -->
        <div id="edit-ad-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">✏️ تعديل الإعلان</h3>
                    <button class="modal-close" onclick="hideEditAdModal(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-ad-form">
                        <input type="hidden" id="edit-ad-id">
                        <div class="form-group">
                            <label for="edit-ad-category">التصنيف:</label>
                            <select id="edit-ad-category" required onchange="loadProductsForEditCategory()">
                                <option value="">اختر التصنيف</option>
                                <option value="cake">تورتات</option>
                                <option value="koshat">كوشات</option>
                                <option value="mirr">مرايا</option>
                                <option value="other">ديكورات متنوعة</option>
                                <option value="invitations">دعوات وتوزيعات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-product">المنتج:</label>
                            <select id="edit-ad-product" required>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-type">نوع الإعلان:</label>
                            <select id="edit-ad-type" required onchange="updateEditAdPositions()">
                                <option value="">اختر النوع</option>
                                <option value="featured">مميز</option>
                                <option value="recommended">موصى به</option>
                                <option value="banner">بانر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-position">الموضع:</label>
                            <select id="edit-ad-position" required>
                                <option value="">اختر الموضع</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-ad-start-date">تاريخ البداية:</label>
                                <input type="datetime-local" id="edit-ad-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-ad-end-date">تاريخ الانتهاء:</label>
                                <input type="datetime-local" id="edit-ad-end-date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-ad-priority">الأولوية:</label>
                                <input type="number" id="edit-ad-priority" min="1" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="edit-ad-budget">الميزانية:</label>
                                <input type="number" id="edit-ad-budget" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-status">الحالة:</label>
                            <select id="edit-ad-status" required>
                                <option value="active">نشط</option>
                                <option value="paused">متوقف مؤقتاً</option>
                                <option value="expired">منتهي الصلاحية</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideEditAdModal(); return false;">
                        <span>❌</span>
                        إلغاء
                    </button>
                    <button class="btn-modal-danger" onclick="deleteAdvertisement(); return false;">
                        <span>🗑️</span>
                        حذف الإعلان
                    </button>
                    <button class="btn-modal-primary" onclick="updateAdvertisement(); return false;">
                        <span>💾</span>
                        حفظ التعديلات
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج مراجعة طلب إعلان -->
        <div id="review-request-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">مراجعة طلب الإعلان</h3>
                    <button class="modal-close" onclick="hideReviewRequestModal(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="request-details">
                        <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                    </div>
                    <div class="form-group">
                        <label for="admin-notes">ملاحظات المدير:</label>
                        <textarea id="admin-notes" rows="3" placeholder="اكتب ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideReviewRequestModal(); return false;">إلغاء</button>
                    <button class="btn-modal-success" onclick="approveAdRequest(); return false;">قبول</button>
                    <button class="btn-modal-danger" onclick="rejectAdRequest(); return false;">رفض</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // التحقق من تحميل adminSecurity
        let adminSecurityCheckStarted = false;
        
        function checkAdminSecurity() {
            if (adminSecurityCheckStarted) {
                return; // منع التكرار
            }
            
            if (!window.adminSecurity) {
                console.log('⏳ Waiting for adminSecurity to load...');
                adminSecurityCheckStarted = true;
                setTimeout(checkAdminSecurity, 100);
                return;
            }
            console.log('✅ adminSecurity loaded successfully');
        }
        
        // بدء التحقق عند تحميل الصفحة - مرة واحدة فقط
        setTimeout(checkAdminSecurity, 100);
        
        // تحميل البيانات عند تحميل الصفحة
        window.onload = async function() {
            // انتظار تحميل adminSecurity
            while (!window.adminSecurity) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            await loadDashboardData();
            await loadUserInfo();
            await loadRecentActivity();
            
            // استعادة حالة الصفحة المحفوظة
            restorePageState();
        };
        
        // نظام بديل لضمان عمل حفظ الحالة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - إعداد نظام حفظ الحالة');
            
            // تأخير قصير لضمان تحميل جميع العناصر
            setTimeout(() => {
                restorePageState();
            }, 500);
        });
        
        // مراقبة تغييرات الصفحة
        window.addEventListener('beforeunload', function() {
            console.log('حفظ الحالة قبل إغلاق الصفحة');
            // حفظ الحالة الحالية قبل إغلاق الصفحة
            const currentPanel = getCurrentActivePanel();
            if (currentPanel) {
                saveCurrentPageState(currentPanel);
            }
        });
        
        // مراقبة تغييرات الصفحة عند التحديث
        window.addEventListener('load', function() {
            console.log('تم تحميل الصفحة - محاولة استعادة الحالة');
            // محاولة إضافية لاستعادة الحالة
            setTimeout(() => {
                restorePageState();
            }, 1000);
        });
        
        // إضافة أزرار اختبار في Console
        window.testPageState = {
            save: function(page) {
                saveCurrentPageState(page);
                console.log(`تم حفظ حالة الصفحة: ${page}`);
            },
            restore: function() {
                restorePageState();
            },
            clear: function() {
                localStorage.removeItem('adminCurrentPage');
                localStorage.removeItem('adminPageTimestamp');
                console.log('تم مسح الحالة المحفوظة');
            },
            show: function() {
                const savedPage = localStorage.getItem('adminCurrentPage');
                const timestamp = localStorage.getItem('adminPageTimestamp');
                console.log('الحالة الحالية:', { savedPage, timestamp });
            }
        };
        
        console.log('🚀 نظام حفظ حالة الصفحة جاهز!');
        console.log('استخدم window.testPageState.save("advertising") لحفظ حالة');
        console.log('استخدم window.testPageState.restore() لاستعادة الحالة');
        console.log('استخدم window.testPageState.show() لعرض الحالة الحالية');

        // حساب إحصائيات الصور التفصيلية
        async function calculateImageStatistics() {
            try {
                let totalImages = 0;
                let productsWithImages = 0;
                let productsWithoutImages = 0;
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error: productsError } = await window.supabaseClient
                            .from(table)
                            .select('image_urls');
                        
                        if (!productsError && products) {
                            products.forEach(product => {
                                if (product.image_urls && Array.isArray(product.image_urls) && product.image_urls.length > 0) {
                                    totalImages += product.image_urls.length;
                                    productsWithImages++;
                                } else {
                                    productsWithoutImages++;
                                }
                            });
                        } else if (productsError) {
                            console.error(`Error loading images from ${table}:`, productsError);
                        }
                    } catch (tableError) {
                        console.error(`Error accessing table ${table}:`, tableError);
                    }
                }
                
                return {
                    totalImages,
                    productsWithImages,
                    productsWithoutImages,
                    averageImagesPerProduct: productsWithImages > 0 ? (totalImages / productsWithImages).toFixed(1) : 0
                };
            } catch (error) {
                console.error('Error calculating image statistics:', error);
                return {
                    totalImages: 0,
                    productsWithImages: 0,
                    productsWithoutImages: 0,
                    averageImagesPerProduct: 0
                };
            }
        }

        // تحميل بيانات لوحة الإدارة
        async function loadDashboardData() {
            try {
                // التأكد من وجود عميل Supabase
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    return;
                }

                // إحصائيات المستخدمين
                const { data: users, error: usersError } = await window.supabaseClient
                    .from('users')
                    .select('*');

                if (!usersError && users) {
                    document.getElementById('totalUsers').textContent = users.length;
                    document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'نشط').length;
                } else if (usersError) {
                    console.error('Error loading users:', usersError);
                }

                // إحصائيات المنتجات من جميع الجداول
                let totalProducts = 0;
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error: productsError } = await window.supabaseClient
                            .from(table)
                            .select('*');
                        
                        if (!productsError && products) {
                            totalProducts += products.length;
                        } else if (productsError) {
                            console.error(`Error loading ${table}:`, productsError);
                        }
                    } catch (tableError) {
                        console.error(`Error accessing table ${table}:`, tableError);
                    }
                }
                
                document.getElementById('totalProducts').textContent = totalProducts;
                
                // حساب إحصائيات الصور
                const imageStats = await calculateImageStatistics();
                document.getElementById('totalImages').textContent = imageStats.totalImages;
                document.getElementById('avgImagesPerProduct').textContent = imageStats.averageImagesPerProduct;
                
                // إضافة معلومات إضافية في console للمطورين
                console.log('📊 Image Statistics:', {
                    totalImages: imageStats.totalImages,
                    productsWithImages: imageStats.productsWithImages,
                    productsWithoutImages: imageStats.productsWithoutImages,
                    averageImagesPerProduct: imageStats.averageImagesPerProduct
                });

                // إحصائيات السجلات
                const { data: logs, error: logsError } = await window.supabaseClient
                    .from('admin_logs')
                    .select('*')
                    .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

                if (!logsError && logs) {
                    document.getElementById('recentLogs').textContent = logs.length;
                } else if (logsError) {
                    console.error('Error loading logs:', logsError);
                }

                // إحصائيات طلبات المنتجات
                try {
                    if (window.ProductRequestsService) {
                        const service = new window.ProductRequestsService();
                        await service.ensureInitialized();
                        const statsResult = await service.getRequestStatistics();
                        
                        if (statsResult.success) {
                            document.getElementById('pendingRequests').textContent = statsResult.data.pending;
                        }
                    }
                } catch (error) {
                    console.error('Error loading request statistics:', error);
                    document.getElementById('pendingRequests').textContent = '0';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // تحميل معلومات المستخدم
        async function loadUserInfo() {
            try {
                // انتظار تحميل adminSecurity
                while (!window.adminSecurity) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const currentUser = await adminSecurity.getCurrentUser();
                if (currentUser) {
                    const userInfoDiv = document.getElementById('userInfo');
                    userInfoDiv.innerHTML = `
                        <div class="user-name">${currentUser.fullName}</div>
                        <div class="user-role">${currentUser.role === 'admin' ? 'مدير' : 'محرر'}</div>
                    `;
                } else {
                    console.log('No current user found');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // تحميل النشاط الأخير
        async function loadRecentActivity() {
            try {
                // التأكد من وجود عميل Supabase
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    return;
                }

                const { data: logs, error } = await window.supabaseClient
                    .from('admin_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    throw error;
                }

                const activityList = document.getElementById('activityList');
                activityList.innerHTML = '';

                if (logs && logs.length > 0) {
                    logs.forEach(log => {
                        const activityItem = createActivityItem(log);
                        activityList.appendChild(activityItem);
                    });
                } else {
                    activityList.innerHTML = '<li class="activity-item">لا توجد أنشطة حديثة</li>';
                }

            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // إنشاء عنصر النشاط
        function createActivityItem(log) {
            const li = document.createElement('li');
            li.className = 'activity-item';

            const icons = {
                'admin_login': '🔐',
                'failed_login': '❌',
                'user_added': '➕',
                'user_deleted': '🗑️',
                'session_timeout': '⏰',
                'default': '📝'
            };

            const icon = icons[log.action] || icons.default;
            const actionText = getActionText(log.action);

            li.innerHTML = `
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-title">${actionText}</div>
                    <div class="activity-time">${new Date(log.created_at).toLocaleString('ar-EG')}</div>
                </div>
            `;

            return li;
        }

        // ترجمة نوع النشاط
        function getActionText(action) {
            const actions = {
                'admin_login': 'تسجيل دخول مدير',
                'failed_login': 'محاولة تسجيل دخول فاشلة',
                'user_added': 'إضافة مستخدم جديد',
                'user_deleted': 'حذف مستخدم',
                'session_timeout': 'انتهاء مهلة الجلسة',
                'default': 'نشاط في النظام'
            };

            return actions[action] || actions.default;
        }

        // عرض التقارير
        function showReports() {
            navigateToRoute('reports');
            
            // إضافة زر العودة
            if (!document.getElementById('back-to-dashboard')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-dashboard';
                backBtn.className = 'nav-btn';
                backBtn.innerHTML = '🔙 العودة للوحة الرئيسية';
                backBtn.onclick = backToDashboard;
                document.querySelector('.header-content').appendChild(backBtn);
            }
        }

        // عرض طلبات المنتجات
        function showProductRequests() {
            // إخفاء جميع الأقسام الأخرى
            document.querySelector('.welcome-section').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.quick-actions').style.display = 'none';
            document.querySelector('.recent-activity').style.display = 'none';
            document.getElementById('advertising-panel').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            // إظهار قسم طلبات المنتجات
            document.getElementById('product-requests-section').style.display = 'block';
            
            // إضافة زر العودة
            if (!document.getElementById('back-to-dashboard')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-dashboard';
                backBtn.className = 'nav-btn';
                backBtn.innerHTML = '🔙 العودة للوحة الرئيسية';
                backBtn.onclick = backToDashboard;
                document.querySelector('.header-content').appendChild(backBtn);
            }
            
            // تحميل طلبات المنتجات
            loadProductRequests();
        }

        // العودة للوحة الرئيسية
        function backToDashboard() {
            // إزالة زر العودة
            const backBtn = document.getElementById('back-to-dashboard');
            if (backBtn) backBtn.remove();
            
            // العودة للصفحة الرئيسية
            showDashboardHome();
        }

        // تحميل التقارير
        async function loadReports() {
            // إضافة مستمعي الأحداث لأزرار التقارير
            const reportButtons = document.querySelectorAll('[data-report]');
            reportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // إزالة الفئة النشطة من جميع الأزرار
                    reportButtons.forEach(btn => btn.classList.remove('active'));
                    // إضافة الفئة النشطة للزر المحدد
                    this.classList.add('active');
                    
                    // تحميل التقرير المحدد
                    const reportType = this.getAttribute('data-report');
                    loadSpecificReport(reportType);
                });
            });
            
            // تحميل التقرير الافتراضي (المنتجات)
            loadSpecificReport('products');
        }

        // تحميل تقرير محدد
        async function loadSpecificReport(reportType) {
            const reportsContent = document.getElementById('reports-content');
            reportsContent.innerHTML = '<div class="text-center py-8">جاري تحميل التقرير...</div>';
            
            try {
                switch (reportType) {
                    case 'products':
                        await loadProductsReport();
                        break;
                    case 'users':
                        await loadUsersReport();
                        break;
                    case 'images':
                        await loadImagesReport();
                        break;
                    case 'performance':
                        await loadPerformanceReport();
                        break;
                    default:
                        reportsContent.innerHTML = '<div class="text-center py-8 text-gray-500">نوع التقرير غير معروف</div>';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                reportsContent.innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل التقرير</div>';
            }
        }

        // تقرير المنتجات
        async function loadProductsReport() {
            try {
                const reportsContent = document.getElementById('reports-content');
                let totalProducts = 0;
                let productsByCategory = {};
                let productsWithoutImages = 0;
                let recentProducts = [];
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error } = await window.supabaseClient
                            .from(table)
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (!error && products) {
                            const categoryName = getCategoryDisplayName(table);
                            productsByCategory[categoryName] = products.length;
                            totalProducts += products.length;
                            
                            // حساب المنتجات بدون صور
                            products.forEach(product => {
                                if (!product.image_urls || !Array.isArray(product.image_urls) || product.image_urls.length === 0) {
                                    productsWithoutImages++;
                                }
                            });
                            
                            // المنتجات المحدثة مؤخراً
                            recentProducts.push(...products.slice(0, 3));
                        }
                    } catch (error) {
                        console.error(`Error loading ${table}:`, error);
                    }
                }
                
                // ترتيب المنتجات حسب التاريخ
                recentProducts.sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
                recentProducts = recentProducts.slice(0, 5);
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📊 إحصائيات عامة</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي المنتجات:</span>
                                    <span class="font-bold text-blue-600">${totalProducts}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات بدون صور:</span>
                                    <span class="font-bold text-orange-600">${productsWithoutImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نسبة المنتجات مع صور:</span>
                                    <span class="font-bold text-green-600">${totalProducts > 0 ? ((totalProducts - productsWithoutImages) / totalProducts * 100).toFixed(1) : 0}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📂 المنتجات حسب التصنيف</h3>
                            <div class="space-y-3">
                                ${Object.entries(productsByCategory).map(([category, count]) => `
                                    <div class="flex justify-between">
                                        <span>${category}:</span>
                                        <span class="font-bold text-purple-600">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🕒 آخر التحديثات</h3>
                            <div class="space-y-2">
                                ${recentProducts.map(product => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-medium">${product.name || product.description || 'منتج'}</div>
                                        <div class="text-gray-600">${new Date(product.updated_at || product.created_at).toLocaleDateString('ar-EG')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                reportsContent.innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading products report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير المنتجات</div>';
            }
        }

        // تقرير المستخدمين
        async function loadUsersReport() {
            try {
                const { data: users, error } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const totalUsers = users.length;
                const activeUsers = users.filter(u => u.status === 'نشط').length;
                const newUsers = users.filter(u => {
                    const userDate = new Date(u.created_at);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return userDate > weekAgo;
                }).length;
                
                const recentUsers = users.slice(0, 5);
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">👥 إحصائيات المستخدمين</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي المستخدمين:</span>
                                    <span class="font-bold text-blue-600">${totalUsers}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المستخدمين النشطين:</span>
                                    <span class="font-bold text-green-600">${activeUsers}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المستخدمين الجدد (أسبوع):</span>
                                    <span class="font-bold text-purple-600">${newUsers}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📈 معدل النمو</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>نسبة المستخدمين النشطين:</span>
                                    <span class="font-bold text-green-600">${totalUsers > 0 ? (activeUsers / totalUsers * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>معدل التسجيل الأسبوعي:</span>
                                    <span class="font-bold text-blue-600">${newUsers}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🆕 آخر المستخدمين</h3>
                            <div class="space-y-2">
                                ${recentUsers.map(user => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-medium">${user.full_name || user.email}</div>
                                        <div class="text-gray-600">${new Date(user.created_at).toLocaleDateString('ar-EG')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading users report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير المستخدمين</div>';
            }
        }

        // تقرير الصور
        async function loadImagesReport() {
            try {
                const imageStats = await calculateImageStatistics();
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                let imagesByCategory = {};
                
                // حساب الصور حسب التصنيف
                for (const table of tables) {
                    try {
                        const { data: products, error } = await window.supabaseClient
                            .from(table)
                            .select('image_urls');
                        
                        if (!error && products) {
                            const categoryName = getCategoryDisplayName(table);
                            let categoryImages = 0;
                            
                            products.forEach(product => {
                                if (product.image_urls && Array.isArray(product.image_urls)) {
                                    categoryImages += product.image_urls.length;
                                }
                            });
                            
                            imagesByCategory[categoryName] = categoryImages;
                        }
                    } catch (error) {
                        console.error(`Error loading images from ${table}:`, error);
                    }
                }
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🖼️ إحصائيات الصور</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي الصور:</span>
                                    <span class="font-bold text-blue-600">${imageStats.totalImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات مع صور:</span>
                                    <span class="font-bold text-green-600">${imageStats.productsWithImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات بدون صور:</span>
                                    <span class="font-bold text-orange-600">${imageStats.productsWithoutImages}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📸 الصور حسب التصنيف</h3>
                            <div class="space-y-3">
                                ${Object.entries(imagesByCategory).map(([category, count]) => `
                                    <div class="flex justify-between">
                                        <span>${category}:</span>
                                        <span class="font-bold text-purple-600">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📊 متوسط الصور</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>متوسط الصور/منتج:</span>
                                    <span class="font-bold text-green-600">${imageStats.averageImagesPerProduct}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نسبة المنتجات مع صور:</span>
                                    <span class="font-bold text-blue-600">${(imageStats.productsWithImages + imageStats.productsWithoutImages) > 0 ? (imageStats.productsWithImages / (imageStats.productsWithImages + imageStats.productsWithoutImages) * 100).toFixed(1) : 0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading images report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير الصور</div>';
            }
        }

        // تقرير الأداء
        async function loadPerformanceReport() {
            try {
                const pageLoadTime = performance.now();
                const memoryUsage = performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                } : null;
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">⚡ أداء الصفحة</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>وقت التحميل:</span>
                                    <span class="font-bold text-blue-600">${pageLoadTime.toFixed(2)}ms</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>تاريخ التقرير:</span>
                                    <span class="font-bold text-green-600">${new Date().toLocaleDateString('ar-EG')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">💾 استخدام الذاكرة</h3>
                            <div class="space-y-3">
                                ${memoryUsage ? `
                                    <div class="flex justify-between">
                                        <span>الذاكرة المستخدمة:</span>
                                        <span class="font-bold text-blue-600">${memoryUsage.used} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>إجمالي الذاكرة:</span>
                                        <span class="font-bold text-green-600">${memoryUsage.total} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>حد الذاكرة:</span>
                                        <span class="font-bold text-purple-600">${memoryUsage.limit} MB</span>
                                    </div>
                                ` : '<div class="text-gray-500">معلومات الذاكرة غير متوفرة</div>'}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🔧 معلومات النظام</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>المتصفح:</span>
                                    <span class="font-bold text-blue-600">${navigator.userAgent.split(' ').pop()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نظام التشغيل:</span>
                                    <span class="font-bold text-green-600">${navigator.platform}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>اللغة:</span>
                                    <span class="font-bold text-purple-600">${navigator.language}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading performance report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير الأداء</div>';
            }
        }

        // دالة مساعدة للحصول على اسم التصنيف المعروض
        function getCategoryDisplayName(tableName) {
            const categoryMap = {
                'products_cake': 'تورتات',
                'products_koshat': 'كوشات',
                'products_mirr': 'مرايا',
                'products_other': 'ديكورات متنوعة'
            };
            return categoryMap[tableName] || tableName;
        }

        // تحميل طلبات المنتجات
        async function loadProductRequests(status = 'all') {
            try {
                // التأكد من وجود ProductRequestsService
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                let result;
                if (status === 'all') {
                    result = await service.getAllProductRequests();
                } else {
                    result = await service.getProductRequestsByStatus(status);
                }

                if (result.success) {
                    displayProductRequests(result.data, status);
                } else {
                    console.error('Error loading product requests:', result.error);
                }
            } catch (error) {
                console.error('Error in loadProductRequests:', error);
            }
        }

        // عرض طلبات المنتجات
        function displayProductRequests(requests, status) {
            const requestsList = document.getElementById('requests-list');
            const noRequestsMessage = document.getElementById('no-requests-message');

            if (!requests || requests.length === 0) {
                requestsList.style.display = 'none';
                noRequestsMessage.style.display = 'block';
                return;
            }

            requestsList.style.display = 'block';
            noRequestsMessage.style.display = 'none';

            // تخزين البيانات للوصول إليها لاحقاً
            window.currentRequests = requests;

            requestsList.innerHTML = requests.map(request => createRequestCard(request)).join('');

            // إضافة مستمعي الأحداث للأزرار
            addRequestEventListeners();
        }

        // إنشاء بطاقة طلب
        function createRequestCard(request) {
            const statusClass = `status-${request.status}`;
            const statusText = getStatusText(request.status);
            const createdAt = new Date(request.created_at).toLocaleString('ar-EG');

            return `
                <div class="request-card" data-request-id="${request.id}">
                    <div class="request-header">
                        <h3 class="font-semibold text-lg">طلب إضافة منتج</h3>
                        <span class="request-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>التصنيف:</strong> ${getCategoryName(request.category)}</p>
                            <p><strong>الوصف:</strong> ${request.description}</p>
                            <p><strong>السعر:</strong> ${request.price > 0 ? request.price + ' ج.م' : 'السعر عند الطلب'}</p>
                            <p><strong>المحافظات:</strong> ${request.governorate || 'غير محدد'}</p>
                            <p><strong>تاريخ الطلب:</strong> ${createdAt}</p>
                        </div>
                        
                        <div>
                            <p><strong>الواتساب:</strong> ${request.whatsapp}</p>
                            <p><strong>فيسبوك:</strong> ${request.facebook || 'غير محدد'}</p>
                            <p><strong>إنستجرام:</strong> ${request.instagram || 'غير محدد'}</p>
                        </div>
                    </div>
                    
                    ${request.image_urls && request.image_urls.length > 0 ? `
                        <div class="request-images">
                            ${request.image_urls.map(img => `
                                <img src="${img.url || img}" alt="صورة المنتج" class="request-image">
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="request-actions">
                        <button class="btn-view" onclick="viewRequestDetails('${request.id}')">عرض التفاصيل</button>
                        ${request.status === 'pending' ? `
                            <button class="btn-approve" onclick="approveRequest('${request.id}')">موافقة</button>
                            <button class="btn-reject" onclick="rejectRequest('${request.id}')">رفض</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // إضافة مستمعي الأحداث
        function addRequestEventListeners() {
            // مستمعي أحداث أزرار الفلتر
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // إزالة الفئة النشطة من جميع الأزرار
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    // إضافة الفئة النشطة للزر المحدد
                    this.classList.add('active');
                    
                    // تحميل الطلبات حسب الحالة
                    const status = this.getAttribute('data-status');
                    loadProductRequests(status);
                });
            });
        }

        // عرض تفاصيل الطلب
        function viewRequestDetails(requestId) {
            try {
                console.log('Viewing details for request:', requestId);
                
                // البحث عن الطلب في القائمة المعروضة
                const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
                if (!requestCard) {
                    console.warn('Request card not found in DOM');
                }

                // الحصول على بيانات الطلب من البيانات المخزنة
                const requestData = getRequestDataById(requestId);
                if (!requestData) {
                    alert('لم يتم العثور على بيانات الطلب. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                    return;
                }

                console.log('Request data retrieved:', requestData);

                // عرض النافذة المنبثقة
                showRequestDetailsModal(requestData);
            } catch (error) {
                console.error('Error in viewRequestDetails:', error);
                alert('حدث خطأ أثناء عرض تفاصيل الطلب. يرجى المحاولة مرة أخرى.');
            }
        }

        // الحصول على بيانات الطلب بواسطة ID
        function getRequestDataById(requestId) {
            // البحث في الطلبات المعروضة حالياً
            const requestsList = document.getElementById('requests-list');
            const requestCard = requestsList.querySelector(`[data-request-id="${requestId}"]`);
            
            if (requestCard) {
                // استخراج البيانات من البطاقة المعروضة
                return extractRequestDataFromCard(requestCard);
            }
            
            // إذا لم نجد البطاقة، نحاول البحث في البيانات المخزنة
            if (window.currentRequests && window.currentRequests.length > 0) {
                const storedRequest = window.currentRequests.find(req => req.id == requestId);
                if (storedRequest) {
                    return formatRequestData(storedRequest);
                }
            }
            
            return null;
        }

        // تنسيق بيانات الطلب
        function formatRequestData(request) {
            try {
                const createdAt = new Date(request.created_at).toLocaleString('ar-EG');
                const statusText = getStatusText(request.status);
                const categoryName = getCategoryName(request.category);
                const priceText = request.price > 0 ? request.price + ' ج.م' : 'السعر عند الطلب';
                
                return {
                    id: request.id,
                    description: request.description || 'غير محدد',
                    category: categoryName,
                    price: priceText,
                    governorate: request.governorate || 'غير محدد',
                    whatsapp: request.whatsapp || 'غير محدد',
                    facebook: request.facebook || 'غير محدد',
                    instagram: request.instagram || 'غير محدد',
                    status: statusText,
                    created_at: createdAt,
                    image_urls: request.image_urls || []
                };
            } catch (error) {
                console.error('Error formatting request data:', error);
                return null;
            }
        }

        // استخراج بيانات الطلب من البطاقة المعروضة
        function extractRequestDataFromCard(requestCard) {
            try {
                // البحث عن جميع الفقرات في البطاقة
                const paragraphs = requestCard.querySelectorAll('p');
                const requestData = {
                    id: requestCard.getAttribute('data-request-id'),
                    description: 'غير محدد',
                    category: 'غير محدد',
                    price: 'غير محدد',
                    governorate: 'غير محدد',
                    whatsapp: 'غير محدد',
                    facebook: 'غير محدد',
                    instagram: 'غير محدد',
                    status: 'غير محدد',
                    created_at: 'غير محدد',
                    image_urls: []
                };

                // البحث في الفقرات عن البيانات
                paragraphs.forEach(p => {
                    const text = p.textContent || '';
                    const strong = p.querySelector('strong');
                    
                    if (strong) {
                        const label = strong.textContent.trim();
                        const value = p.textContent.replace(label, '').trim();
                        
                        if (label.includes('الوصف')) {
                            requestData.description = value;
                        } else if (label.includes('التصنيف')) {
                            requestData.category = value;
                        } else if (label.includes('السعر')) {
                            requestData.price = value;
                        } else if (label.includes('المحافظات')) {
                            requestData.governorate = value;
                        } else if (label.includes('الواتساب')) {
                            requestData.whatsapp = value;
                        } else if (label.includes('فيسبوك')) {
                            requestData.facebook = value;
                        } else if (label.includes('إنستجرام')) {
                            requestData.instagram = value;
                        } else if (label.includes('تاريخ الطلب')) {
                            requestData.created_at = value;
                        }
                    }
                });

                // البحث عن الحالة
                const statusElement = requestCard.querySelector('.request-status');
                if (statusElement) {
                    requestData.status = statusElement.textContent.trim();
                }

                // استخراج الصور
                const images = requestCard.querySelectorAll('.request-image');
                images.forEach(img => {
                    requestData.image_urls.push({
                        url: img.src,
                        original_name: img.alt
                    });
                });

                console.log('Extracted request data:', requestData);
                return requestData;
            } catch (error) {
                console.error('Error extracting request data:', error);
                return null;
            }
        }

        // عرض النافذة المنبثقة لتفاصيل الطلب
        function showRequestDetailsModal(requestData) {
            const modal = document.getElementById('request-details-modal');
            const content = document.getElementById('request-details-content');

            // إنشاء محتوى التفاصيل
            content.innerHTML = createRequestDetailsHTML(requestData);

            // عرض النافذة
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // إنشاء HTML لتفاصيل الطلب
        function createRequestDetailsHTML(requestData) {
            const statusClass = `status-${requestData.status === 'في الانتظار' ? 'pending' : requestData.status === 'تمت الموافقة' ? 'approved' : 'rejected'}`;
            
            return `
                <div class="request-detail-item">
                    <span class="request-detail-label">رقم الطلب:</span>
                    <span class="request-detail-value">#${requestData.id}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">الحالة:</span>
                    <span class="request-detail-value">
                        <span class="request-status ${statusClass}">${requestData.status}</span>
                    </span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">التصنيف:</span>
                    <span class="request-detail-value">${requestData.category}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">الوصف:</span>
                    <span class="request-detail-value">${requestData.description}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">السعر:</span>
                    <span class="request-detail-value">${requestData.price}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">المحافظات:</span>
                    <span class="request-detail-value">${requestData.governorate}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رقم الواتساب:</span>
                    <span class="request-detail-value">${requestData.whatsapp}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رابط الفيسبوك:</span>
                    <span class="request-detail-value">${requestData.facebook}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رابط الإنستجرام:</span>
                    <span class="request-detail-value">${requestData.instagram}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">تاريخ الطلب:</span>
                    <span class="request-detail-value">${requestData.created_at}</span>
                </div>
                
                ${requestData.image_urls && requestData.image_urls.length > 0 ? `
                    <div class="request-detail-item">
                        <span class="request-detail-label">الصور المرفقة:</span>
                        <div class="request-images-grid">
                            ${requestData.image_urls.map((img, index) => {
                                const imageUrl = typeof img === 'string' ? img : (img.url || img);
                                return `
                                    <div class="request-image-item">
                                        <img src="${imageUrl}" alt="صورة ${index + 1}" loading="lazy" onerror="this.style.display='none'">
                                        <div class="request-image-overlay">
                                            <button onclick="openImageInNewTab('${imageUrl}')">عرض</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // فتح الصورة في تبويب جديد
        function openImageInNewTab(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        // إغلاق نافذة تفاصيل الطلب
        function closeRequestDetails() {
            const modal = document.getElementById('request-details-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // إغلاق النافذة عند النقر خارجها
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('request-details-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRequestDetails();
                    }
                });
            }
        });

        // إغلاق النافذة عند الضغط على ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('request-details-modal');
                if (modal && modal.style.display !== 'none') {
                    closeRequestDetails();
                }
                
                const editModal = document.getElementById('edit-ad-modal');
                if (editModal && editModal.style.display !== 'none') {
                    hideEditAdModal();
                }
            }
        });

        // إغلاق نوافذ الإعلانات عند النقر خارجها
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('edit-ad-modal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === editModal) {
                        hideEditAdModal();
                    }
                });
            }
        });

        // الموافقة على الطلب
        async function approveRequest(requestId) {
            if (!confirm('هل أنت متأكد من قبول المنتج؟')) {
                return;
            }

            try {
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                const result = await service.approveProductRequest(requestId);
                if (result.success) {
                    alert('تم قبول المنتج بنجاح');
                    // إعادة تحميل الطلبات
                    loadProductRequests();
                    // تحديث الإحصائيات
                    loadDashboardData();
                } else {
                    alert('خطأ في قبول المنتج: ' + result.error);
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert('حدث خطأ أثناء قبول المنتج');
            }
        }

        // رفض الطلب
        async function rejectRequest(requestId) {
            if (!confirm('هل أنت متأكد من حذف المنتج؟')) {
                return;
            }
            
            try {
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                const result = await service.rejectProductRequest(requestId);
                if (result.success) {
                    alert('تم حذف المنتج بنجاح');
                    // إعادة تحميل الطلبات
                    loadProductRequests();
                    // تحديث الإحصائيات
                    loadDashboardData();
                } else {
                    alert('خطأ في حذف المنتج: ' + result.error);
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('حدث خطأ أثناء حذف المنتج');
            }
        }

        // الحصول على نص الحالة
        function getStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'approved': 'تمت الموافقة',
                'rejected': 'مرفوض'
            };
            return statusMap[status] || status;
        }

        // الحصول على اسم التصنيف
        function getCategoryName(category) {
            const categoryMap = {
                'koshat': 'كوشات',
                'mirr': 'مرايا',
                'cake': 'تورتة',
                'other': 'ديكورات متنوعة'
            };
            return categoryMap[category] || category;
        }

        // معالجة تسجيل الخروج
        async function handleLogout() {
            try {
                // انتظار تحميل adminSecurity
                while (!window.adminSecurity) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('🔄 بدء عملية تسجيل الخروج...');
                await adminSecurity.logout();
            } catch (error) {
                console.error('❌ خطأ في تسجيل الخروج:', error);
                // التوجيه المباشر في حالة الخطأ
                window.location.href = 'admin-login.html';
            }
        }

        // تحميل البيانات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            // انتظار تحميل Supabase
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            console.log('Loading dashboard data...');
            await loadUserInfo();
            await loadDashboardData();
            await loadRecentActivity();
        });

        // تحديث البيانات كل 5 دقائق
        setInterval(async function() {
            console.log('Refreshing dashboard data...');
            await loadDashboardData();
            await loadRecentActivity();
        }, 5 * 60 * 1000);

        // ===== نظام المسارات الجديد =====
        
        // تعريف المسارات المتاحة
        const ADMIN_ROUTES = {
            'dashboard': {
                title: 'لوحة التحكم الرئيسية',
                handler: showDashboardHome
            },
            'advertising': {
                title: 'إدارة الإعلانات',
                handler: showAdvertisingPanel
            },
            'product-requests': {
                title: 'طلبات المنتجات',
                handler: showProductRequests
            },
            'reports': {
                title: 'التقارير',
                handler: showReports
            }
        };
        
        // تحديث URL بدون إعادة تحميل الصفحة
        function updateURL(route) {
            try {
                const newURL = `/admin/${route === 'dashboard' ? '' : route}`;
                window.history.pushState({ route }, ADMIN_ROUTES[route]?.title || 'لوحة التحكم', newURL);
                console.log(`تم تحديث URL إلى: ${newURL}`);
            } catch (error) {
                console.error('خطأ في تحديث URL:', error);
            }
        }
        
        // حفظ المسار الحالي في localStorage
        function saveCurrentRoute(route) {
            try {
                localStorage.setItem('adminCurrentRoute', route);
                localStorage.setItem('adminRouteTimestamp', Date.now().toString());
                console.log(`تم حفظ المسار: ${route}`);
            } catch (error) {
                console.error('خطأ في حفظ المسار:', error);
            }
        }
        
        // استعادة المسار المحفوظ
        function restoreRoute() {
            try {
                // أولاً: محاولة قراءة من URL
                const path = window.location.pathname;
                let route = 'dashboard';
                
                if (path.includes('/admin/')) {
                    const routePart = path.split('/admin/')[1];
                    if (routePart && ADMIN_ROUTES[routePart]) {
                        route = routePart;
                    }
                }
                
                // إذا كان URL لا يحتوي على مسار محدد، استخدم localStorage
                if (route === 'dashboard') {
                    const savedRoute = localStorage.getItem('adminCurrentRoute');
                    const timestamp = localStorage.getItem('adminRouteTimestamp');
                    
                    if (savedRoute && timestamp) {
                        const timeDiff = Date.now() - parseInt(timestamp);
                        if (timeDiff < 3600000 && ADMIN_ROUTES[savedRoute]) { // أقل من ساعة
                            route = savedRoute;
                            console.log(`استعادة المسار المحفوظ: ${route}`);
                        }
                    }
                }
                
                console.log(`المسار النهائي: ${route}`);
                
                // عرض الصفحة المناسبة
                if (ADMIN_ROUTES[route] && ADMIN_ROUTES[route].handler) {
                    ADMIN_ROUTES[route].handler();
                    updateURL(route);
                } else {
                    console.log('المسار غير معروف، عرض الصفحة الرئيسية');
                    showDashboardHome();
                    updateURL('dashboard');
                }
                
            } catch (error) {
                console.error('خطأ في استعادة المسار:', error);
                showDashboardHome();
                updateURL('dashboard');
            }
        }
        
        // معالج تغيير المسار
        function navigateToRoute(route) {
            if (!ADMIN_ROUTES[route]) {
                console.error(`المسار غير موجود: ${route}`);
                return;
            }
            
            console.log(`الانتقال إلى: ${route}`);
            
            // عرض الصفحة
            ADMIN_ROUTES[route].handler();
            
            // تحديث URL
            updateURL(route);
            
            // حفظ المسار
            saveCurrentRoute(route);
        }
        
        // إظهار الصفحة الرئيسية للوحة التحكم
        function showDashboardHome() {
            // إظهار جميع الأقسام الأصلية
            document.querySelector('.welcome-section').style.display = 'block';
            document.querySelector('.stats-grid').style.display = 'grid';
            document.querySelector('.quick-actions').style.display = 'block';
            document.querySelector('.recent-activity').style.display = 'block';
            
            // إخفاء الأقسام الأخرى
            document.getElementById('advertising-panel').style.display = 'none';
            document.getElementById('product-requests-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            console.log('تم عرض الصفحة الرئيسية');
        }
        
        // ===== وظائف الإعلانات =====

        // إظهار لوحة الإعلانات
        function showAdvertisingPanel() {
            // إخفاء جميع الأقسام الأخرى
            document.querySelector('.welcome-section').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.quick-actions').style.display = 'none';
            document.querySelector('.recent-activity').style.display = 'none';
            document.getElementById('product-requests-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            // إظهار لوحة الإعلانات
            document.getElementById('advertising-panel').style.display = 'block';
            
            // تحميل بيانات الإعلانات
            loadAdvertisingData();
        }

        // إخفاء لوحة الإعلانات
        function hideAdvertisingPanel() {
            showDashboardHome();
        }

        // تبديل التبويبات
        function switchAdvertisingTab(tabName) {
            // إخفاء جميع التبويبات
            document.getElementById('active-ads-tab').style.display = 'none';
            document.getElementById('ad-requests-tab').style.display = 'none';
            document.getElementById('system-stats-tab').style.display = 'none';
            
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.advertising-tabs .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التبويب المطلوب
            if (tabName === 'active-ads') {
                document.getElementById('active-ads-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:first-child').classList.add('active');
                loadActiveAdvertisements();
            } else if (tabName === 'ad-requests') {
                document.getElementById('ad-requests-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:nth-child(2)').classList.add('active');
                loadAdRequests();
            } else if (tabName === 'system-stats') {
                document.getElementById('system-stats-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:nth-child(4)').classList.add('active');
                loadSystemStatistics();
            }
        }
        
        // إظهار تبويب الإحصائيات الشاملة
        function showSystemStatistics() {
            switchAdvertisingTab('system-stats');
        }

        // تحميل بيانات الإعلانات
        async function loadAdvertisingData() {
            try {
                await loadActiveAdvertisements();
                await loadAdRequests();
                await loadAdStatistics();
            } catch (error) {
                console.error('خطأ في تحميل بيانات الإعلانات:', error);
            }
        }

        // تحميل الإعلانات النشطة
        async function loadActiveAdvertisements() {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                console.log('🔍 جلب الإعلانات مع تفاصيل المنتجات...');
                
                // استخدام الدالة الجديدة لجلب الإعلانات مع المنتجات
                const advertisements = await window.advertisingService.getAllAdvertisementsWithProducts();
                
                console.log('✅ تم جلب الإعلانات:', advertisements);
                
                displayActiveAdvertisements(advertisements);
            } catch (error) {
                console.error('خطأ في تحميل الإعلانات النشطة:', error);
            }
        }

        // عرض الإعلانات النشطة كبطاقات
        function displayActiveAdvertisements(advertisements) {
            const cardsContainer = document.getElementById('active-ads-cards');
            const noAdsMessage = document.getElementById('no-ads-message');
            
            if (!cardsContainer) return;

            if (!advertisements || advertisements.length === 0) {
                cardsContainer.style.display = 'none';
                if (noAdsMessage) noAdsMessage.style.display = 'block';
                return;
            }

            cardsContainer.style.display = 'grid';
            if (noAdsMessage) noAdsMessage.style.display = 'none';

            const cards = advertisements.map(ad => createAdCard(ad)).join('');
            cardsContainer.innerHTML = cards;
        }

        // إنشاء بطاقة إعلان أنيقة
        function createAdCard(ad) {
            const statusClass = getAdStatusClass(ad);
            const statusText = getAdStatusText(ad);
            const typeText = getAdTypeText(ad);
            const positionText = getAdPositionText(ad);
            
            // تحديد الصورة الرئيسية
            let mainImage = '';
            if (ad.product && ad.has_product && ad.product.image_url) {
                mainImage = ad.product.image_url;
            } else if (ad.image_url) {
                mainImage = ad.image_url;
            } else {
                mainImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo=';
            }
            
            // معلومات مختصرة للمنتج
            let productName = 'إعلان بدون منتج';
            let productPrice = '';
            let productCategory = '';
            
            if (ad.product && ad.has_product) {
                productName = ad.product.name || ad.product.description || 'منتج مرتبط';
                productPrice = ad.product.price ? `💰 ${ad.product.price} ج.م` : '';
                productCategory = ad.product_category ? `🏷️ ${ad.product_category}` : '';
            }
            
            return `
                <div class="ad-card-elegant" data-ad-id="${ad.id}" onclick="openAdDetails('${ad.id}')">
                    <div class="ad-card-image-container">
                        <img src="${mainImage}" alt="صورة الإعلان" class="ad-card-main-image" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo='">
                        <div class="ad-card-overlay">
                            <div class="ad-card-badges">
                                <span class="ad-type-badge-elegant">${typeText}</span>
                                <span class="ad-status-badge-elegant ${statusClass}">${statusText}</span>
                            </div>
                            <div class="ad-card-hover-info">
                                <span class="hover-text">اضغط لعرض التفاصيل</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ad-card-content">
                        <div class="ad-card-header-elegant">
                            <h3 class="ad-card-title-elegant">${ad.title || 'إعلان بدون عنوان'}</h3>
                            <p class="ad-card-subtitle-elegant">${positionText}</p>
                        </div>
                        
                        <div class="ad-card-product-info">
                            <h4 class="product-name-elegant">${productName}</h4>
                            ${productPrice ? `<p class="product-price-elegant">${productPrice}</p>` : ''}
                            ${productCategory ? `<p class="product-category-elegant">${productCategory}</p>` : ''}
                        </div>
                        
                        <div class="ad-card-meta">
                            <div class="meta-item">
                                <span class="meta-icon">🚀</span>
                                <span class="meta-text">يبدأ: ${formatDate(ad.start_date)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">⏰</span>
                                <span class="meta-text">ينتهي: ${ad.end_date ? formatDate(ad.end_date) : 'غير محدد'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">⭐</span>
                                <span class="meta-text">الأولوية: ${ad.priority || 1}</span>
                            </div>
                        </div>
                        
                        <div class="ad-card-actions-elegant">
                            <button class="ad-action-btn-elegant edit" onclick="event.stopPropagation(); editAdvertisement('${ad.id}')">
                                <span>✏️</span>
                                تعديل
                            </button>
                            <button class="ad-action-btn-elegant delete" onclick="event.stopPropagation(); deleteAdvertisement('${ad.id}')">
                                <span>🗑️</span>
                                حذف
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // دوال مساعدة للإعلانات
        function getAdStatusClass(ad) {
            if (ad.is_active === true) return 'active';
            if (ad.is_active === false) return 'paused';
            return 'active';
        }

        function getAdStatusText(ad) {
            if (ad.is_active === true) return 'نشط';
            if (ad.is_active === false) return 'متوقف مؤقتاً';
            return 'نشط';
        }

        function getAdTypeText(type) {
            const types = {
                'featured': 'مميز',
                'recommended': 'موصى به',
                'banner': 'بانر'
            };
            return types[type] || 'غير محدد';
        }

        function getAdPositionText(position) {
            const positions = {
                'homepage_featured': 'الصفحة الرئيسية - مميز',
                'homepage_recommended': 'الصفحة الرئيسية - موصى به',
                'category_featured': 'صفحة التصنيف - مميز',
                'sidebar': 'الشريط الجانبي'
            };
            return positions[position] || 'غير محدد';
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'غير محدد';
            }
        }

        // دوال إدارة الإعلانات
        async function editAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                // جلب بيانات الإعلان من الجدول مباشرة
                const { data: ad, error } = await window.supabaseClient
                    .from('advertisements')
                    .select('*')
                    .eq('id', adId)
                    .single();
                
                if (error || !ad) {
                    alert('لم يتم العثور على الإعلان');
                    return;
                }

                // ملء نموذج التعديل
                document.getElementById('edit-ad-id').value = ad.id;
                document.getElementById('edit-ad-type').value = ad.ad_type || '';
                document.getElementById('edit-ad-position').value = ad.position || '';
                document.getElementById('edit-ad-start-date').value = ad.start_date ? ad.start_date.slice(0, 16) : '';
                document.getElementById('edit-ad-end-date').value = ad.end_date ? ad.end_date.slice(0, 16) : '';
                document.getElementById('edit-ad-priority').value = ad.priority || 1;
                document.getElementById('edit-ad-status').value = ad.is_active ? 'active' : 'paused';

                // إظهار النافذة
                document.getElementById('edit-ad-modal').style.display = 'flex';
            } catch (error) {
                console.error('خطأ في تحميل بيانات الإعلان:', error);
                alert('حدث خطأ في تحميل بيانات الإعلان');
            }
        }

        async function updateAdvertisement() {
            try {
                const adId = document.getElementById('edit-ad-id').value;
                const formData = {
                    category: document.getElementById('edit-ad-category').value,
                    product_id: document.getElementById('edit-ad-product').value,
                    ad_type: document.getElementById('edit-ad-type').value,
                    position: document.getElementById('edit-ad-position').value,
                    start_date: document.getElementById('edit-ad-start-date').value,
                    end_date: document.getElementById('edit-ad-end-date').value,
                    priority: parseInt(document.getElementById('edit-ad-priority').value),
                    budget: parseFloat(document.getElementById('edit-ad-budget').value) || 0,
                    status: document.getElementById('edit-ad-status').value
                };

                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisement(adId, formData);
                if (result.success) {
                    alert('تم تحديث الإعلان بنجاح');
                    hideEditAdModal();
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في تحديث الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في تحديث الإعلان:', error);
                alert('حدث خطأ في تحديث الإعلان');
            }
        }

        async function deleteAdvertisement(adId) {
            if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }

            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.deleteAdvertisement(adId);
                if (result.success) {
                    alert('تم حذف الإعلان بنجاح');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في حذف الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في حذف الإعلان:', error);
                alert('حدث خطأ في حذف الإعلان');
            }
        }

        async function pauseAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisementStatus(adId, 'paused');
                if (result.success) {
                    alert('تم إيقاف الإعلان مؤقتاً');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في إيقاف الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في إيقاف الإعلان:', error);
                alert('حدث خطأ في إيقاف الإعلان');
            }
        }

        async function activateAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisementStatus(adId, 'active');
                if (result.success) {
                    alert('تم تفعيل الإعلان بنجاح');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في تفعيل الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في تفعيل الإعلان:', error);
                alert('حدث خطأ في تفعيل الإعلان');
            }
        }

        function hideEditAdModal() {
            document.getElementById('edit-ad-modal').style.display = 'none';
        }

        async function loadProductsForEditCategory() {
            const category = document.getElementById('edit-ad-category').value;
            const productSelect = document.getElementById('edit-ad-product');
            
            if (!category) {
                productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                productSelect.disabled = true;
                return;
            }

            try {
                if (!window.productService) {
                    console.error('خدمة المنتجات غير متوفرة');
                    return;
                }

                const products = await window.productService.getProductsByCategory(category);
                productSelect.innerHTML = '<option value="">اختر المنتج</option>' +
                    products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                productSelect.disabled = false;
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                productSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
            }
        }

        async function updateEditAdPositions() {
            const adType = document.getElementById('edit-ad-type').value;
            const positionSelect = document.getElementById('edit-ad-position');
            
            if (!adType) {
                positionSelect.innerHTML = '<option value="">اختر نوع الإعلان أولاً</option>';
                return;
            }

            const positions = {
                'featured': [
                    { value: 'homepage_featured', text: 'الصفحة الرئيسية - مميز' },
                    { value: 'category_featured', text: 'صفحة التصنيف - مميز' }
                ],
                'recommended': [
                    { value: 'homepage_recommended', text: 'الصفحة الرئيسية - موصى به' }
                ],
                'banner': [
                    { value: 'sidebar', text: 'الشريط الجانبي' }
                ]
            };

            const availablePositions = positions[adType] || [];
            positionSelect.innerHTML = '<option value="">اختر الموضع</option>' +
                availablePositions.map(p => `<option value="${p.value}">${p.text}</option>`).join('');
        }

        // تحميل طلبات الإعلانات
        async function loadAdRequests() {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                // لا توجد طلبات إعلانات في النظام المبسط
                displayAdRequests([]);
            } catch (error) {
                console.error('خطأ في تحميل طلبات الإعلانات:', error);
            }
        }

        // عرض طلبات الإعلانات
        function displayAdRequests(requests) {
            const tableBody = document.getElementById('ad-requests-table');
            if (!tableBody) return;

            if (!requests || requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">لا توجد طلبات إعلانات</td></tr>';
                return;
            }

            const rows = requests.map(request => `
                <tr>
                    <td>${request.products?.name || 'غير محدد'}</td>
                    <td>${request.seller_email || 'غير محدد'}</td>
                    <td>${getAdTypeText(request.ad_type)}</td>
                    <td>${getAdPositionText(request.position)}</td>
                    <td>${request.duration_days}</td>
                    <td>${request.budget} ج.م</td>
                    <td>${request.message || 'لا توجد رسالة'}</td>
                    <td>${getRequestStatusText(request.status)}</td>
                    <td>${formatDate(request.created_at)}</td>
                    <td>
                        <button onclick="reviewAdRequest('${request.id}')" class="btn-review">مراجعة</button>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = rows;
        }

        // تحميل إحصائيات الإعلانات
        async function loadAdStatistics() {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const stats = await window.advertisingService.getActiveAdvertisements();
                updateAdStatistics(stats);
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات الإعلانات:', error);
            }
        }

        // تحديث إحصائيات الإعلانات
        function updateAdStatistics(stats) {
            if (!stats || stats.length === 0) return;

            const totalClicks = stats.reduce((sum, ad) => sum + (ad.clicks_count || 0), 0);
            const totalImpressions = stats.reduce((sum, ad) => sum + (ad.impressions_count || 0), 0);
            const activeAds = stats.filter(ad => ad.is_active === true).length;

            document.getElementById('active-ads-count').textContent = activeAds;
            document.getElementById('total-clicks').textContent = totalClicks;
            document.getElementById('total-impressions').textContent = totalImpressions;
        }

        // إظهار نموذج إضافة إعلان
        function showAddAdForm() {
            try {
                const modal = document.getElementById('add-ad-form');
                if (!modal) {
                    console.error('لم يتم العثور على النافذة المنبثقة');
                    return;
                }
                
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                modal.classList.add('show');
                
                // إعادة تعيين النموذج
                const form = document.getElementById('new-ad-form');
                if (form) form.reset();
                
                const productSelect = document.getElementById('ad-product');
                if (productSelect) {
                    productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                    productSelect.disabled = true;
                }
                
                const positionSelect = document.getElementById('ad-position');
                if (positionSelect) {
                    positionSelect.innerHTML = '<option value="">اختر النوع أولاً</option>';
                }
                
                console.log('تم فتح النافذة المنبثقة بنجاح');
            } catch (error) {
                console.error('خطأ في فتح النافذة المنبثقة:', error);
            }
        }

        // إخفاء نموذج إضافة إعلان
        function hideAddAdForm() {
            const modal = document.getElementById('add-ad-form');
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';
            modal.classList.remove('show');
        }

        // تحميل المنتجات حسب التصنيف
        async function loadProductsForCategory() {
            try {
                const category = document.getElementById('ad-category').value;
                const productSelect = document.getElementById('ad-product');
                
                if (!category) {
                    productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                    productSelect.disabled = true;
                    return;
                }
                
                // تحديد اسم الجدول
                let tableName = 'products_other';
                switch (category) {
                    case 'cake':
                        tableName = 'products_cake';
                        break;
                    case 'koshat':
                        tableName = 'products_koshat';
                        break;
                    case 'mirr':
                        tableName = 'products_mirr';
                        break;
                    case 'other':
                        tableName = 'products_other';
                        break;
                    case 'invitations':
                        tableName = 'products_invitations';
                        break;
                }
                
                // جلب المنتجات من الجدول المحدد
                const { data: products, error } = await window.supabaseClient
                    .from(tableName)
                    .select('id, description, price')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('خطأ في جلب المنتجات:', error);
                    productSelect.innerHTML = '<option value="">خطأ في تحميل المنتجات</option>';
                    return;
                }
                
                // ملء قائمة المنتجات
                productSelect.innerHTML = '<option value="">اختر المنتج</option>';
                if (products && products.length > 0) {
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.description} - ${product.price > 0 ? product.price + ' ج.م' : 'السعر عند الطلب'}`;
                        option.setAttribute('data-category', category);
                        productSelect.appendChild(option);
                    });
                } else {
                    productSelect.innerHTML = '<option value="">لا توجد منتجات في هذا التصنيف</option>';
                }
                
                productSelect.disabled = false;
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                const productSelect = document.getElementById('ad-product');
                productSelect.innerHTML = '<option value="">خطأ في تحميل المنتجات</option>';
            }
        }

        // تحديث مواضع الإعلانات حسب النوع
        function updateAdPositions() {
            const adType = document.getElementById('ad-type').value;
            const positionSelect = document.getElementById('ad-position');
            
            positionSelect.innerHTML = '<option value="">اختر الموضع</option>';
            
            if (adType === 'featured') {
                positionSelect.innerHTML += '<option value="homepage_featured">الصفحة الرئيسية - مميز</option>';
                positionSelect.innerHTML += '<option value="category_featured">صفحة التصنيف - مميز</option>';
            } else if (adType === 'recommended') {
                positionSelect.innerHTML += '<option value="homepage_recommended">الصفحة الرئيسية - موصى به</option>';
            } else if (adType === 'banner') {
                positionSelect.innerHTML += '<option value="sidebar">الشريط الجانبي</option>';
            }
        }





        // إنشاء إعلان جديد
        async function createNewAdvertisement() {
            try {
                const category = document.getElementById('ad-category').value;
                const productSelect = document.getElementById('ad-product');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                
                const formData = {
                    product_id: document.getElementById('ad-product').value,
                    product_category: category,
                    ad_type: document.getElementById('ad-type').value,
                    position: document.getElementById('ad-position').value,
                    start_date: document.getElementById('ad-start-date').value,
                    end_date: document.getElementById('ad-end-date').value,
                    priority: document.getElementById('ad-priority').value,
                    budget: document.getElementById('ad-budget').value
                };
                
                // التحقق من صحة البيانات
                if (!category || !formData.product_id || !formData.ad_type || !formData.position || !formData.start_date) {
                    alert('يرجى ملء جميع الحقول المطلوبة');
                    return;
                }

                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.createAdvertisement(formData);
                if (result) {
                    if (result.is_request) {
                        // تم إنشاء طلب إعلان بدلاً من الإعلان المباشر
                        alert(`تم إنشاء طلب إعلان بنجاح!\n\n${result.message}\n\nسيتم مراجعته من قبل الإدارة قريباً.`);
                        hideAddAdForm();
                        loadAdRequests(); // تحديث قائمة طلبات الإعلانات
                    } else {
                        // تم إنشاء الإعلان مباشرة
                        alert('تم إنشاء الإعلان بنجاح');
                        hideAddAdForm();
                        loadActiveAdvertisements();
                    }
                }
            } catch (error) {
                console.error('خطأ في إنشاء الإعلان:', error);
                alert('حدث خطأ أثناء إنشاء الإعلان');
            }
        }

        // مراجعة طلب إعلان
        function reviewAdRequest(requestId) {
            // هنا يمكنك إظهار تفاصيل الطلب
            document.getElementById('review-request-modal').style.display = 'flex';
        }

        // إخفاء نموذج مراجعة الطلب
        function hideReviewRequestModal() {
            document.getElementById('review-request-modal').style.display = 'none';
        }

        // قبول طلب إعلان
        async function approveAdRequest() {
            // هنا يمكنك تنفيذ منطق قبول الطلب
            alert('تم قبول الطلب بنجاح');
            hideReviewRequestModal();
            loadAdRequests();
        }

        // رفض طلب إعلان
        async function rejectAdRequest() {
            // هنا يمكنك تنفيذ منطق رفض الطلب
            alert('تم رفض الطلب بنجاح');
            hideReviewRequestModal();
            loadAdRequests();
        }

        // فلترة طلبات الإعلانات
        function filterAdRequests() {
            const status = document.getElementById('request-status-filter').value;
            // هنا يمكنك تنفيذ منطق الفلترة
        }

        // دوال مساعدة
        function getAdTypeText(type) {
            const typeMap = {
                'featured': 'مميز',
                'recommended': 'موصى به',
                'banner': 'بانر'
            };
            return typeMap[type] || type;
        }

        function getAdPositionText(position) {
            const positionMap = {
                'homepage_featured': 'الصفحة الرئيسية - مميز',
                'homepage_recommended': 'الصفحة الرئيسية - موصى به',
                'category_featured': 'صفحة التصنيف - مميز',
                'sidebar': 'الشريط الجانبي'
            };
            return positionMap[position] || position;
        }
        
        // ===== دوال الإحصائيات الشاملة =====
        
        // تحميل الإحصائيات الشاملة
        async function loadSystemStatistics() {
            try {
                console.log('📊 تحميل الإحصائيات الشاملة...');
                console.log('🔍 فحص توفر الخدمات...');
                
                // فحص توفر خدمة الإعلانات
                if (!window.advertisingService) {
                    console.error('❌ خدمة الإعلانات غير متوفرة');
                    console.log('🔍 محاولة انتظار تحميل الخدمة...');
                    
                    // انتظار تحميل الخدمة
                    let attempts = 0;
                    while (!window.advertisingService && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                        console.log(`محاولة ${attempts}: انتظار تحميل خدمة الإعلانات...`);
                    }
                    
                    if (!window.advertisingService) {
                        console.error('❌ فشل في تحميل خدمة الإعلانات بعد 50 محاولة');
                        alert('خطأ: خدمة الإعلانات غير متوفرة. يرجى تحديث الصفحة.');
                        return;
                    }
                }
                
                console.log('✅ خدمة الإعلانات متوفرة:', window.advertisingService);
                
                // فحص توفر دوال الإحصائيات
                if (!window.advertisingService.getSystemStatistics) {
                    console.error('❌ دالة getSystemStatistics غير متوفرة');
                    alert('خطأ: دالة الإحصائيات غير متوفرة. يرجى تحديث الصفحة.');
                    return;
                }
                
                console.log('✅ دالة getSystemStatistics متوفرة');
                
                // جلب الإحصائيات الشاملة
                console.log('🔄 جلب الإحصائيات من قاعدة البيانات...');
                const stats = await window.advertisingService.getSystemStatistics();
                
                console.log('📊 الإحصائيات المستلمة:', stats);
                
                if (stats) {
                    console.log('✅ تم جلب الإحصائيات بنجاح، عرض البيانات...');
                    displaySystemStatistics(stats);
                } else {
                    console.error('❌ فشل في جلب الإحصائيات - البيانات فارغة');
                    alert('تحذير: لم يتم العثور على بيانات إعلانات. قد تكون قاعدة البيانات فارغة.');
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحميل الإحصائيات الشاملة:', error);
                alert(`خطأ في تحميل الإحصائيات: ${error.message}`);
            }
        }
        
        // عرض الإحصائيات الشاملة
        function displaySystemStatistics(stats) {
            // الإحصائيات الرئيسية
            document.getElementById('total-ads-stat').textContent = stats.total_advertisements;
            document.getElementById('active-ads-stat').textContent = stats.active_advertisements;
            document.getElementById('total-impressions-stat').textContent = stats.total_impressions.toLocaleString('ar-EG');
            document.getElementById('total-clicks-stat').textContent = stats.total_clicks.toLocaleString('ar-EG');
            
            // معدلات الأداء
            document.getElementById('overall-ctr-stat').textContent = stats.overall_ctr + '%';
            document.getElementById('avg-impressions-stat').textContent = stats.average_impressions_per_ad;
            document.getElementById('avg-clicks-stat').textContent = stats.average_clicks_per_ad;
            
            // عرض الإحصائيات التفصيلية
            displayTypeStatistics(stats.by_type);
            displayPositionStatistics(stats.by_position);
            displayCategoryStatistics(stats.by_category);
        }
        
        // عرض إحصائيات النوع
        function displayTypeStatistics(typeStats) {
            const container = document.getElementById('type-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>النوع</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(typeStats).forEach(([type, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td>${getAdTypeText(type)}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // عرض إحصائيات الموضع
        function displayPositionStatistics(positionStats) {
            const container = document.getElementById('position-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>الموضع</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(positionStats).forEach(([position, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td>${getAdPositionText(position)}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // عرض إحصائيات التصنيف
        function displayCategoryStatistics(categoryStats) {
            const container = document.getElementById('category-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>التصنيف</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(categoryStats).forEach(([category, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                const categoryText = getCategoryText(category);
                html += `<tr>
                    <td>${categoryText}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // تحديث الإحصائيات
        function refreshSystemStatistics() {
            loadSystemStatistics();
        }
        
        // تصدير الإحصائيات
        function exportStatistics() {
            // يمكن إضافة منطق التصدير هنا
            alert('سيتم إضافة ميزة تصدير الإحصائيات قريباً');
        }
        
        // دالة مساعدة للحصول على نص التصنيف
        function getCategoryText(category) {
            const categoryMap = {
                'cake': 'تورتات',
                'koshat': 'كشات',
                'mirr': 'مير',
                'other': 'أخرى',
                'invitations': 'دعوات وتوزيعات'
            };
            return categoryMap[category] || category;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'paid': 'مدفوع',
                'expired': 'منتهي الصلاحية',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function getRequestStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'approved': 'مقبول',
                'rejected': 'مرفوض',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        // فتح صفحة تفاصيل الإعلان
        async function openAdDetails(adId) {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }
                
                console.log('🔍 فتح تفاصيل الإعلان:', adId);
                
                // جلب تفاصيل الإعلان مع المنتج
                const adWithProduct = await window.advertisingService.getAdvertisementWithProduct(adId);
                
                // فتح نافذة جديدة مع التفاصيل
                const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (detailsWindow) {
                    detailsWindow.document.write(createAdDetailsPage(adWithProduct));
                    detailsWindow.document.close();
                } else {
                    // إذا فشل فتح النافذة، اعرض في نفس الصفحة
                    showAdDetailsModal(adWithProduct);
                }
                
            } catch (error) {
                console.error('❌ خطأ في فتح تفاصيل الإعلان:', error);
                alert('حدث خطأ في فتح تفاصيل الإعلان');
            }
        }

        // إنشاء صفحة تفاصيل الإعلان
        function createAdDetailsPage(ad) {
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>تفاصيل الإعلان - ${ad.title}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: #f8fafc;
                            color: #1f2937;
                            line-height: 1.6;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 30px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                            text-align: center;
                        }
                        
                        .header h1 {
                            font-size: 2.5em;
                            margin-bottom: 10px;
                        }
                        
                        .header .subtitle {
                            font-size: 1.2em;
                            opacity: 0.9;
                        }
                        
                        .content-section {
                            background: white;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        }
                        
                        .section-title {
                            font-size: 1.5em;
                            color: #374151;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #e5e7eb;
                            padding-bottom: 10px;
                        }
                        
                        .product-images {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .product-image {
                            width: 100%;
                            height: 200px;
                            object-fit: cover;
                            border-radius: 8px;
                            border: 2px solid #e5e7eb;
                        }
                        
                        .product-details {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                        }
                        
                        .detail-item {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            padding: 10px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        
                        .detail-icon {
                            font-size: 1.2em;
                        }
                        
                        .detail-label {
                            font-weight: 600;
                            color: #374151;
                        }
                        
                        .detail-value {
                            color: #6b7280;
                        }
                        
                        .social-links {
                            display: flex;
                            gap: 15px;
                            flex-wrap: wrap;
                        }
                        
                        .social-link {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 10px 15px;
                            background: #dbeafe;
                            color: #1e40af;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        }
                        
                        .social-link:hover {
                            background: #bfdbfe;
                            transform: translateY(-2px);
                        }
                        
                        .ad-info {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-card {
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        
                        .info-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #3b82f6;
                            margin-bottom: 5px;
                        }
                        
                        .info-label {
                            color: #6b7280;
                            font-size: 0.9em;
                        }
                        
                        .close-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            padding: 10px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1.1em;
                            transition: all 0.3s ease;
                        }
                        
                        .close-btn:hover {
                            background: #dc2626;
                            transform: scale(1.1);
                        }
                    </style>
                </head>
                <body>
                    <button class="close-btn" onclick="window.close()">❌ إغلاق</button>
                    
                    <div class="container">
                        <div class="header">
                            <h1>${ad.title || 'تفاصيل الإعلان'}</h1>
                            <p class="subtitle">${ad.description || 'وصف الإعلان'}</p>
                        </div>
                        
                        ${ad.product && ad.has_product ? `
                            <div class="content-section">
                                <h2 class="section-title">🖼️ صور المنتج</h2>
                                <div class="product-images">
                                    ${ad.product.image_urls && ad.product.image_urls.length > 0 ? 
                                        ad.product.image_urls.map(img => `<img src="${img}" alt="صورة المنتج" class="product-image">`).join('') :
                                        `<img src="${ad.product.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo='}" alt="صورة المنتج" class="product-image">`
                                    }
                                </div>
                            </div>
                            
                            <div class="content-section">
                                <h2 class="section-title">🛍️ تفاصيل المنتج</h2>
                                <div class="product-details">
                                    <div class="detail-item">
                                        <span class="detail-icon">📝</span>
                                        <span class="detail-label">الاسم:</span>
                                        <span class="detail-value">${ad.product.name || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">💰</span>
                                        <span class="detail-label">السعر:</span>
                                        <span class="detail-value">${ad.product.price || 0} ج.م</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏷️</span>
                                        <span class="detail-label">التصنيف:</span>
                                        <span class="detail-value">${ad.product.category || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">📂</span>
                                        <span class="detail-label">الفئة الفرعية:</span>
                                        <span class="detail-value">${ad.product.subcategory || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏛️</span>
                                        <span class="detail-label">المحافظة:</span>
                                        <span class="detail-value">${ad.product.governorate || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏙️</span>
                                        <span class="detail-label">المدينة:</span>
                                        <span class="detail-value">${ad.product.cities || 'غير محدد'}</span>
                                    </div>
                                </div>
                                
                                ${ad.product.description ? `
                                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                        <h3 style="margin-bottom: 10px; color: #374151;">📖 الوصف</h3>
                                        <p style="color: #6b7280; line-height: 1.6;">${ad.product.description}</p>
                                    </div>
                                ` : ''}
                                
                                ${(ad.product.whatsapp || ad.product.facebook || ad.product.instagram) ? `
                                    <div style="margin-top: 20px;">
                                        <h3 style="margin-bottom: 15px; color: #374151;">📱 وسائل التواصل</h3>
                                        <div class="social-links">
                                            ${ad.product.whatsapp ? `<a href="https://wa.me/${ad.product.whatsapp}" target="_blank" class="social-link">📱 واتساب: ${ad.product.whatsapp}</a>` : ''}
                                            ${ad.product.facebook ? `<a href="${ad.product.facebook}" target="_blank" class="social-link">📘 فيسبوك</a>` : ''}
                                            ${ad.product.instagram ? `<a href="https://instagram.com/${ad.product.instagram}" target="_blank" class="social-link">📷 إنستغرام: @${ad.product.instagram}</a>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="content-section">
                                <h2 class="section-title">⚠️ لا يوجد منتج مرتبط</h2>
                                <p style="text-align: center; color: #6b7280; font-size: 1.1em;">هذا الإعلان غير مرتبط بمنتج حقيقي</p>
                            </div>
                        `}
                        
                        <div class="content-section">
                            <h2 class="section-title">📊 معلومات الإعلان</h2>
                            <div class="ad-info">
                                <div class="info-card">
                                    <div class="info-value">${ad.ad_type || 'غير محدد'}</div>
                                    <div class="info-label">نوع الإعلان</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.position || 'غير محدد'}</div>
                                    <div class="info-label">الموقع</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.priority || 1}</div>
                                    <div class="info-label">الأولوية</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.is_active ? 'نشط' : 'متوقف'}</div>
                                    <div class="info-label">الحالة</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="detail-item">
                                    <span class="detail-icon">📅</span>
                                    <span class="detail-label">تاريخ البداية:</span>
                                    <span class="detail-value">${formatDate(ad.start_date)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">⏰</span>
                                    <span class="detail-label">تاريخ الانتهاء:</span>
                                    <span class="detail-value">${ad.end_date ? formatDate(ad.end_date) : 'غير محدد'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${ad.link_url ? `
                            <div class="content-section">
                                <h2 class="section-title">🔗 رابط الإعلان</h2>
                                <a href="${ad.link_url}" target="_blank" style="display: inline-block; padding: 15px 25px; background: #3b82f6; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                                    🌐 فتح الرابط
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `;
        }
    </script>
</body>
</html> 