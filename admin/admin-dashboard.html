<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - الرئيسية</title>
    <link rel="icon" type="image/png" href="../assets/images/zeina.jpeg">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" as="script">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js?v=2025-08-22-1"></script>
    <script src="../js/admin-security.js?v=2025-08-22-1"></script>
    <script src="../js/product-requests-service.js?v=2025-08-22-1"></script>
    <script src="../js/cities-service.js?v=2025-08-22-1"></script>
    <script src="../js/advertising-service.js?v=2025-08-22-1"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1994970196400389"
     crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            direction: rtl;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 15px;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
        }

        .quick-actions {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .action-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .action-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .action-description {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .recent-activity {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 1.5em;
            color: #667eea;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .activity-time {
            color: #666;
            font-size: 0.9em;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* Product Requests Styles */
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .filter-btn.debug-btn {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .filter-btn.debug-btn:hover {
            background: #d97706;
            border-color: #d97706;
        }

        .filter-btn.test-btn {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .filter-btn.test-btn:hover {
            background: #059669;
            border-color: #059669;
        }

        .request-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-approved {
            background: #d1fae5;
            color: #059669;
        }

        .status-rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .request-images {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .request-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-approve:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-reject {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-reject:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Request Card Styles */
        .request-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .request-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
        }

        .status-approved {
            background: #10b981;
        }

        .status-rejected {
            background: #ef4444;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f3f4f6;
            flex-wrap: wrap;
        }

        .request-images {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .request-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .request-image:hover {
            transform: scale(1.05);
        }

        /* Grid Layout */
        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .gap-4 {
            gap: 1rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .text-center {
            text-align: center;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .font-semibold {
            font-weight: 600;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        /* Filter Buttons */
        .filter-btn {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .filter-btn .count {
            background: rgba(255,255,255,0.2);
            color: inherit;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        /* Section Styles */
        .section-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .recent-activity {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .flex {
            display: flex;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        /* Spacing Utilities */
        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .request-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .request-actions .btn {
                width: 100%;
            }
            
            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .filter-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
            }
        }

        .btn-view {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn-modal-secondary:hover {
            border-color: #9ca3af;
            color: #374151;
        }

        /* ===== تصميم محترف لنافذة إضافة الإعلان ===== */
        
        /* Edit Request Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Request Details Modal Styles */
        .request-details-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .request-details-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .request-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .request-detail-label {
            font-weight: 600;
            color: #374151;
            min-width: 120px;
        }

        .request-detail-value {
            color: #6b7280;
            text-align: left;
            flex: 1;
            margin-right: 20px;
        }

        .request-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .request-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .request-image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .request-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .request-image-item:hover .request-image-overlay {
            opacity: 1;
        }

        .request-image-overlay button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Cities Filter Styles for Edit Request */
        .cities-dropdown {
            display: none;
        }
        
        .cities-dropdown.show {
            display: block !important;
        }
        
        .cities-trigger.active .chevron-icon {
            transform: rotate(180deg);
        }
        
        .cities-trigger.active {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* Edit Image Styles */
        .edit-image-item {
            transition: all 0.3s ease;
        }

        .edit-image-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .edit-image-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
            cursor: grabbing;
        }

        .edit-image-item.drag-over {
            border: 2px dashed #d4af37 !important;
            background: rgba(212, 175, 55, 0.1) !important;
        }

        .edit-drag-handle {
            transition: all 0.3s ease;
        }

        .edit-drag-handle:hover {
            background: rgba(0, 0, 0, 0.9) !important;
            transform: scale(1.1);
        }

        .edit-image-number {
            transition: all 0.3s ease;
        }

        .image-sort-instructions-edit {
            animation: pulse-edit 2s infinite;
        }

        @keyframes pulse-edit {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* خلفية النافذة المنبثقة */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay[style*="display: flex"] {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* محتوى النافذة المنبثقة */
        .modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(-30px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-overlay.show .modal-content {
            transform: translateY(0) scale(1);
        }
        
        .modal-overlay[style*="display: flex"] .modal-content {
            transform: translateY(0) scale(1);
        }
        
        /* رأس النافذة المنبثقة */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px 24px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg) scale(1.1);
        }
        
        /* جسم النافذة المنبثقة */
        .modal-body {
            padding: 32px;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            position: relative;
        }
        
        .modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
        }
        
        /* تأثيرات إضافية للنافذة */
        .modal-content {
            position: relative;
        }
        
        .modal-content::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea);
            border-radius: 26px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-content:hover::after {
            opacity: 0.1;
        }
        
        /* تذييل النافذة المنبثقة */
        .modal-footer {
            padding: 28px 32px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 0 0 24px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* ===== تصميم محترف لحقول النموذج ===== */
        
        .form-group {
            margin-bottom: 24px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-group label:hover {
            color: #667eea;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 3px rgba(102, 126, 234, 0.1),
                0 4px 8px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }
        
        .form-group select:hover,
        .form-group input:hover,
        .form-group textarea:hover {
            border-color: #d1d5db;
            transform: translateY(-1px);
        }
        
        .form-group select:disabled {
            background: linear-gradient(145deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* تصميم الصفوف */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        /* تصميم الأزرار */
        .btn-modal-primary,
        .btn-modal-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .btn-modal-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-modal-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modal-primary:hover::before {
            left: 100%;
        }
        
        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-modal-primary:active {
            transform: translateY(0);
        }
        
        .btn-modal-secondary {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            border: 2px solid #d1d5db;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-modal-secondary:hover {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border-color: #9ca3af;
            transform: translateY(-1px);
        }
        
        .btn-modal-primary span,
        .btn-modal-secondary span {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        
        .btn-modal-primary:hover span,
        .btn-modal-secondary:hover span {
            transform: scale(1.1);
        }
        
        /* Request Details Styles */
        .request-detail-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .request-detail-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            display: block;
        }

        .request-detail-value {
            color: #6b7280;
            line-height: 1.5;
        }

        .request-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .request-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .request-image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            transition: transform 0.2s ease;
        }

        .request-image-item:hover img {
            transform: scale(1.05);
        }

        .request-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .request-image-item:hover .request-image-overlay {
            opacity: 1;
        }

        .request-image-overlay button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s ease;
        }

        .request-image-overlay button:hover {
            background: #2563eb;
        }

        /* أنماط الإعلانات */
        .advertising-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .tab-btn:hover:not(.active) {
            background: #f3f4f6;
        }

        .add-ad-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-ad-btn:hover {
            background: #059669;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ads-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            display: block;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
        }
        
        /* أنماط الإحصائيات الشاملة */
        .stats-overview {
            padding: 20px;
        }
        
        .stats-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .main-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .stat-card.primary {
            border-left: 4px solid #3b82f6;
        }
        
        .stat-card.success {
            border-left: 4px solid #10b981;
        }
        
        .stat-card.info {
            border-left: 4px solid #06b6d4;
        }
        
        .stat-card.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f3f4f6;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-content .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 5px;
        }
        
        .stat-content .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .performance-stats {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .performance-stats h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .performance-label {
            font-weight: 500;
            color: #374151;
        }
        
        .performance-value {
            font-weight: 600;
            color: #111827;
            font-size: 1.125rem;
        }
        
        .detailed-stats {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .detailed-stats h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .stats-section h5 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .stats-table-container {
            overflow-x: auto;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-table th {
            background: #f3f4f6;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .stats-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .stats-table tr:hover {
            background: #f9fafb;
        }
        
        .stats-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }

        .ads-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .ads-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ads-table th,
        .ads-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        /* أنماط بطاقات الإعلانات */
        .ads-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .ad-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .ad-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: relative;
        }

        .ad-card-header .ad-type-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .ad-card-header .ad-status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .ad-card-header .ad-status-badge.active {
            background: #10b981;
            color: white;
        }

        .ad-card-header .ad-status-badge.paused {
            background: #f59e0b;
            color: white;
        }

        .ad-card-header .ad-status-badge.expired {
            background: #ef4444;
            color: white;
        }

        .ad-card-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ad-card-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .ad-card-body {
            padding: 20px;
        }

        .ad-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .ad-info-item {
            display: flex;
            flex-direction: column;
        }

        .ad-info-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ad-info-value {
            font-size: 0.875rem;
            color: #1f2937;
            font-weight: 500;
        }

        .ad-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .ad-stat-item {
            text-align: center;
        }

        .ad-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            display: block;
        }

        .ad-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .ad-card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ad-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ad-action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .ad-action-btn.edit:hover {
            background: #2563eb;
        }

        .ad-action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .ad-action-btn.delete:hover {
            background: #dc2626;
        }

        .ad-action-btn.pause {
            background: #f59e0b;
            color: white;
        }

        .ad-action-btn.pause:hover {
            background: #d97706;
        }

        .ad-action-btn.activate {
            background: #10b981;
            color: white;
        }

        .ad-action-btn.activate:hover {
            background: #059669;
        }

        /* رسالة عدم وجود إعلانات */
        .no-ads-message {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .no-ads-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .no-ads-message h3 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .no-ads-message p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.125rem;
        }

        .ads-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .ads-table tr:hover {
            background: #f9fafb;
        }

        .requests-filters {
            margin-bottom: 20px;
        }

        .requests-filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-modal-success {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-success:hover {
            background: #059669;
        }

        .btn-modal-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-modal-danger:hover {
            background: #dc2626;
        }

        /* معلومات المنتج المرتبط */
        .ad-product-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 15px 20px;
            overflow: hidden;
        }

        .ad-product-info.no-product {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .product-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ad-product-info.no-product .product-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .product-badge {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .product-category {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .no-product-badge {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .product-details {
            padding: 15px;
        }

        .product-name {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .product-description {
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .product-price {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 12px;
        }

        .product-location {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }

        .location-item {
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #374151;
        }

        .product-images {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .images-count {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .product-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
        }

        .product-social {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .social-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* التصميم الجديد للبطاقات */
        .ad-card-elegant {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            position: relative;
        }

        .ad-card-elegant:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .ad-card-image-container {
            position: relative;
            height: 250px;
            overflow: hidden;
        }

        .ad-card-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .ad-card-elegant:hover .ad-card-main-image {
            transform: scale(1.1);
        }

        .ad-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.4) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .ad-card-elegant:hover .ad-card-overlay {
            opacity: 1;
        }

        .ad-card-badges {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .ad-type-badge-elegant {
            background: rgba(255,255,255,0.9);
            color: #374151;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .ad-status-badge-elegant {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .ad-status-badge-elegant.active {
            background: rgba(16, 185, 129, 0.9);
        }

        .ad-status-badge-elegant.paused {
            background: rgba(245, 158, 11, 0.9);
        }

        .ad-status-badge-elegant.expired {
            background: rgba(239, 68, 68, 0.9);
        }

        .ad-card-hover-info {
            text-align: center;
            color: white;
        }

        .hover-text {
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .ad-card-content {
            padding: 20px;
        }

        .ad-card-header-elegant {
            margin-bottom: 15px;
        }

        .ad-card-title-elegant {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .ad-card-subtitle-elegant {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .ad-card-product-info {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .product-name-elegant {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .product-price-elegant {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 5px;
        }

        .product-category-elegant {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .ad-card-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .meta-icon {
            font-size: 1rem;
        }

        .meta-text {
            color: #475569;
            font-weight: 500;
        }

        .ad-card-actions-elegant {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .ad-action-btn-elegant {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ad-action-btn-elegant.edit {
            background: #3b82f6;
            color: white;
        }

        .ad-action-btn-elegant.edit:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .ad-action-btn-elegant.delete {
            background: #ef4444;
            color: white;
        }

        .ad-action-btn-elegant.delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* تحسين عرض البطاقات */
        #active-ads-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }
    </style>
</head>
<body>
    <script>
        // التحقق من الأمان - سيتم تنفيذه بعد تحميل adminSecurity
        async function checkAuthOnLoad() {
            // انتظار تحميل Supabase أولاً
            let attempts = 0;
            while (!window.supabaseClient && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.supabaseClient) {
                console.error('Supabase client not available');
                window.location.href = 'admin-login.html';
                return;
            }
            
            // التحقق من وجود مستخدم مسجل دخول
            try {
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (!user) {
                    console.log('No user logged in, redirecting to login');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                // التحقق من المستخدم المسجل
                console.log('User in dashboard:', user);
                
                // السماح لجميع المستخدمين المسجلين بالدخول (مؤقتاً)
                if (user.email) {
                    console.log('✅ User authenticated successfully');
                } else {
                    console.log('User not authenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                console.log('✅ User authenticated successfully');
                
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'admin-login.html';
                return;
            }
            
            // إذا وصلنا هنا، المستخدم مسجل دخول ولديه صلاحيات
            // انتظار تحميل adminSecurity للوظائف الأخرى
            while (!window.adminSecurity) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        checkAuthOnLoad();
    </script>

    <header class="header">
        <div class="header-content">
            <h1>🏠 لوحة الإدارة</h1>
            <div class="nav-buttons">
                <a href="../index.html" class="nav-btn">🏠 الصفحة الرئيسية</a>
                <a href="admin-users.html" class="nav-btn">إدارة المستخدمين</a>
                <button class="nav-btn" onclick="showAdvertisingPanel()">📢 الإعلانات</button>
                <button class="nav-btn" onclick="handleLogout()">تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="welcome-section">
            <h1 class="welcome-title">مرحباً بك في لوحة الإدارة</h1>
            <p class="welcome-subtitle">إدارة شاملة لجميع جوانب النظام</p>
            <div class="user-info" id="userInfo">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
        </div>

        <!-- إحصائيات سريعة -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">إجمالي المستخدمين</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📦</div>
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">إجمالي المنتجات</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🖼️</div>
                <div class="stat-number" id="totalImages">0</div>
                <div class="stat-label">إجمالي الصور</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📸</div>
                <div class="stat-number" id="avgImagesPerProduct">0</div>
                <div class="stat-label">متوسط الصور/منتج</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">المستخدمين النشطين</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔔</div>
                <div class="stat-number" id="recentLogs">0</div>
                <div class="stat-label">الأحداث الأخيرة</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📝</div>
                <div class="stat-number" id="pendingRequests">0</div>
                <div class="stat-label">طلبات في الانتظار</div>
            </div>
        </div>

        <!-- إجراءات سريعة -->
        <div class="quick-actions">
            <h2 class="section-title">إجراءات سريعة</h2>
            <div class="actions-grid">
                <a href="../index.html" class="action-card">
                    <div class="action-icon">🏠</div>
                    <div class="action-title">الصفحة الرئيسية</div>
                    <div class="action-description">العودة للصفحة الرئيسية للموقع</div>
                </a>
                <a href="admin-users.html" class="action-card">
                    <div class="action-icon">👥</div>
                    <div class="action-title">إدارة المستخدمين</div>
                    <div class="action-description">إضافة وتعديل وحذف المستخدمين</div>
                </a>
                <a href="add-product.html" class="action-card">
                    <div class="action-icon">➕</div>
                    <div class="action-title">إضافة منتج</div>
                    <div class="action-description">إضافة منتج جديد للنظام</div>
                </a>
                <a href="admin-products.html" class="action-card">
                    <div class="action-icon">📋</div>
                    <div class="action-title">إدارة المنتجات</div>
                    <div class="action-description">عرض وتعديل جميع المنتجات</div>
                </a>
                <a href="#" class="action-card" onclick="showProductRequests()">
                    <div class="action-icon">📝</div>
                    <div class="action-title">طلبات المنتجات</div>
                    <div class="action-description">مراجعة طلبات إضافة المنتجات</div>
                </a>
                <a href="#" class="action-card" onclick="showReports()">
                    <div class="action-icon">📊</div>
                    <div class="action-title">التقارير</div>
                    <div class="action-description">عرض تقارير النظام</div>
                </a>
                <a href="#" class="action-card" onclick="showAdvertisingPanel()">
                    <div class="action-icon">📢</div>
                    <div class="action-title">إدارة الإعلانات</div>
                    <div class="action-description">إدارة المنتجات المميزة والإعلانات</div>
                </a>
            </div>
        </div>

        <!-- النشاط الأخير -->
        <div class="recent-activity">
            <h2 class="section-title">النشاط الأخير</h2>
            <ul class="activity-list" id="activityList">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </ul>
        </div>

        <!-- قسم إدارة طلبات المنتجات -->
        <div id="product-requests-section" class="recent-activity" style="display: none;">
            <h2 class="section-title">إدارة طلبات المنتجات</h2>
            
            <!-- فلتر الحالة -->
            <div class="mb-6 flex justify-center gap-4">
                <button class="filter-btn active" data-status="all">الكل</button>
                <button class="filter-btn" data-status="pending">في الانتظار</button>
                <button class="filter-btn" data-status="approved">تمت الموافقة</button>
                <button class="filter-btn" data-status="rejected">مرفوضة</button>
            </div>
            
            <!-- قائمة الطلبات -->
            <div id="requests-list" class="space-y-4">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
            
                    <!-- رسالة عدم وجود طلبات -->
        <div id="no-requests-message" class="text-center py-8 text-gray-500" style="display: none;">
            لا توجد طلبات في هذه الفئة
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="request-details-modal" class="request-details-modal">
        <div class="request-details-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.5em;">تفاصيل الطلب</h3>
                <button onclick="closeRequestDetails()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px;">×</button>
            </div>
            <div id="request-details-content">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div id="editRequestModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin: 0; font-size: 1.5em;">تعديل الطلب</h3>
                <button onclick="closeEditRequestModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 5px; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">×</button>
            </div>
            
            <form id="editRequestForm" style="display: grid; gap: 20px;">
                <input type="hidden" id="edit-request-id">
                
                <!-- Request Details -->
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">وصف المنتج</label>
                        <textarea id="edit-request-description" rows="3" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">السعر (ج.م)</label>
                            <input type="number" id="edit-request-price" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">الفئة</label>
                            <select id="edit-request-category" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                                <option value="koshat">كوشات</option>
                                <option value="mirr">مرايا</option>
                                <option value="cake">تورتة</option>
                                <option value="other">ديكورات متنوعة</option>
                                <option value="invitations">دعوات وتوزيعات</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Governorates and Subcategories -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">المحافظات</label>
                        <div id="edit-request-governorate-checkboxes" style="max-height: 150px; overflow-y: auto; border: 2px solid #e1e5e9; border-radius: 8px; padding: 10px; background: white;">
                            <!-- سيتم توليد المحافظات هنا -->
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">التصنيف الفرعي</label>
                        <div id="edit-request-subcategory-checkboxes" style="max-height: 150px; overflow-y: auto; border: 2px solid #e1e5e9; border-radius: 8px; padding: 10px; background: white;">
                            <!-- سيتم توليد التصنيفات الفرعية هنا -->
                        </div>
                    </div>
                </div>
                
                <!-- Cities -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">المناطق/المدن المتوفرة (اختياري)</label>
                    <div id="edit-request-cities-container">
                        <div class="cities-filter-container" style="position: relative; width: 100%; max-width: 400px; font-family: 'Tajawal', sans-serif;">
                            <div class="cities-header" style="position: relative;">
                                <div class="cities-trigger" id="edit-request-cities-trigger" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; min-height: 48px;">
                                    <div class="trigger-content" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                        <svg class="location-icon" style="width: 20px; height: 20px; color: #6b7280; flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span class="trigger-text" style="color: #374151; font-weight: 500; flex: 1;">اختر المناطق/المدن (اختياري)</span>
                                        <span class="selected-count" id="edit-request-cities-selected-count" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; min-width: 20px; text-align: center; display: none;"></span>
                                    </div>
                                    <svg class="chevron-icon" style="width: 16px; height: 16px; color: #6b7280; transition: transform 0.3s ease; flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6,9 12,15 18,9"></polyline>
                                    </svg>
                                </div>
                            </div>
                            
                            <div class="cities-dropdown" id="edit-request-cities-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); z-index: 1000; margin-top: 4px; max-height: 400px; overflow: hidden;">
                                <div class="dropdown-header" style="padding: 16px; border-bottom: 1px solid #e5e5e7;">
                                    <div class="search-container" style="position: relative; margin-bottom: 12px;">
                                        <svg class="search-icon" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #9ca3af;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="m21 21-4.35-4.35"></path>
                                        </svg>
                                        <input type="text" id="edit-request-cities-search" placeholder="ابحث عن منطقة..." style="width: 100%; padding: 8px 12px 8px 36px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s ease;">
                                    </div>
                                    <div class="actions" style="display: flex; gap: 8px;">
                                        <button type="button" id="edit-request-select-all-cities-btn" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; color: #374151; cursor: pointer; transition: all 0.3s ease;">تحديد الكل</button>
                                        <button type="button" id="edit-request-clear-all-cities-btn" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; color: #374151; cursor: pointer; transition: all 0.3s ease;">إلغاء الكل</button>
                                    </div>
                                </div>
                                
                                <div class="cities-list" id="edit-request-cities-list" style="max-height: 250px; overflow-y: auto; padding: 8px 0;">
                                    <!-- Cities will be populated here -->
                                </div>
                                
                                <div class="dropdown-footer" style="padding: 12px 16px; border-top: 1px solid #e5e5e7; background: #f9fafb;">
                                    <button type="button" id="edit-request-apply-cities-filter" style="width: 100%; padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20,6 9,17 4,12"></polyline>
                                        </svg>
                                        تطبيق الفلتر
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="edit-request-selected-cities" class="selected-cities" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;"></div>
                    </div>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">اختر المناطق أو المدن المتوفرة داخل المحافظات المختارة (اختياري - يمكنك تخطي هذا الحقل)</p>
                </div>
                
                <!-- Contact Information -->
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">رقم الواتساب</label>
                        <input type="tel" id="edit-request-whatsapp" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">رابط الفيسبوك (اختياري)</label>
                        <input type="url" id="edit-request-facebook" placeholder="https://facebook.com/..." style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">رابط الإنستقرام (اختياري)</label>
                        <input type="text" id="edit-request-instagram" placeholder="https://instagram.com/username أو @username" style="width: 10px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <!-- Current Images -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">الصور الحالية</label>
                    <div class="image-sort-instructions-edit" style="margin-bottom: 15px; padding: 10px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; display: flex; align-items: center; color: #1e40af; font-size: 14px;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; margin-left: 8px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        </svg>
                        اسحب الصور لترتيبها - الصورة الأولى ستكون الصورة الرئيسية
                    </div>
                    <div id="edit-request-current-images" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 60px;">
                        <!-- الصور الحالية ستظهر هنا -->
                    </div>
                </div>
                
                <!-- Add New Images -->
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">إضافة صور جديدة</label>
                    <div id="edit-request-image-upload-area" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 24px; color: #9ca3af; margin-bottom: 10px;">📷</div>
                        <p style="color: #6b7280; margin-bottom: 5px; font-size: 14px;">اسحب الصور هنا أو اضغط للاختيار</p>
                        <p style="font-size: 12px; color: #9ca3af; text-align: center;">يمكنك اختيار أكثر من صورة في نفس الوقت</p>
                        <input type="file" id="edit-request-new-images" multiple accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <!-- Buttons -->
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="closeEditRequestModal()" class="btn btn-edit">إلغاء</button>
                    <button type="submit" class="btn btn-view">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>

        <!-- قسم التقارير -->
        <div id="reports-section" class="recent-activity" style="display: none;">
            <h2 class="section-title">📊 تقارير النظام</h2>
            
            <!-- أزرار التقرير -->
            <div class="mb-6 flex justify-center gap-4 flex-wrap">
                <button class="filter-btn active" data-report="products">📦 تقرير المنتجات</button>
                <button class="filter-btn" data-report="users">👥 تقرير المستخدمين</button>
                <button class="filter-btn" data-report="images">🖼️ تقرير الصور</button>
                <button class="filter-btn" data-report="performance">⚡ تقرير الأداء</button>
            </div>
            
            <!-- محتوى التقارير -->
            <div id="reports-content" class="space-y-6">
                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
            </div>
        </div>

        <!-- قسم الإعلانات -->
        <div id="advertising-panel" class="recent-activity" style="display: none;">
            <h2 class="section-title">📢 إدارة الإعلانات والمنتجات المميزة</h2>
            
            <!-- تبويبات الإعلانات -->
            <div class="advertising-tabs">
                <button class="filter-btn active" onclick="switchAdvertisingTab('active-ads')">الإعلانات النشطة</button>
                <button class="filter-btn" onclick="switchAdvertisingTab('ad-requests')">طلبات الإعلانات</button>
                <button class="filter-btn" onclick="showAddAdForm()">➕ إضافة إعلان جديد</button>
                <button class="filter-btn" onclick="showSystemStatistics()">📊 الإحصائيات الشاملة</button>
                <button class="filter-btn" onclick="debugAdvertisementsData()" style="background-color: #ff6b6b; color: white;">🔍 فحص البيانات</button>
            </div>

            <!-- تبويب الإعلانات النشطة -->
            <div id="active-ads-tab" class="tab-content active">
                <div class="ads-stats">
                    <div class="stat-item">
                        <span class="stat-label">إعلانات نشطة:</span>
                        <span class="stat-value" id="active-ads-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">إجمالي النقرات:</span>
                        <span class="stat-value" id="total-clicks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">إجمالي الظهورات:</span>
                        <span class="stat-value" id="total-impressions">0</span>
                    </div>
                </div>
                
                <!-- بطاقات الإعلانات النشطة -->
                <div id="active-ads-cards" class="ads-cards-container">
                    <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                </div>
                
                <!-- رسالة عدم وجود إعلانات -->
                <div id="no-ads-message" class="no-ads-message" style="display: none;">
                    <div class="no-ads-icon">📢</div>
                    <h3>لا توجد إعلانات نشطة</h3>
                    <p>ابدأ بإضافة إعلان جديد لجذب المزيد من العملاء</p>
                    <button class="btn-primary" onclick="showAddAdForm()">
                        <span>➕</span>
                        إضافة إعلان جديد
                    </button>
                </div>
            </div>

            <!-- تبويب طلبات الإعلانات -->
            <div id="ad-requests-tab" class="tab-content" style="display: none;">
                <div class="requests-filters">
                    <select id="request-status-filter" onchange="filterAdRequests()">
                        <option value="">جميع الحالات</option>
                        <option value="pending">في الانتظار</option>
                        <option value="approved">مقبول</option>
                        <option value="rejected">مرفوض</option>
                        <option value="cancelled">ملغي</option>
                    </select>
                </div>
                
                <div class="requests-table-container">
                    <table class="ads-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>البائع</th>
                                <th>النوع</th>
                                <th>الموضع</th>
                                <th>المدة (أيام)</th>
                                <th>الميزانية</th>
                                <th>الرسالة</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ad-requests-table">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تبويب الإحصائيات الشاملة -->
            <div id="system-stats-tab" class="tab-content" style="display: none;">
                <div class="stats-overview">
                    <h3 class="stats-title">📊 نظرة عامة على النظام</h3>
                    
                    <!-- الإحصائيات الرئيسية -->
                    <div class="main-stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-icon">📢</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-ads-stat">0</div>
                                <div class="stat-label">إجمالي الإعلانات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card success">
                            <div class="stat-icon">✅</div>
                            <div class="stat-content">
                                <div class="stat-value" id="active-ads-stat">0</div>
                                <div class="stat-label">الإعلانات النشطة</div>
                            </div>
                        </div>
                        
                        <div class="stat-card info">
                            <div class="stat-icon">👁️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-impressions-stat">0</div>
                                <div class="stat-label">إجمالي الظهورات</div>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon">🖱️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-clicks-stat">0</div>
                                <div class="stat-label">إجمالي النقرات</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- معدلات الأداء -->
                    <div class="performance-stats">
                        <h4>معدلات الأداء</h4>
                        <div class="performance-grid">
                            <div class="performance-item">
                                <span class="performance-label">معدل النقر الإجمالي:</span>
                                <span class="performance-value" id="overall-ctr-stat">0%</span>
                            </div>
                            <div class="performance-item">
                                <span class="performance-label">متوسط الظهورات لكل إعلان:</span>
                                <span class="performance-value" id="avg-impressions-stat">0</span>
                            </div>
                            <div class="performance-item">
                                <span class="performance-label">متوسط النقرات لكل إعلان:</span>
                                <span class="performance-value" id="avg-clicks-stat">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الإحصائيات التفصيلية -->
                    <div class="detailed-stats">
                        <h4>الإحصائيات التفصيلية</h4>
                        
                        <!-- حسب النوع -->
                        <div class="stats-section">
                            <h5>حسب نوع الإعلان</h5>
                            <div id="type-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                        
                        <!-- حسب الموضع -->
                        <div class="stats-section">
                            <h5>حسب موضع الإعلان</h5>
                            <div id="position-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                        
                        <!-- حسب التصنيف -->
                        <div class="stats-section">
                            <h5>حسب تصنيف المنتج</h5>
                            <div id="category-stats" class="stats-table-container">
                                <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- زر تحديث الإحصائيات -->
                    <div class="stats-actions">
                        <button class="btn-primary" onclick="refreshSystemStatistics()">
                            <span>🔄</span>
                            تحديث الإحصائيات
                        </button>
                        <button class="btn-secondary" onclick="exportStatistics()">
                            <span>📥</span>
                            تصدير الإحصائيات
                        </button>
                    </div>
                </div>
            </div>
                <div class="requests-filters">
                    <select id="request-status-filter" onchange="filterAdRequests()">
                        <option value="">جميع الحالات</option>
                        <option value="pending">في الانتظار</option>
                        <option value="approved">مقبول</option>
                        <option value="rejected">مرفوض</option>
                        <option value="cancelled">ملغي</option>
                    </select>
                </div>
                
                <div class="requests-table-container">
                    <table class="ads-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>البائع</th>
                                <th>النوع</th>
                                <th>الموضع</th>
                                <th>المدة (أيام)</th>
                                <th>الميزانية</th>
                                <th>الرسالة</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ad-requests-table">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- نافذة تفاصيل الطلب -->
        <div id="request-details-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الطلب</h3>
                    <button class="modal-close" onclick="closeRequestDetails(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="request-details-content">
                        <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="closeRequestDetails(); return false;">إغلاق</button>
                </div>
            </div>
        </div>

        <!-- نموذج إضافة إعلان جديد -->
        <div id="add-ad-form" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">إضافة إعلان جديد</h3>
                    <button class="modal-close" onclick="hideAddAdForm(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="new-ad-form">
                        <div class="form-group">
                            <label for="ad-title">عنوان الإعلان:</label>
                            <input type="text" id="ad-title" placeholder="أدخل عنوان الإعلان" required>
                        </div>
                        <div class="form-group">
                            <label for="ad-description">وصف الإعلان:</label>
                            <textarea id="ad-description" placeholder="أدخل وصف الإعلان" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ad-category">التصنيف:</label>
                            <select id="ad-category" required onchange="loadProductsForCategory(); updateAdSections();">
                                <option value="">اختر التصنيف</option>
                                <option value="cake">تورتات</option>
                                <option value="koshat">كوشات</option>
                                <option value="mirr">مرايا</option>
                                <option value="other">ديكورات متنوعة</option>
                                <option value="invitations">دعوات وتوزيعات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-section">القسم:</label>
                            <select id="ad-section" required disabled>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-product">المنتج:</label>
                            <select id="ad-product" required disabled>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-type">نوع الإعلان:</label>
                            <select id="ad-type" required onchange="updateAdPositions()">
                                <option value="">اختر النوع</option>
                                <option value="featured">مميز</option>
                                <option value="recommended">موصى به</option>
                                <option value="banner">بانر</option>
                                <option value="category_sections">أقسام التصنيفات في الصفحة الرئيسية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ad-position">الموضع:</label>
                            <select id="ad-position" required>
                                <option value="">اختر الموضع</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ad-start-date">تاريخ البداية:</label>
                                <input type="datetime-local" id="ad-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="ad-end-date">تاريخ الانتهاء:</label>
                                <input type="datetime-local" id="ad-end-date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ad-priority">الأولوية:</label>
                                <input type="number" id="ad-priority" min="1" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="ad-budget">الميزانية:</label>
                                <input type="number" id="ad-budget" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideAddAdForm(); return false;">
                        <span>❌</span>
                        إلغاء
                    </button>
                    <button class="btn-modal-primary" onclick="createNewAdvertisement(); return false;">
                        <span>✨</span>
                        إضافة الإعلان
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج تعديل الإعلان -->
        <div id="edit-ad-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">✏️ تعديل الإعلان</h3>
                    <button class="modal-close" onclick="hideEditAdModal(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-ad-form">
                        <input type="hidden" id="edit-ad-id">
                        <div class="form-group">
                            <label for="edit-ad-title">عنوان الإعلان:</label>
                            <input type="text" id="edit-ad-title" placeholder="أدخل عنوان الإعلان" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-description">وصف الإعلان:</label>
                            <textarea id="edit-ad-description" placeholder="أدخل وصف الإعلان" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-category">التصنيف:</label>
                            <select id="edit-ad-category" required onchange="loadProductsForEditCategory(); updateEditAdSections();">
                                <option value="">اختر التصنيف</option>
                                <option value="cake">تورتات</option>
                                <option value="koshat">كوشات</option>
                                <option value="mirr">مرايا</option>
                                <option value="other">ديكورات متنوعة</option>
                                <option value="invitations">دعوات وتوزيعات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-section">القسم:</label>
                            <select id="edit-ad-section" required disabled>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-product">المنتج:</label>
                            <select id="edit-ad-product" required>
                                <option value="">اختر التصنيف أولاً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-type">نوع الإعلان:</label>
                            <select id="edit-ad-type" required onchange="updateEditAdPositions()">
                                <option value="">اختر النوع</option>
                                <option value="featured">مميز</option>
                                <option value="recommended">موصى به</option>
                                <option value="banner">بانر</option>
                                <option value="category_sections">أقسام التصنيفات في الصفحة الرئيسية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-position">الموضع:</label>
                            <select id="edit-ad-position" required>
                                <option value="">اختر الموضع</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-ad-start-date">تاريخ البداية:</label>
                                <input type="datetime-local" id="edit-ad-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-ad-end-date">تاريخ الانتهاء:</label>
                                <input type="datetime-local" id="edit-ad-end-date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-ad-priority">الأولوية:</label>
                                <input type="number" id="edit-ad-priority" min="1" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="edit-ad-budget">الميزانية:</label>
                                <input type="number" id="edit-ad-budget" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-ad-status">الحالة:</label>
                            <select id="edit-ad-status" required>
                                <option value="active">نشط</option>
                                <option value="paused">متوقف مؤقتاً</option>
                                <option value="expired">منتهي الصلاحية</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideEditAdModal(); return false;">
                        <span>❌</span>
                        إلغاء
                    </button>
                    <button class="btn-modal-danger" onclick="deleteAdvertisement(); return false;">
                        <span>🗑️</span>
                        حذف الإعلان
                    </button>
                    <button class="btn-modal-primary" onclick="updateAdvertisement(); return false;">
                        <span>💾</span>
                        حفظ التعديلات
                    </button>
                </div>
            </div>
        </div>

        <!-- نموذج مراجعة طلب إعلان -->
        <div id="review-request-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">مراجعة طلب الإعلان</h3>
                    <button class="modal-close" onclick="hideReviewRequestModal(); return false;">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="request-details">
                        <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                    </div>
                    <div class="form-group">
                        <label for="admin-notes">ملاحظات المدير:</label>
                        <textarea id="admin-notes" rows="3" placeholder="اكتب ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-secondary" onclick="hideReviewRequestModal(); return false;">إلغاء</button>
                    <button class="btn-modal-success" onclick="approveAdRequest(); return false;">قبول</button>
                    <button class="btn-modal-danger" onclick="rejectAdRequest(); return false;">رفض</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // التحقق من تحميل adminSecurity
        let adminSecurityCheckStarted = false;
        
        function checkAdminSecurity() {
            if (adminSecurityCheckStarted) {
                return; // منع التكرار
            }
            
            if (!window.adminSecurity) {
                console.log('⏳ Waiting for adminSecurity to load...');
                adminSecurityCheckStarted = true;
                setTimeout(checkAdminSecurity, 100);
                return;
            }
            console.log('✅ adminSecurity loaded successfully');
        }
        
        // بدء التحقق عند تحميل الصفحة - مرة واحدة فقط
        setTimeout(checkAdminSecurity, 100);
        
        // تحميل البيانات عند تحميل الصفحة
        window.onload = async function() {
            // انتظار تحميل adminSecurity
            while (!window.adminSecurity) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            await loadDashboardData();
            await loadUserInfo();
            await loadRecentActivity();
            
            // استعادة حالة الصفحة المحفوظة
            restorePageState();
        };
        
        // نظام بديل لضمان عمل حفظ الحالة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - إعداد نظام حفظ الحالة');
            
            // تأخير قصير لضمان تحميل جميع العناصر
            setTimeout(() => {
                restorePageState();
            }, 500);
        });
        
        // مراقبة تغييرات الصفحة
        window.addEventListener('beforeunload', function() {
            console.log('حفظ الحالة قبل إغلاق الصفحة');
            // حفظ الحالة الحالية قبل إغلاق الصفحة
            const currentPanel = getCurrentActivePanel();
            if (currentPanel) {
                saveCurrentPageState(currentPanel);
            }
        });
        
        // مراقبة تغييرات الصفحة عند التحديث
        window.addEventListener('load', function() {
            console.log('تم تحميل الصفحة - محاولة استعادة الحالة');
            // محاولة إضافية لاستعادة الحالة
            setTimeout(() => {
                restorePageState();
            }, 1000);
        });
        
        // إضافة أزرار اختبار في Console
        window.testPageState = {
            save: function(page) {
                saveCurrentPageState(page);
                console.log(`تم حفظ حالة الصفحة: ${page}`);
            },
            restore: function() {
                restorePageState();
            },
            clear: function() {
                localStorage.removeItem('adminCurrentPage');
                localStorage.removeItem('adminPageTimestamp');
                console.log('تم مسح الحالة المحفوظة');
            },
            show: function() {
                const savedPage = localStorage.getItem('adminCurrentPage');
                const timestamp = localStorage.getItem('adminPageTimestamp');
                console.log('الحالة الحالية:', { savedPage, timestamp });
            }
        };
        
        console.log('🚀 نظام حفظ حالة الصفحة جاهز!');
        console.log('استخدم window.testPageState.save("advertising") لحفظ حالة');
        console.log('استخدم window.testPageState.restore() لاستعادة الحالة');
        console.log('استخدم window.testPageState.show() لعرض الحالة الحالية');

        // حساب إحصائيات الصور التفصيلية
        async function calculateImageStatistics() {
            try {
                let totalImages = 0;
                let productsWithImages = 0;
                let productsWithoutImages = 0;
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error: productsError } = await window.supabaseClient
                            .from(table)
                            .select('image_urls');
                        
                        if (!productsError && products) {
                            products.forEach(product => {
                                if (product.image_urls && Array.isArray(product.image_urls) && product.image_urls.length > 0) {
                                    totalImages += product.image_urls.length;
                                    productsWithImages++;
                                } else {
                                    productsWithoutImages++;
                                }
                            });
                        } else if (productsError) {
                            console.error(`Error loading images from ${table}:`, productsError);
                        }
                    } catch (tableError) {
                        console.error(`Error accessing table ${table}:`, tableError);
                    }
                }
                
                return {
                    totalImages,
                    productsWithImages,
                    productsWithoutImages,
                    averageImagesPerProduct: productsWithImages > 0 ? (totalImages / productsWithImages).toFixed(1) : 0
                };
            } catch (error) {
                console.error('Error calculating image statistics:', error);
                return {
                    totalImages: 0,
                    productsWithImages: 0,
                    productsWithoutImages: 0,
                    averageImagesPerProduct: 0
                };
            }
        }

        // تحميل بيانات لوحة الإدارة
        async function loadDashboardData() {
            try {
                // التأكد من وجود عميل Supabase
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    return;
                }

                // إحصائيات المستخدمين
                const { data: users, error: usersError } = await window.supabaseClient
                    .from('users')
                    .select('*');

                if (!usersError && users) {
                    document.getElementById('totalUsers').textContent = users.length;
                    document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'نشط').length;
                } else if (usersError) {
                    console.error('Error loading users:', usersError);
                }

                // إحصائيات المنتجات من جميع الجداول
                let totalProducts = 0;
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error: productsError } = await window.supabaseClient
                            .from(table)
                            .select('*');
                        
                        if (!productsError && products) {
                            totalProducts += products.length;
                        } else if (productsError) {
                            console.error(`Error loading ${table}:`, productsError);
                        }
                    } catch (tableError) {
                        console.error(`Error accessing table ${table}:`, tableError);
                    }
                }
                
                document.getElementById('totalProducts').textContent = totalProducts;
                
                // حساب إحصائيات الصور
                const imageStats = await calculateImageStatistics();
                document.getElementById('totalImages').textContent = imageStats.totalImages;
                document.getElementById('avgImagesPerProduct').textContent = imageStats.averageImagesPerProduct;
                
                // إضافة معلومات إضافية في console للمطورين
                console.log('📊 Image Statistics:', {
                    totalImages: imageStats.totalImages,
                    productsWithImages: imageStats.productsWithImages,
                    productsWithoutImages: imageStats.productsWithoutImages,
                    averageImagesPerProduct: imageStats.averageImagesPerProduct
                });

                // إحصائيات السجلات
                const { data: logs, error: logsError } = await window.supabaseClient
                    .from('admin_logs')
                    .select('*')
                    .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

                if (!logsError && logs) {
                    document.getElementById('recentLogs').textContent = logs.length;
                } else if (logsError) {
                    console.error('Error loading logs:', logsError);
                }

                // إحصائيات طلبات المنتجات
                try {
                    if (window.ProductRequestsService) {
                        const service = new window.ProductRequestsService();
                        await service.ensureInitialized();
                        const statsResult = await service.getRequestStatistics();
                        
                        if (statsResult.success) {
                            document.getElementById('pendingRequests').textContent = statsResult.data.pending;
                        }
                    }
                } catch (error) {
                    console.error('Error loading request statistics:', error);
                    document.getElementById('pendingRequests').textContent = '0';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // تحميل معلومات المستخدم
        async function loadUserInfo() {
            try {
                // انتظار تحميل adminSecurity
                while (!window.adminSecurity) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const currentUser = await adminSecurity.getCurrentUser();
                if (currentUser) {
                    const userInfoDiv = document.getElementById('userInfo');
                    userInfoDiv.innerHTML = `
                        <div class="user-name">${currentUser.fullName}</div>
                        <div class="user-role">${currentUser.role === 'admin' ? 'مدير' : 'محرر'}</div>
                    `;
                } else {
                    console.log('No current user found');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // تحميل النشاط الأخير
        async function loadRecentActivity() {
            try {
                // التأكد من وجود عميل Supabase
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    return;
                }

                const { data: logs, error } = await window.supabaseClient
                    .from('admin_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    throw error;
                }

                const activityList = document.getElementById('activityList');
                activityList.innerHTML = '';

                if (logs && logs.length > 0) {
                    logs.forEach(log => {
                        const activityItem = createActivityItem(log);
                        activityList.appendChild(activityItem);
                    });
                } else {
                    activityList.innerHTML = '<li class="activity-item">لا توجد أنشطة حديثة</li>';
                }

            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // إنشاء عنصر النشاط
        function createActivityItem(log) {
            const li = document.createElement('li');
            li.className = 'activity-item';

            const icons = {
                'admin_login': '🔐',
                'failed_login': '❌',
                'user_added': '➕',
                'user_deleted': '🗑️',
                'session_timeout': '⏰',
                'default': '📝'
            };

            const icon = icons[log.action] || icons.default;
            const actionText = getActionText(log.action);

            li.innerHTML = `
                <div class="activity-icon">${icon}</div>
                <div class="activity-content">
                    <div class="activity-title">${actionText}</div>
                    <div class="activity-time">${new Date(log.created_at).toLocaleString('ar-EG')}</div>
                </div>
            `;

            return li;
        }

        // ترجمة نوع النشاط
        function getActionText(action) {
            const actions = {
                'admin_login': 'تسجيل دخول مدير',
                'failed_login': 'محاولة تسجيل دخول فاشلة',
                'user_added': 'إضافة مستخدم جديد',
                'user_deleted': 'حذف مستخدم',
                'session_timeout': 'انتهاء مهلة الجلسة',
                'default': 'نشاط في النظام'
            };

            return actions[action] || actions.default;
        }

        // عرض التقارير
        function showReports() {
            navigateToRoute('reports');
            
            // إضافة زر العودة
            if (!document.getElementById('back-to-dashboard')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-dashboard';
                backBtn.className = 'nav-btn';
                backBtn.innerHTML = '🔙 العودة للوحة الرئيسية';
                backBtn.onclick = backToDashboard;
                document.querySelector('.header-content').appendChild(backBtn);
            }
        }

        // إخفاء جميع الأقسام
        function hideAllSections() {
            document.querySelector('.welcome-section').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.quick-actions').style.display = 'none';
            document.querySelector('.recent-activity').style.display = 'none';
            document.getElementById('advertising-panel').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            document.getElementById('product-requests-section').style.display = 'none';
        }

        // عرض طلبات المنتجات
        function showProductRequests() {
            // إخفاء جميع الأقسام الأخرى
            hideAllSections();
            
            // إظهار قسم طلبات المنتجات
            document.getElementById('product-requests-section').style.display = 'block';
            
            // إضافة زر العودة
            if (!document.getElementById('back-to-dashboard')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-to-dashboard';
                backBtn.className = 'nav-btn';
                backBtn.innerHTML = '🔙 العودة للوحة الرئيسية';
                backBtn.onclick = backToDashboard;
                document.querySelector('.header-content').appendChild(backBtn);
            }
            
            // تحميل طلبات المنتجات
            loadProductRequests();
            
            // تهيئة فلتر المدن
            setTimeout(() => {
                initializeEditRequestCitiesFilter();
            }, 100);
        }

        // العودة للوحة الرئيسية
        function backToDashboard() {
            // إزالة زر العودة
            const backBtn = document.getElementById('back-to-dashboard');
            if (backBtn) backBtn.remove();
            
            // العودة للصفحة الرئيسية
            showDashboardHome();
        }

        // عرض الصفحة الرئيسية للوحة
        function showDashboardHome() {
            // إخفاء جميع الأقسام
            hideAllSections();
            
            // إظهار الأقسام الرئيسية
            document.querySelector('.welcome-section').style.display = 'block';
            document.querySelector('.stats-grid').style.display = 'grid';
            document.querySelector('.quick-actions').style.display = 'grid';
            document.querySelector('.recent-activity').style.display = 'block';
            
            // تحديث المسار
            updateURL('dashboard');
            saveCurrentRoute('dashboard');
        }

        // تحديث URL بدون إعادة تحميل الصفحة
        function updateURL(route) {
            try {
                const newURL = `/admin/${route === 'dashboard' ? '' : route}`;
                window.history.pushState({ route }, 'لوحة التحكم', newURL);
                console.log(`تم تحديث URL إلى: ${newURL}`);
            } catch (error) {
                console.error('خطأ في تحديث URL:', error);
            }
        }

        // حفظ المسار الحالي في localStorage
        function saveCurrentRoute(route) {
            try {
                localStorage.setItem('adminCurrentRoute', route);
                localStorage.setItem('adminRouteTimestamp', Date.now().toString());
                console.log(`تم حفظ المسار: ${route}`);
            } catch (error) {
                console.error('خطأ في حفظ المسار:', error);
            }
        }

        // تحميل التقارير
        async function loadReports() {
            // إضافة مستمعي الأحداث لأزرار التقارير
            const reportButtons = document.querySelectorAll('[data-report]');
            reportButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // إزالة الفئة النشطة من جميع الأزرار
                    reportButtons.forEach(btn => btn.classList.remove('active'));
                    // إضافة الفئة النشطة للزر المحدد
                    this.classList.add('active');
                    
                    // تحميل التقرير المحدد
                    const reportType = this.getAttribute('data-report');
                    loadSpecificReport(reportType);
                });
            });
            
            // تحميل التقرير الافتراضي (المنتجات)
            loadSpecificReport('products');
        }

        // تحميل تقرير محدد
        async function loadSpecificReport(reportType) {
            const reportsContent = document.getElementById('reports-content');
            reportsContent.innerHTML = '<div class="text-center py-8">جاري تحميل التقرير...</div>';
            
            try {
                switch (reportType) {
                    case 'products':
                        await loadProductsReport();
                        break;
                    case 'users':
                        await loadUsersReport();
                        break;
                    case 'images':
                        await loadImagesReport();
                        break;
                    case 'performance':
                        await loadPerformanceReport();
                        break;
                    default:
                        reportsContent.innerHTML = '<div class="text-center py-8 text-gray-500">نوع التقرير غير معروف</div>';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                reportsContent.innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل التقرير</div>';
            }
        }

        // تقرير المنتجات
        async function loadProductsReport() {
            try {
                const reportsContent = document.getElementById('reports-content');
                let totalProducts = 0;
                let productsByCategory = {};
                let productsWithoutImages = 0;
                let recentProducts = [];
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                
                for (const table of tables) {
                    try {
                        const { data: products, error } = await window.supabaseClient
                            .from(table)
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (!error && products) {
                            const categoryName = getCategoryDisplayName(table);
                            productsByCategory[categoryName] = products.length;
                            totalProducts += products.length;
                            
                            // حساب المنتجات بدون صور
                            products.forEach(product => {
                                if (!product.image_urls || !Array.isArray(product.image_urls) || product.image_urls.length === 0) {
                                    productsWithoutImages++;
                                }
                            });
                            
                            // المنتجات المحدثة مؤخراً
                            recentProducts.push(...products.slice(0, 3));
                        }
                    } catch (error) {
                        console.error(`Error loading ${table}:`, error);
                    }
                }
                
                // ترتيب المنتجات حسب التاريخ
                recentProducts.sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
                recentProducts = recentProducts.slice(0, 5);
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📊 إحصائيات عامة</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي المنتجات:</span>
                                    <span class="font-bold text-blue-600">${totalProducts}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات بدون صور:</span>
                                    <span class="font-bold text-orange-600">${productsWithoutImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نسبة المنتجات مع صور:</span>
                                    <span class="font-bold text-green-600">${totalProducts > 0 ? ((totalProducts - productsWithoutImages) / totalProducts * 100).toFixed(1) : 0}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📂 المنتجات حسب التصنيف</h3>
                            <div class="space-y-3">
                                ${Object.entries(productsByCategory).map(([category, count]) => `
                                    <div class="flex justify-between">
                                        <span>${category}:</span>
                                        <span class="font-bold text-purple-600">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🕒 آخر التحديثات</h3>
                            <div class="space-y-2">
                                ${recentProducts.map(product => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-medium">${product.name || product.description || 'منتج'}</div>
                                        <div class="text-gray-600">${new Date(product.updated_at || product.created_at).toLocaleDateString('ar-EG')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                reportsContent.innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading products report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير المنتجات</div>';
            }
        }

        // تقرير المستخدمين
        async function loadUsersReport() {
            try {
                const { data: users, error } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const totalUsers = users.length;
                const activeUsers = users.filter(u => u.status === 'نشط').length;
                const newUsers = users.filter(u => {
                    const userDate = new Date(u.created_at);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return userDate > weekAgo;
                }).length;
                
                const recentUsers = users.slice(0, 5);
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">👥 إحصائيات المستخدمين</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي المستخدمين:</span>
                                    <span class="font-bold text-blue-600">${totalUsers}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المستخدمين النشطين:</span>
                                    <span class="font-bold text-green-600">${activeUsers}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المستخدمين الجدد (أسبوع):</span>
                                    <span class="font-bold text-purple-600">${newUsers}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📈 معدل النمو</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>نسبة المستخدمين النشطين:</span>
                                    <span class="font-bold text-green-600">${totalUsers > 0 ? (activeUsers / totalUsers * 100).toFixed(1) : 0}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>معدل التسجيل الأسبوعي:</span>
                                    <span class="font-bold text-blue-600">${newUsers}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🆕 آخر المستخدمين</h3>
                            <div class="space-y-2">
                                ${recentUsers.map(user => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-medium">${user.full_name || user.email}</div>
                                        <div class="text-gray-600">${new Date(user.created_at).toLocaleDateString('ar-EG')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading users report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير المستخدمين</div>';
            }
        }

        // تقرير الصور
        async function loadImagesReport() {
            try {
                const imageStats = await calculateImageStatistics();
                const tables = ['products_cake', 'products_koshat', 'products_mirr', 'products_other'];
                let imagesByCategory = {};
                
                // حساب الصور حسب التصنيف
                for (const table of tables) {
                    try {
                        const { data: products, error } = await window.supabaseClient
                            .from(table)
                            .select('image_urls');
                        
                        if (!error && products) {
                            const categoryName = getCategoryDisplayName(table);
                            let categoryImages = 0;
                            
                            products.forEach(product => {
                                if (product.image_urls && Array.isArray(product.image_urls)) {
                                    categoryImages += product.image_urls.length;
                                }
                            });
                            
                            imagesByCategory[categoryName] = categoryImages;
                        }
                    } catch (error) {
                        console.error(`Error loading images from ${table}:`, error);
                    }
                }
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🖼️ إحصائيات الصور</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>إجمالي الصور:</span>
                                    <span class="font-bold text-blue-600">${imageStats.totalImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات مع صور:</span>
                                    <span class="font-bold text-green-600">${imageStats.productsWithImages}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>المنتجات بدون صور:</span>
                                    <span class="font-bold text-orange-600">${imageStats.productsWithoutImages}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📸 الصور حسب التصنيف</h3>
                            <div class="space-y-3">
                                ${Object.entries(imagesByCategory).map(([category, count]) => `
                                    <div class="flex justify-between">
                                        <span>${category}:</span>
                                        <span class="font-bold text-purple-600">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">📊 متوسط الصور</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>متوسط الصور/منتج:</span>
                                    <span class="font-bold text-green-600">${imageStats.averageImagesPerProduct}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نسبة المنتجات مع صور:</span>
                                    <span class="font-bold text-blue-600">${(imageStats.productsWithImages + imageStats.productsWithoutImages) > 0 ? (imageStats.productsWithImages / (imageStats.productsWithImages + imageStats.productsWithoutImages) * 100).toFixed(1) : 0}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading images report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير الصور</div>';
            }
        }

        // تقرير الأداء
        async function loadPerformanceReport() {
            try {
                const pageLoadTime = performance.now();
                const memoryUsage = performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                } : null;
                
                const reportHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">⚡ أداء الصفحة</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>وقت التحميل:</span>
                                    <span class="font-bold text-blue-600">${pageLoadTime.toFixed(2)}ms</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>تاريخ التقرير:</span>
                                    <span class="font-bold text-green-600">${new Date().toLocaleDateString('ar-EG')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">💾 استخدام الذاكرة</h3>
                            <div class="space-y-3">
                                ${memoryUsage ? `
                                    <div class="flex justify-between">
                                        <span>الذاكرة المستخدمة:</span>
                                        <span class="font-bold text-blue-600">${memoryUsage.used} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>إجمالي الذاكرة:</span>
                                        <span class="font-bold text-green-600">${memoryUsage.total} MB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>حد الذاكرة:</span>
                                        <span class="font-bold text-purple-600">${memoryUsage.limit} MB</span>
                                    </div>
                                ` : '<div class="text-gray-500">معلومات الذاكرة غير متوفرة</div>'}
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-center">🔧 معلومات النظام</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>المتصفح:</span>
                                    <span class="font-bold text-blue-600">${navigator.userAgent.split(' ').pop()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>نظام التشغيل:</span>
                                    <span class="font-bold text-green-600">${navigator.platform}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>اللغة:</span>
                                    <span class="font-bold text-purple-600">${navigator.language}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reports-content').innerHTML = reportHTML;
                
            } catch (error) {
                console.error('Error loading performance report:', error);
                document.getElementById('reports-content').innerHTML = '<div class="text-center py-8 text-red-500">خطأ في تحميل تقرير الأداء</div>';
            }
        }

        // دالة مساعدة للحصول على اسم التصنيف المعروض
        function getCategoryDisplayName(tableName) {
            const categoryMap = {
                'products_cake': 'تورتات',
                'products_koshat': 'كوشات',
                'products_mirr': 'مرايا',
                'products_other': 'ديكورات متنوعة'
            };
            return categoryMap[tableName] || tableName;
        }

        // تحميل طلبات المنتجات
        async function loadProductRequests(status = 'all') {
            try {
                // التأكد من وجود ProductRequestsService
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                let result;
                if (status === 'all') {
                    result = await service.getAllProductRequests();
                } else {
                    result = await service.getProductRequestsByStatus(status);
                }

                if (result.success) {
                    displayProductRequests(result.data, status);
                } else {
                    console.error('Error loading product requests:', result.error);
                }
            } catch (error) {
                console.error('Error in loadProductRequests:', error);
            }
        }

        // عرض طلبات المنتجات
        function displayProductRequests(requests, status) {
            const requestsList = document.getElementById('requests-list');
            const noRequestsMessage = document.getElementById('no-requests-message');

            if (!requests || requests.length === 0) {
                requestsList.style.display = 'none';
                noRequestsMessage.style.display = 'block';
                return;
            }

            requestsList.style.display = 'block';
            noRequestsMessage.style.display = 'none';

            // تخزين البيانات للوصول إليها لاحقاً (مع دعم التعديلات)
            if (!window.currentRequests) {
                window.currentRequests = [];
            }
            
            // دمج الطلبات الجديدة مع الموجودة (للحفاظ على التعديلات)
            requests.forEach(newRequest => {
                const existingIndex = window.currentRequests.findIndex(r => r.id == newRequest.id);
                if (existingIndex !== -1) {
                    // تحديث الطلب الموجود مع الحفاظ على التعديلات
                    window.currentRequests[existingIndex] = {
                        ...window.currentRequests[existingIndex],
                        ...newRequest,
                        // الحفاظ على الحقول المُعدلة
                        description: window.currentRequests[existingIndex].description || newRequest.description,
                        price: window.currentRequests[existingIndex].price || newRequest.price,
                        category: window.currentRequests[existingIndex].category || newRequest.category,
                        subcategory: window.currentRequests[existingIndex].subcategory || newRequest.subcategory,
                        governorate: window.currentRequests[existingIndex].governorate || newRequest.governorate,
                        cities: window.currentRequests[existingIndex].cities || newRequest.cities,
                        whatsapp: window.currentRequests[existingIndex].whatsapp || newRequest.whatsapp,
                        facebook: window.currentRequests[existingIndex].facebook || newRequest.facebook,
                        instagram: window.currentRequests[existingIndex].instagram || newRequest.instagram,
                        image_urls: window.currentRequests[existingIndex].image_urls || newRequest.image_urls
                    };
                } else {
                    // إضافة طلب جديد
                    window.currentRequests.push(newRequest);
                }
            });

            // عرض الطلبات المُحدثة
            requestsList.innerHTML = window.currentRequests.map(request => createRequestCard(request)).join('');

            // إضافة مستمعي الأحداث للأزرار
            addRequestEventListeners();
        }

        // إنشاء بطاقة طلب
        function createRequestCard(request) {
            const statusClass = `status-${request.status}`;
            const statusText = getStatusText(request.status);
            const createdAt = new Date(request.created_at).toLocaleString('ar-EG');

            // معالجة التصنيف الفرعي - دعم البيانات المُعدلة
            let subcategoryDisplay = 'غير محدد';
            if (request.subcategory) {
                if (Array.isArray(request.subcategory)) {
                    subcategoryDisplay = request.subcategory.join(', ');
                } else if (typeof request.subcategory === 'string') {
                    try {
                        const parsed = JSON.parse(request.subcategory);
                        if (Array.isArray(parsed)) {
                            subcategoryDisplay = parsed.join(', ');
                        } else {
                            subcategoryDisplay = parsed || 'غير محدد';
                        }
                    } catch (e) {
                        subcategoryDisplay = request.subcategory;
                    }
                }
            }

            // معالجة السعر - دعم البيانات المُعدلة
            let priceDisplay = 'السعر عند الطلب';
            if (request.price) {
                if (typeof request.price === 'number' && request.price > 0) {
                    priceDisplay = request.price + ' ج.م';
                } else if (typeof request.price === 'string' && request.price.trim() !== '') {
                    priceDisplay = request.price + ' ج.م';
                }
            }

            // معالجة المحافظات - دعم البيانات المُعدلة
            let governorateDisplay = 'غير محدد';
            if (request.governorate) {
                if (Array.isArray(request.governorate)) {
                    governorateDisplay = request.governorate.join(', ');
                } else if (typeof request.governorate === 'string') {
                    governorateDisplay = request.governorate;
                }
            }

            return `
                <div class="request-card" data-request-id="${request.id}">
                    <div class="request-header">
                        <h3 class="font-semibold text-lg">طلب إضافة منتج</h3>
                        <span class="request-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>التصنيف:</strong> ${getCategoryName(request.category)}</p>
                            <p><strong>التصنيف الفرعي:</strong> ${subcategoryDisplay}</p>
                            <p><strong>الوصف:</strong> ${request.description || 'غير محدد'}</p>
                            <p><strong>السعر:</strong> ${priceDisplay}</p>
                            <p><strong>المحافظات:</strong> ${governorateDisplay}</p>
                            <p><strong>تاريخ الطلب:</strong> ${createdAt}</p>
                        </div>
                        
                        <div>
                            <p><strong>الواتساب:</strong> ${request.whatsapp || 'غير محدد'}</p>
                            <p><strong>فيسبوك:</strong> ${request.facebook || 'غير محدد'}</p>
                            <p><strong>إنستجرام:</strong> ${request.instagram || 'غير محدد'}</p>
                        </div>
                    </div>
                    
                    ${request.image_urls && request.image_urls.length > 0 ? `
                        <div class="request-images">
                            ${request.image_urls.map(img => `
                                <img src="${img.url || img}" alt="صورة المنتج" class="request-image">
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="request-actions">
                        <button class="btn-view" onclick="viewRequestDetails('${request.id}')">عرض التفاصيل</button>
                        ${request.status === 'pending' ? `
                            <button class="btn-edit" onclick="editRequest('${request.id}')">تعديل</button>
                            <button class="btn-approve" onclick="approveRequest('${request.id}')">موافقة</button>
                            <button class="btn-reject" onclick="rejectRequest('${request.id}')">رفض</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // إضافة مستمعي الأحداث
        function addRequestEventListeners() {
            // مستمعي أحداث أزرار الفلتر
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // إزالة الفئة النشطة من جميع الأزرار
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    // إضافة الفئة النشطة للزر المحدد
                    this.classList.add('active');
                    
                    // تحميل الطلبات حسب الحالة
                    const status = this.getAttribute('data-status');
                    loadProductRequests(status);
                });
            });
        }

        // عرض تفاصيل الطلب
        function viewRequestDetails(requestId) {
            try {
                console.log('Viewing details for request:', requestId);
                
                // البحث عن الطلب في القائمة المعروضة
                const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
                if (!requestCard) {
                    console.warn('Request card not found in DOM');
                }

                // الحصول على بيانات الطلب من البيانات المخزنة
                const requestData = getRequestDataById(requestId);
                if (!requestData) {
                    alert('لم يتم العثور على بيانات الطلب. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                    return;
                }

                console.log('Request data retrieved:', requestData);

                // عرض النافذة المنبثقة
                showRequestDetailsModal(requestData);
            } catch (error) {
                console.error('Error in viewRequestDetails:', error);
                alert('حدث خطأ أثناء عرض تفاصيل الطلب. يرجى المحاولة مرة أخرى.');
            }
        }

        // الحصول على بيانات الطلب بواسطة ID
        function getRequestDataById(requestId) {
            // البحث في الطلبات المعروضة حالياً
            const requestsList = document.getElementById('requests-list');
            const requestCard = requestsList.querySelector(`[data-request-id="${requestId}"]`);
            
            if (requestCard) {
                // استخراج البيانات من البطاقة المعروضة
                return extractRequestDataFromCard(requestCard);
            }
            
            // إذا لم نجد البطاقة، نحاول البحث في البيانات المخزنة
            if (window.currentRequests && window.currentRequests.length > 0) {
                const storedRequest = window.currentRequests.find(req => req.id == requestId);
                if (storedRequest) {
                    return formatRequestData(storedRequest);
                }
            }
            
            return null;
        }

        // دالة محسنة للحصول على بيانات الطلب مع دعم التعديلات
        function getRequestDataForEdit(requestId) {
            // البحث في البيانات المخزنة أولاً (أحدث البيانات)
            if (window.currentRequests && window.currentRequests.length > 0) {
                const storedRequest = window.currentRequests.find(req => req.id == requestId);
                if (storedRequest) {
                    console.log('🔍 Found request in currentRequests:', storedRequest);
                    return storedRequest;
                }
            }
            
            // إذا لم نجد في البيانات المخزنة، نحاول البحث في قاعدة البيانات
            console.log('🔍 Request not found in currentRequests, searching in database...');
            return null;
        }

        // تنسيق بيانات الطلب
        function formatRequestData(request) {
            try {
                const createdAt = new Date(request.created_at).toLocaleString('ar-EG');
                const statusText = getStatusText(request.status);
                const categoryName = getCategoryName(request.category);
                
                // معالجة السعر - دعم البيانات المُعدلة
                let priceText = 'السعر عند الطلب';
                if (request.price) {
                    if (typeof request.price === 'number' && request.price > 0) {
                        priceText = request.price + ' ج.م';
                    } else if (typeof request.price === 'string' && request.price.trim() !== '') {
                        priceText = request.price + ' ج.م';
                    }
                }
                
                // معالجة التصنيف الفرعي - دعم البيانات المُعدلة
                let subcategoryText = 'غير محدد';
                if (request.subcategory) {
                    if (Array.isArray(request.subcategory)) {
                        subcategoryText = request.subcategory.join(', ');
                    } else if (typeof request.subcategory === 'string') {
                        try {
                            const parsed = JSON.parse(request.subcategory);
                            if (Array.isArray(parsed)) {
                                subcategoryText = parsed.join(', ');
                            } else {
                                subcategoryText = parsed || 'غير محدد';
                            }
                        } catch (e) {
                            subcategoryText = request.subcategory;
                        }
                    }
                }
                
                return {
                    id: request.id,
                    description: request.description || 'غير محدد',
                    category: categoryName,
                    subcategory: subcategoryText,
                    price: priceText,
                    governorate: request.governorate || 'غير محدد',
                    cities: request.cities || 'غير محدد',
                    whatsapp: request.whatsapp || 'غير محدد',
                    facebook: request.facebook || 'غير محدد',
                    instagram: request.instagram || 'غير محدد',
                    status: statusText,
                    created_at: createdAt,
                    image_urls: request.image_urls || []
                };
            } catch (error) {
                console.error('Error formatting request data:', error);
                return null;
            }
        }

        // استخراج بيانات الطلب من البطاقة المعروضة
        function extractRequestDataFromCard(requestCard) {
            try {
                // البحث عن جميع الفقرات في البطاقة
                const paragraphs = requestCard.querySelectorAll('p');
                const requestData = {
                    id: requestCard.getAttribute('data-request-id'),
                    description: 'غير محدد',
                    category: 'غير محدد',
                    subcategory: 'غير محدد',
                    price: 'غير محدد',
                    governorate: 'غير محدد',
                    cities: 'غير محدد',
                    whatsapp: 'غير محدد',
                    facebook: 'غير محدد',
                    instagram: 'غير محدد',
                    status: 'غير محدد',
                    created_at: 'غير محدد',
                    image_urls: []
                };

                // البحث في الفقرات عن البيانات
                paragraphs.forEach(p => {
                    const text = p.textContent || '';
                    const strong = p.querySelector('strong');
                    
                    if (strong) {
                        const label = strong.textContent.trim();
                        const value = p.textContent.replace(label, '').trim();
                        
                        if (label.includes('الوصف')) {
                            requestData.description = value;
                        } else if (label.includes('التصنيف:')) {
                            requestData.category = value;
                        } else if (label.includes('التصنيف الفرعي:')) {
                            requestData.subcategory = value;
                        } else if (label.includes('السعر')) {
                            requestData.price = value;
                        } else if (label.includes('المحافظات')) {
                            requestData.governorate = value;
                        } else if (label.includes('المناطق') || label.includes('المدن')) {
                            requestData.cities = value;
                        } else if (label.includes('الواتساب')) {
                            requestData.whatsapp = value;
                        } else if (label.includes('فيسبوك')) {
                            requestData.facebook = value;
                        } else if (label.includes('إنستجرام')) {
                            requestData.instagram = value;
                        } else if (label.includes('تاريخ الطلب')) {
                            requestData.created_at = value;
                        }
                    }
                });

                // البحث عن الحالة
                const statusElement = requestCard.querySelector('.request-status');
                if (statusElement) {
                    requestData.status = statusElement.textContent.trim();
                }

                // استخراج الصور
                const images = requestCard.querySelectorAll('.request-image');
                images.forEach(img => {
                    requestData.image_urls.push({
                        url: img.src,
                        original_name: img.alt
                    });
                });

                console.log('Extracted request data:', requestData);
                return requestData;
            } catch (error) {
                console.error('Error extracting request data:', error);
                return null;
            }
        }

        // عرض النافذة المنبثقة لتفاصيل الطلب
        function showRequestDetailsModal(requestData) {
            const modal = document.getElementById('request-details-modal');
            const content = document.getElementById('request-details-content');

            // إنشاء محتوى التفاصيل
            content.innerHTML = createRequestDetailsHTML(requestData);

            // عرض النافذة
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // إنشاء HTML لتفاصيل الطلب
        function createRequestDetailsHTML(requestData) {
            const statusClass = `status-${requestData.status === 'في الانتظار' ? 'pending' : requestData.status === 'تمت الموافقة' ? 'approved' : 'rejected'}`;
            
            return `
                <div class="request-detail-item">
                    <span class="request-detail-label">رقم الطلب:</span>
                    <span class="request-detail-value">#${requestData.id}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">الحالة:</span>
                    <span class="request-detail-value">
                        <span class="request-status ${statusClass}">${requestData.status}</span>
                    </span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">التصنيف:</span>
                    <span class="request-detail-value">${requestData.category}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">الوصف:</span>
                    <span class="request-detail-value">${requestData.description}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">السعر:</span>
                    <span class="request-detail-value">${requestData.price}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">المحافظات:</span>
                    <span class="request-detail-value">${requestData.governorate}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رقم الواتساب:</span>
                    <span class="request-detail-value">${requestData.whatsapp}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رابط الفيسبوك:</span>
                    <span class="request-detail-value">${requestData.facebook}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">رابط الإنستجرام:</span>
                    <span class="request-detail-value">${requestData.instagram}</span>
                </div>
                
                <div class="request-detail-item">
                    <span class="request-detail-label">تاريخ الطلب:</span>
                    <span class="request-detail-value">${requestData.created_at}</span>
                </div>
                
                ${requestData.image_urls && requestData.image_urls.length > 0 ? `
                    <div class="request-detail-item">
                        <span class="request-detail-label">الصور المرفقة:</span>
                        <div class="request-images-grid">
                            ${requestData.image_urls.map((img, index) => {
                                const imageUrl = typeof img === 'string' ? img : (img.url || img);
                                return `
                                    <div class="request-image-item">
                                        <img src="${imageUrl}" alt="صورة ${index + 1}" loading="lazy" onerror="this.style.display='none'">
                                        <div class="request-image-overlay">
                                            <button onclick="openImageInNewTab('${imageUrl}')">عرض</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // فتح الصورة في تبويب جديد
        function openImageInNewTab(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        // إغلاق نافذة تفاصيل الطلب
        function closeRequestDetails() {
            const modal = document.getElementById('request-details-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // إغلاق النافذة عند النقر خارجها
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('request-details-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRequestDetails();
                    }
                });
            }
        });

        // إغلاق النافذة عند الضغط على ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('request-details-modal');
                if (modal && modal.style.display !== 'none') {
                    closeRequestDetails();
                }
                
                const editModal = document.getElementById('edit-ad-modal');
                if (editModal && editModal.style.display !== 'none') {
                    hideEditAdModal();
                }
            }
        });

        // إغلاق نوافذ الإعلانات عند النقر خارجها
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('edit-ad-modal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === editModal) {
                        hideEditAdModal();
                    }
                });
            }
        });

        // تعديل الطلب
        function editRequest(requestId) {
            console.log('🔍 [DEBUG] ===== STARTING editRequest =====');
            console.log('🔍 [DEBUG] Request ID:', requestId);

            // البحث عن الطلب في القائمة المعروضة
            const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
            if (!requestCard) {
                console.warn('Request card not found in DOM');
            }

            // الحصول على بيانات الطلب من البيانات المخزنة (أحدث البيانات)
            const requestData = getRequestDataForEdit(requestId);
            if (!requestData) {
                alert('لم يتم العثور على بيانات الطلب. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                return;
            }

            console.log('🔍 [DEBUG] ✅ Request data retrieved for edit:', requestData);

            // عرض النافذة المنبثقة للتعديل
            showEditRequestModal(requestData);
        }

        // عرض نافذة تعديل الطلب
        function showEditRequestModal(requestData) {
            console.log('🔍 [DEBUG] ===== STARTING showEditRequestModal =====');
            console.log('🔍 [DEBUG] Request data for edit:', requestData);

            // ملء النموذج بالبيانات الحالية
            document.getElementById('edit-request-id').value = requestData.id;
            document.getElementById('edit-request-description').value = requestData.description || '';
            
            // معالجة السعر - إزالة "ج.م" إذا كان موجوداً
            let priceValue = requestData.price || '';
            if (typeof priceValue === 'string' && priceValue.includes('ج.م')) {
                priceValue = priceValue.replace('ج.م', '').trim();
            }
            document.getElementById('edit-request-price').value = priceValue;
            
            // معالجة الفئة - تحويل من العربية إلى الإنجليزية
            let categoryValue = requestData.category || 'koshat';
            if (typeof categoryValue === 'string') {
                const categoryMap = {
                    'كوشات': 'koshat',
                    'مرايا': 'mirr',
                    'تورتة': 'cake',
                    'ديكورات متنوعة': 'other',
                    'دعوات وتوزيعات': 'invitations'
                };
                categoryValue = categoryMap[categoryValue] || categoryValue;
            }
            document.getElementById('edit-request-category').value = categoryValue;
            
            document.getElementById('edit-request-whatsapp').value = requestData.whatsapp || '';
            document.getElementById('edit-request-facebook').value = requestData.facebook || '';
            document.getElementById('edit-request-instagram').value = requestData.instagram || '';

            // ملء المحافظات
            let governorates = [];
            if (requestData.governorate && requestData.governorate !== 'غير محدد') {
                if (Array.isArray(requestData.governorate)) {
                    governorates = requestData.governorate;
                } else if (typeof requestData.governorate === 'string') {
                    try {
                        if (requestData.governorate.startsWith('[') && requestData.governorate.endsWith(']')) {
                            const parsed = JSON.parse(requestData.governorate);
                            if (Array.isArray(parsed)) {
                                governorates = parsed;
                            }
                        }
                    } catch (e) {
                        console.log('🔍 JSON parsing failed for governorate, treating as regular string');
                    }
                    
                    if (governorates.length === 0) {
                        if (requestData.governorate.includes(',')) {
                            governorates = requestData.governorate.split(',').map(item => item.trim()).filter(item => item && item !== 'null' && item !== '');
                        } else if (requestData.governorate !== 'null' && requestData.governorate !== '') {
                            governorates = [requestData.governorate];
                        }
                    }
                }
            }
            populateEditRequestGovernorates(governorates);

            // ملء التصنيفات الفرعية
            let subcategories = [];
            if (requestData.subcategory && requestData.subcategory !== 'غير محدد') {
                if (Array.isArray(requestData.subcategory)) {
                    subcategories = requestData.subcategory;
                } else if (typeof requestData.subcategory === 'string') {
                    try {
                        const parsed = JSON.parse(requestData.subcategory);
                        if (Array.isArray(parsed)) {
                            subcategories = parsed;
                        } else {
                            subcategories = [parsed];
                        }
                    } catch (e) {
                        if (requestData.subcategory.includes(',')) {
                            subcategories = requestData.subcategory.split(',').map(item => item.trim()).filter(item => item && item !== 'null' && item !== '');
                        } else {
                            subcategories = [requestData.subcategory];
                        }
                    }
                }
            }
            populateEditRequestSubcategories(requestData.category, subcategories);

            // ملء المدن
            let cities = [];
            if (requestData.cities && requestData.cities !== 'غير محدد') {
                if (Array.isArray(requestData.cities)) {
                    cities = requestData.cities;
                } else if (typeof requestData.cities === 'string') {
                    try {
                        if (requestData.cities.startsWith('[') && requestData.cities.endsWith(']')) {
                            const parsed = JSON.parse(requestData.cities);
                            if (Array.isArray(parsed)) {
                                cities = parsed;
                            }
                        }
                    } catch (e) {
                        if (requestData.cities.includes(',')) {
                            cities = requestData.cities.split(',').map(item => item.trim()).filter(item => item && item !== 'null' && item !== '');
                        } else if (requestData.cities !== 'null' && requestData.cities !== '') {
                            cities = [requestData.cities];
                        }
                    }
                }
            }
            populateEditRequestCities(governorates, cities);

            // عرض الصور الحالية
            let imageUrls = [];
            if (requestData.image_urls && requestData.image_urls.length > 0) {
                imageUrls = requestData.image_urls.map(img => img.url || img);
            }
            displayEditRequestCurrentImages(imageUrls);

            console.log('🔍 [DEBUG] ===== showEditRequestModal COMPLETED =====');

            // عرض النافذة المنبثقة
            document.getElementById('editRequestModal').style.display = 'block';
            
            // تهيئة فلتر المدن عند فتح النافذة
            setTimeout(() => {
                initializeEditRequestCitiesFilter();
            }, 100);
        }

        // الموافقة على الطلب
        async function approveRequest(requestId) {

            try {
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                // الحصول على أحدث بيانات الطلب (بعد التعديلات)
                const currentRequest = window.currentRequests.find(r => r.id == requestId);
                if (!currentRequest) {
                    alert('لم يتم العثور على بيانات الطلب. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                    return;
                }

                console.log('🔍 [DEBUG] Approving request with latest data:', currentRequest);

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                // تمرير البيانات المُعدلة للموافقة
                const result = await service.approveProductRequest(requestId, currentRequest);
                if (result.success) {
                    // إعادة تحميل الطلبات مباشرة
                    loadProductRequests();
                    loadDashboardData();
                } else {
                    alert('خطأ في قبول المنتج: ' + result.error);
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert('حدث خطأ أثناء قبول المنتج');
            }
        }

        // رفض الطلب
        async function rejectRequest(requestId) {
            if (!confirm('هل أنت متأكد من حذف المنتج؟')) {
                return;
            }
            
            try {
                if (!window.ProductRequestsService) {
                    console.error('ProductRequestsService not available');
                    return;
                }

                // الحصول على أحدث بيانات الطلب (بعد التعديلات)
                const currentRequest = window.currentRequests.find(r => r.id == requestId);
                if (!currentRequest) {
                    alert('لم يتم العثور على بيانات الطلب. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                    return;
                }

                console.log('🔍 [DEBUG] Rejecting request with latest data:', currentRequest);

                const service = new window.ProductRequestsService();
                await service.ensureInitialized();

                // تمرير البيانات المُعدلة للرفض
                const result = await service.rejectProductRequest(requestId, currentRequest);
                if (result.success) {
                    alert('تم حذف المنتج بنجاح');
                    // إعادة تحميل الطلبات
                    loadProductRequests();
                    // تحديث الإحصائيات
                    loadDashboardData();
                } else {
                    alert('خطأ في حذف المنتج: ' + result.error);
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('حدث خطأ أثناء حذف المنتج');
            }
        }

        // الحصول على نص الحالة
        function getStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'approved': 'تمت الموافقة',
                'rejected': 'مرفوض',
                'processing': 'قيد المعالجة',
                'completed': 'مكتمل'
            };
            return statusMap[status] || status;
        }

        // الحصول على اسم التصنيف
        function getCategoryName(category) {
            const categoryMap = {
                'koshat': 'كوشات',
                'mirr': 'مرايا',
                'cake': 'تورتة',
                'other': 'ديكورات متنوعة',
                'invitations': 'دعوات وتوزيعات'
            };
            return categoryMap[category] || category;
        }

        // ===== دوال تعديل الطلب =====

        // ملء المحافظات في نموذج التعديل
        function populateEditRequestGovernorates(selectedGovernorates) {
            const governorates = [
                "القاهرة","الجيزة","الإسكندرية","الشرقية","الغربية","المنوفية","القليوبية","البحيرة","كفر الشيخ","دمياط","الدقهلية","المنيا","أسيوط","سوهاج","قنا","الأقصر","أسوان","بني سويف","الفيوم","الوادي الجديد","شمال سيناء","جنوب سيناء","البحر الأحمر","مطروح","بورسعيد","الإسماعيلية","السويس"
            ];
            
            let selected = [];
            if (selectedGovernorates && selectedGovernorates !== '' && selectedGovernorates !== 'null') {
                if (Array.isArray(selectedGovernorates)) {
                    selected = selectedGovernorates;
                } else if (typeof selectedGovernorates === 'string') {
                    try {
                        if (selectedGovernorates.startsWith('[') && selectedGovernorates.endsWith(']')) {
                            const parsed = JSON.parse(selectedGovernorates);
                            if (Array.isArray(parsed)) {
                                selected = parsed;
                            }
                        }
                    } catch (e) {
                        console.log('🔍 JSON parsing failed for governorates, treating as regular string');
                    }
                    
                    if (selected.length === 0) {
                        if (selectedGovernorates.includes(',')) {
                            selected = selectedGovernorates.split(',').map(item => item.trim()).filter(item => item && item !== 'null' && item !== '');
                        } else if (selectedGovernorates !== 'null' && selectedGovernorates !== '') {
                            selected = [selectedGovernorates];
                        }
                    }
                }
            }
            
            console.log('🔍 Processed selected governorates for edit:', selected);
            
            const container = document.getElementById('edit-request-governorate-checkboxes');
            if (container) {
                container.innerHTML = governorates.map(gov => `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 5px; cursor: pointer;">
                        <input type="checkbox" value="${gov}" ${selected.includes(gov) ? 'checked' : ''} style="width: 16px; height: 16px;">
                        <span style="font-size: 14px;">${gov}</span>
                    </label>
                `).join('');

                // إضافة مستمعي الأحداث لتحديث المدن عند تغيير المحافظات
                const governorateCheckboxes = container.querySelectorAll('input[type="checkbox"]');
                governorateCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const selectedGovernorates = [];
                        governorateCheckboxes.forEach(cb => {
                            if (cb.checked) {
                                selectedGovernorates.push(cb.value);
                            }
                        });
                        
                        // تحديث المدن بناءً على المحافظات المختارة
                        populateEditRequestCities(selectedGovernorates, []);
                    });
                });
            } else {
                console.error('❌ edit-request-governorate-checkboxes container not found');
            }
        }

        // ملء التصنيفات الفرعية في نموذج التعديل
        function populateEditRequestSubcategories(category, selectedSubcategory) {
            console.log('🔍 [DEBUG] ===== STARTING populateEditRequestSubcategories =====');
            console.log('🔍 [DEBUG] Category:', category);
            console.log('🔍 [DEBUG] Selected subcategory data:', selectedSubcategory);

            const subcategories = {
                'koshat': [
                    { value: 'كوشات زفاف', label: 'كوشات زفاف' },
                    { value: 'كوشات خطوبة', label: 'كوشات خطوبة' }
                ],
                'mirr': [
                    { value: 'مرايا زفاف', label: 'مرايا زفاف' },
                    { value: 'مرايا خطوبة', label: 'مرايا خطوبة' },
                    { value: 'مرايا ديكور', label: 'مرايا ديكور' }
                ],
                'cake': [
                    { value: 'تورتة زفاف', label: 'تورتة زفاف' },
                    { value: 'تورتة خطوبة', label: 'تورتة خطوبة' },
                    { value: 'تورتة عيد ميلاد', label: 'تورتة عيد ميلاد' },
                    { value: 'تورتة شوكولاتة', label: 'تورتة شوكولاتة' },
                    { value: 'تورتة فواكه', label: 'تورتة فواكه' },
                    { value: 'صينية شوكولاتة', label: 'صينية شوكولاتة' }
                ],
                'other': [
                    { value: 'ديكور عيد ميلاد', label: 'ديكور عيد ميلاد' },
                    { value: 'استقبال المولود بالمستشفى', label: 'استقبال المولود بالمستشفى' },
                    { value: 'ديكور استقبال عروسة', label: 'ديكور استقبال عروسة' },
                    { value: 'ديكور حفلات بسيطة', label: 'ديكور حفلات بسيطة' }
                ],
                'invitations': [
                    { value: 'دعوة زفاف', label: 'دعوة زفاف' },
                    { value: 'دعوة خطوبة', label: 'دعوة خطوبة' },
                    { value: 'توزيعات فرح', label: 'توزيعات فرح' },
                    { value: 'توزيعات خطوبة', label: 'توزيعات خطوبة' },
                    { value: 'توزيعات بالشوكولاتة', label: 'توزيعات بالشوكولاتة' },
                    { value: 'توزيعات بالعطور / البرفان', label: 'توزيعات بالعطور / البرفان' },
                    { value: 'توزيعات مع هدية صغيره', label: 'توزيعات مع هدية صغيره' },
                    { value: 'توزيعات سبوع', label: 'توزيعات سبوع' },
                    { value: 'توزيعات أطفال', label: 'توزيعات أطفال' },
                    { value: 'توزيعات ورد', label: 'توزيعات ورد' },
                    { value: 'توزيعات شموع', label: 'توزيعات شموع' },
                    { value: 'دعوة رقمية', label: 'دعوة رقمية' }
                ]
            };
            
            const categorySubs = subcategories[category] || [];
            
            let selected = [];
            if (selectedSubcategory && selectedSubcategory !== '' && selectedSubcategory !== 'null') {
                if (Array.isArray(selectedSubcategory)) {
                    selected = selectedSubcategory;
                } else if (typeof selectedSubcategory === 'string') {
                    try {
                        const parsed = JSON.parse(selectedSubcategory);
                        if (Array.isArray(parsed)) {
                            selected = parsed;
                        } else {
                            selected = [parsed];
                        }
                    } catch (e) {
                        if (selectedSubcategory.includes(',')) {
                            selected = selectedSubcategory.split(',').map(item => item.trim()).filter(item => item && item !== 'null' && item !== '');
                        } else {
                            selected = [selectedSubcategory];
                        }
                    }
                }
            }
            
            console.log('🔍 Processed selected subcategories for edit:', selected);
            
            const container = document.getElementById('edit-request-subcategory-checkboxes');
            if (container) {
                container.innerHTML = categorySubs.map(sub => {
                    const isChecked = selected.includes(sub.value);
                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 5px; cursor: pointer;">
                            <input type="checkbox" value="${sub.value}" ${isChecked ? 'checked' : ''} style="width: 16px; height: 16px;">
                            <span style="font-size: 14px;">${sub.label}</span>
                        </label>
                    `;
                }).join('');
                console.log('🔍 [DEBUG] ✅ Successfully populated subcategory checkboxes for edit');
            } else {
                console.error('🔍 [DEBUG] ❌ edit-request-subcategory-checkboxes container not found');
            }
        }

        // معالجة تسجيل الخروج
        async function handleLogout() {
            try {
                // انتظار تحميل adminSecurity
                while (!window.adminSecurity) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('🔄 بدء عملية تسجيل الخروج...');
                await adminSecurity.logout();
            } catch (error) {
                console.error('❌ خطأ في تسجيل الخروج:', error);
                // التوجيه المباشر في حالة الخطأ
                window.location.href = 'admin-login.html';
            }
        }

        // ===== باقي دوال تعديل الطلب =====

        // ملء المدن في نموذج التعديل
        function populateEditRequestCities(selectedGovernorates, currentCities) {
            console.log('🔍 PopulateEditRequestCities called with:', { selectedGovernorates, currentCities });
            
            const citiesList = document.getElementById('edit-request-cities-list');
            const citiesTrigger = document.getElementById('edit-request-cities-trigger');
            const citiesSearch = document.getElementById('edit-request-cities-search');

            if (!citiesList || !citiesTrigger || !citiesSearch) {
                console.error('❌ Cities elements not found in populateEditRequestCities');
                return;
            }

            // مسح الاختيارات السابقة
            if (typeof editRequestSelectedCities !== 'undefined') {
                editRequestSelectedCities.clear();
            }

            if (!selectedGovernorates || selectedGovernorates.length === 0) {
                // إخفاء فلتر المدن إذا لم يتم اختيار محافظات
                citiesList.innerHTML = '<div style="padding: 16px; text-align: center; color: #666;">اختر المحافظات أولاً</div>';
                updateEditRequestCitiesDisplay();
                return;
            }

            // الحصول على جميع المدن للمحافظات المختارة
            let allCities = [];
            selectedGovernorates.forEach(governorate => {
                if (typeof editRequestCitiesService !== 'undefined' && editRequestCitiesService.getCitiesForGovernorate) {
                    const cities = editRequestCitiesService.getCitiesForGovernorate(governorate);
                    allCities = allCities.concat(cities);
                }
            });

            // إزالة التكرار
            allCities = [...new Set(allCities)];

            // تحليل المدن الحالية
            let currentCitiesArray = [];
            if (currentCities) {
                if (Array.isArray(currentCities)) {
                    currentCitiesArray = currentCities;
                } else if (typeof currentCities === 'string') {
                    try {
                        if (currentCities.startsWith('[') && currentCities.endsWith(']')) {
                            const parsed = JSON.parse(currentCities);
                            if (Array.isArray(parsed)) {
                                currentCitiesArray = parsed;
                            }
                        }
                    } catch (e) {
                        if (currentCities.includes(',')) {
                            currentCitiesArray = currentCities.split(',').map(c => c.trim()).filter(c => c && c !== 'null' && c !== '');
                        } else if (currentCities !== 'null' && currentCities !== '') {
                            currentCitiesArray = [currentCities];
                        }
                    }
                }
            }

            console.log('🔍 All cities for governorates:', allCities);
            console.log('🔍 Current cities array:', currentCitiesArray);

            // ملء قائمة المدن
            citiesList.innerHTML = allCities.map(city => `
                <div class="city-item" style="padding: 8px 16px; cursor: pointer; transition: background-color 0.3s ease;">
                    <label class="city-checkbox" style="display: flex; align-items: center; gap: 8px; cursor: pointer; width: 100%;">
                        <input type="checkbox" value="${city}" class="city-input" style="width: 16px; height: 16px; accent-color: #3b82f6;" ${currentCitiesArray.includes(city) ? 'checked' : ''}>
                        <span class="city-name" style="color: #374151; font-size: 14px; flex: 1;">${city}</span>
                    </label>
                </div>
            `).join('');

            // إضافة مستمعي الأحداث للصناديق الجديدة
            const cityCheckboxes = document.querySelectorAll('#edit-request-cities-list .city-input');
            cityCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (typeof editRequestSelectedCities !== 'undefined') {
                        if (this.checked) {
                            editRequestSelectedCities.add(this.value);
                        } else {
                            editRequestSelectedCities.delete(this.value);
                        }
                        updateEditRequestCitiesDisplay();
                    }
                });
                
                // تهيئة المدن المختارة
                if (checkbox.checked && typeof editRequestSelectedCities !== 'undefined') {
                    editRequestSelectedCities.add(checkbox.value);
                }
            });

            // مسح البحث
            citiesSearch.value = '';
            
            // تحديث العرض
            if (typeof updateEditRequestCitiesDisplay === 'function') {
                updateEditRequestCitiesDisplay();
            }
        }

        // عرض الصور الحالية في نموذج التعديل
        function displayEditRequestCurrentImages(imageUrls) {
            const container = document.getElementById('edit-request-current-images');
            
            if (imageUrls.length === 0) {
                container.innerHTML = '<p style="color: #666; font-size: 14px;">لا توجد صور</p>';
                const instructions = document.querySelector('.image-sort-instructions-edit');
                if (instructions) {
                    instructions.style.display = 'block';
                }
                return;
            }

            container.innerHTML = imageUrls.map((url, index) => `
                <div class="edit-image-item" data-index="${index}" draggable="true" style="position: relative; display: inline-block; margin: 5px; cursor: grab; transition: all 0.3s ease;">
                    <div class="edit-drag-handle" style="position: absolute; top: 2px; left: 2px; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: grab; z-index: 10; font-size: 10px;">
                        ⋮⋮
                    </div>
                    <img src="${url}" alt="صورة ${index + 1}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e1e5e9; cursor: pointer;" onclick="previewEditRequestImage('${url}')">
                    <div class="edit-image-number" style="position: absolute; bottom: 2px; left: 2px; background: #d4af37; color: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; z-index: 10;">
                        ${index + 1}
                    </div>
                    <button onclick="removeEditRequestImage(${index})" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">×</button>
                </div>
            `).join('');

            // إضافة مستمعي أحداث السحب والإفلات
            const imageItems = container.querySelectorAll('.edit-image-item');
            imageItems.forEach(item => {
                item.addEventListener('dragstart', handleEditRequestDragStart);
                item.addEventListener('dragover', handleEditRequestDragOver);
                item.addEventListener('drop', handleEditRequestDrop);
                item.addEventListener('dragenter', handleEditRequestDragEnter);
                item.addEventListener('dragleave', handleEditRequestDragLeave);
            });

            // إخفاء التعليمات عند وجود صور
            const instructions = document.querySelector('.image-sort-instructions-edit');
            if (instructions) {
                instructions.style.display = 'none';
            }
        }

        // معاينة صورة في نموذج التعديل
        function previewEditRequestImage(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = url;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            modal.onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // حذف صورة من نموذج التعديل
        function removeEditRequestImage(index) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                const requestId = document.getElementById('edit-request-id').value;
                const request = window.currentRequests.find(r => r.id == requestId);
                
                if (request && request.image_urls) {
                    request.image_urls.splice(index, 1);
                    displayEditRequestCurrentImages(request.image_urls);
                    alert('تم حذف الصورة');
                }
            }
        }

        // متغيرات السحب والإفلات لنموذج التعديل
        let editRequestDraggedElement = null;
        let editRequestDraggedIndex = null;

        // دوال السحب والإفلات لترتيب الصور في نموذج التعديل
        function handleEditRequestDragStart(e) {
            editRequestDraggedElement = this;
            editRequestDraggedIndex = parseInt(this.getAttribute('data-index'));
            this.classList.add('dragging');
            this.style.opacity = '0.5';
            this.style.transform = 'rotate(5deg)';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleEditRequestDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleEditRequestDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
            this.style.border = '2px dashed #d4af37';
            this.style.background = 'rgba(212, 175, 55, 0.1)';
        }

        function handleEditRequestDragLeave(e) {
            this.classList.remove('drag-over');
            this.style.border = '';
            this.style.background = '';
        }

        function handleEditRequestDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            this.style.border = '';
            this.style.background = '';
            
            if (editRequestDraggedElement !== this) {
                const dropIndex = parseInt(this.getAttribute('data-index'));
                const requestId = document.getElementById('edit-request-id').value;
                const request = window.currentRequests.find(r => r.id == requestId);
                
                if (request && request.image_urls) {
                    // إعادة ترتيب مصفوفة الصور
                    const draggedImage = request.image_urls[editRequestDraggedIndex];
                    request.image_urls.splice(editRequestDraggedIndex, 1);
                    request.image_urls.splice(dropIndex, 0, draggedImage);
                    
                    // إعادة عرض الصور بالترتيب الجديد
                    displayEditRequestCurrentImages(request.image_urls);
                    
                    // عرض رسالة نجاح
                    showEditRequestSortSuccess();
                }
            }
            
            editRequestDraggedElement.classList.remove('dragging');
            editRequestDraggedElement.style.opacity = '';
            editRequestDraggedElement.style.transform = '';
            editRequestDraggedElement = null;
            editRequestDraggedIndex = null;
        }

        function showEditRequestSortSuccess() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 3000;
                display: flex;
                align-items: center;
                font-size: 14px;
            `;
            message.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; margin-left: 8px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                تم تغيير ترتيب الصور بنجاح
            `;
            
            document.body.appendChild(message);
            
            // إزالة الرسالة بعد 3 ثوانٍ
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
        }

        // إغلاق نافذة تعديل الطلب
        function closeEditRequestModal() {
            document.getElementById('editRequestModal').style.display = 'none';
        }

        // متغيرات فلتر المدن لنموذج التعديل
        let editRequestCitiesService;
        let editRequestSelectedCities = new Set();
        let editRequestCurrentGovernorates = [];

        // تهيئة فلتر المدن لنموذج التعديل
        function initializeEditRequestCitiesFilter() {
            console.log('🔍 Initializing Edit Request Cities Filter');
            
            // التحقق من توفر CitiesService
            if (typeof CitiesService === 'undefined') {
                console.error('❌ CitiesService not available');
                return;
            }
            
            // تهيئة CitiesService
            editRequestCitiesService = new CitiesService();
            console.log('✅ CitiesService initialized for edit request');
            
            // إعداد وظائف فلتر المدن
            setupEditRequestCitiesFilter();
        }

        // إعداد فلتر المدن لنموذج التعديل
        function setupEditRequestCitiesFilter() {
            const citiesTrigger = document.getElementById('edit-request-cities-trigger');
            const citiesDropdown = document.getElementById('edit-request-cities-dropdown');
            const citiesSearch = document.getElementById('edit-request-cities-search');
            const selectAllCitiesBtn = document.getElementById('edit-request-select-all-cities-btn');
            const clearAllCitiesBtn = document.getElementById('edit-request-clear-all-cities-btn');
            const applyCitiesFilterBtn = document.getElementById('edit-request-apply-cities-filter');

            // التحقق من وجود العناصر
            if (!citiesTrigger || !citiesDropdown || !citiesSearch || !selectAllCitiesBtn || !clearAllCitiesBtn || !applyCitiesFilterBtn) {
                console.error('❌ Cities filter elements not found for edit request');
                return;
            }
            
            console.log('✅ All cities filter elements found for edit request');

            // تبديل القائمة المنسدلة
            citiesTrigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('🔍 Cities trigger clicked for edit request');
                citiesDropdown.classList.toggle('show');
                citiesTrigger.classList.toggle('active');
            });

            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', function(event) {
                if (!citiesTrigger.contains(event.target) && !citiesDropdown.contains(event.target)) {
                    citiesDropdown.classList.remove('show');
                    citiesTrigger.classList.remove('active');
                }
            });

            // وظيفة البحث
            citiesSearch.addEventListener('input', function() {
                filterEditRequestCities(this.value);
            });

            // تحديد جميع المدن
            selectAllCitiesBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#edit-request-cities-list .city-input');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    editRequestSelectedCities.add(checkbox.value);
                });
                updateEditRequestCitiesDisplay();
            });

            // إلغاء تحديد جميع المدن
            clearAllCitiesBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#edit-request-cities-list .city-input');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                editRequestSelectedCities.clear();
                updateEditRequestCitiesDisplay();
            });

            // تطبيق الفلتر
            applyCitiesFilterBtn.addEventListener('click', function() {
                citiesDropdown.classList.remove('show');
                citiesTrigger.classList.remove('active');
            });
        }

        // تصفية المدن بناءً على مصطلح البحث
        function filterEditRequestCities(searchTerm) {
            const cityItems = document.querySelectorAll('#edit-request-cities-list .city-item');
            
            cityItems.forEach(item => {
                const cityName = item.querySelector('.city-name').textContent.toLowerCase();
                const matches = cityName.includes(searchTerm.toLowerCase());
                item.style.display = matches ? 'block' : 'none';
            });
        }

        // تحديث عرض المدن
        function updateEditRequestCitiesDisplay() {
            const selectedCount = document.getElementById('edit-request-cities-selected-count');
            const selectedCitiesContainer = document.getElementById('edit-request-selected-cities');
            const triggerText = document.querySelector('#edit-request-cities-trigger .trigger-text');

            // تحديث العدد
            if (editRequestSelectedCities.size === 0) {
                selectedCount.style.display = 'none';
                triggerText.textContent = 'اختر المناطق/المدن (اختياري)';
            } else {
                selectedCount.style.display = 'inline-block';
                selectedCount.textContent = editRequestSelectedCities.size;
                triggerText.textContent = `${editRequestSelectedCities.size} منطقة مختارة`;
            }

            // تحديث علامات المدن المختارة
            if (editRequestSelectedCities.size === 0) {
                selectedCitiesContainer.innerHTML = '';
            } else {
                selectedCitiesContainer.innerHTML = Array.from(editRequestSelectedCities).map(city => `
                    <div class="selected-city-tag" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 12px; font-weight: 500;">
                        ${city}
                        <button class="remove-city" onclick="removeEditRequestCity('${city}')" style="background: none; border: none; color: #1e40af; cursor: pointer; font-size: 14px; font-weight: bold; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.3s ease;">×</button>
                    </div>
                `).join('');
            }
        }

        // إزالة مدينة محددة
        function removeEditRequestCity(city) {
            editRequestSelectedCities.delete(city);
            
            // إلغاء تحديد الصندوق المقابل
            const checkbox = document.querySelector(`#edit-request-cities-list .city-input[value="${city}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateEditRequestCitiesDisplay();
        }

        // الحصول على المدن المختارة لتقديم النموذج
        function getEditRequestSelectedCities() {
            return Array.from(editRequestSelectedCities);
        }

        // ===== دالة حفظ التغييرات =====

        // حفظ التغييرات في الطلب
        async function saveEditRequestChanges() {
            const requestId = document.getElementById('edit-request-id').value;
            
            if (!requestId) {
                alert('خطأ في بيانات الطلب');
                return;
            }

            // الحصول على بيانات النموذج
            const description = document.getElementById('edit-request-description').value;
            const price = document.getElementById('edit-request-price').value;
            const category = document.getElementById('edit-request-category').value;
            const whatsapp = document.getElementById('edit-request-whatsapp').value;
            const facebook = document.getElementById('edit-request-facebook').value;
            const instagram = document.getElementById('edit-request-instagram').value;

            // الحصول على المحافظات المختارة
            const selectedGovernorates = [];
            document.querySelectorAll('#edit-request-governorate-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedGovernorates.push(checkbox.value);
            });

            // الحصول على التصنيفات الفرعية المختارة
            const selectedSubcategories = [];
            document.querySelectorAll('#edit-request-subcategory-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedSubcategories.push(checkbox.value);
            });

            console.log('🔍 Saving selected subcategories for edit:', selectedSubcategories);

            // تحويل التصنيفات الفرعية إلى JSON string للتخزين المتسق
            let subcategoryValue = null;
            if (selectedSubcategories.length > 0) {
                subcategoryValue = JSON.stringify(selectedSubcategories);
                console.log('🔍 Subcategory JSON value for edit:', subcategoryValue);
            }

            // الحصول على المدن المختارة
            const selectedCitiesArray = getEditRequestSelectedCities();

            // التحقق من صحة البيانات
            if (!description.trim()) {
                alert('يرجى إدخال وصف المنتج');
                return;
            }

            if (selectedGovernorates.length === 0) {
                alert('يرجى اختيار محافظة واحدة على الأقل');
                return;
            }

            try {
                // الحصول على الطلب الحالي للحفاظ على ترتيب الصور
                const currentRequest = window.currentRequests.find(r => r.id == requestId);
                
                // إعداد بيانات التحديث
                const updateData = {
                    description: description,
                    price: price || null,
                    category: category,
                    subcategory: subcategoryValue,
                    governorate: selectedGovernorates.join(', '),
                    cities: selectedCitiesArray.length > 0 ? selectedCitiesArray.join(', ') : null,
                    whatsapp: whatsapp,
                    facebook: facebook || null,
                    instagram: instagram || null,
                    // الحفاظ على ترتيب الصور المُعدل إذا كانت موجودة
                    image_urls: currentRequest && currentRequest.image_urls ? currentRequest.image_urls : null,
                    updated_at: new Date().toISOString()
                };

                console.log('🔍 [DEBUG] ===== saveEditRequestChanges - UPDATE DATA =====');
                console.log('🔍 [DEBUG] Request ID:', requestId);
                console.log('🔍 [DEBUG] Selected subcategories array:', selectedSubcategories);
                console.log('🔍 [DEBUG] Subcategory JSON value:', subcategoryValue);
                console.log('🔍 [DEBUG] Full update data:', updateData);

                // تحديث في قاعدة البيانات
                const { error } = await window.supabaseClient
                    .from('product_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) {
                    throw error;
                }

                console.log('🔍 [DEBUG] ✅ Database update successful for request:', requestId);

                // تحديث المصفوفة المحلية بتنسيق البيانات المتسق
                const requestIndex = window.currentRequests.findIndex(r => r.id == requestId);
                if (requestIndex !== -1) {
                    // تحليل التصنيف الفرعي JSON للتخزين المحلي لضمان الاتساق
                    let parsedSubcategory = null;
                    if (subcategoryValue) {
                        try {
                            parsedSubcategory = JSON.parse(subcategoryValue);
                            console.log('🔍 [DEBUG] Parsed subcategory for local storage:', parsedSubcategory);
                        } catch (e) {
                            console.log('🔍 [DEBUG] Could not parse subcategory for local storage:', e.message);
                            parsedSubcategory = subcategoryValue;
                        }
                    }

                    const oldRequest = window.currentRequests[requestIndex];
                    
                    // تحديث البيانات مع الحفاظ على الحقول الموجودة
                    window.currentRequests[requestIndex] = {
                        ...window.currentRequests[requestIndex],
                        description: updateData.description,
                        price: updateData.price,
                        category: updateData.category,
                        subcategory: parsedSubcategory,
                        governorate: updateData.governorate,
                        cities: updateData.cities,
                        whatsapp: updateData.whatsapp,
                        facebook: updateData.facebook,
                        instagram: updateData.instagram,
                        image_urls: updateData.image_urls,
                        updated_at: updateData.updated_at
                    };

                    console.log('🔍 [DEBUG] Updated local request data:', {
                        requestId: requestId,
                        oldSubcategory: oldRequest.subcategory,
                        newSubcategory: parsedSubcategory,
                        updateData: updateData
                    });
                } else {
                    console.log('🔍 [DEBUG] ⚠️ Request not found in local array for update');
                }

                alert('تم تحديث الطلب بنجاح');
                closeEditRequestModal();

                // تحديث العرض بالبيانات المُعدلة
                console.log('🔄 Refreshing display after request update...');
                await loadProductRequests(); // إعادة تحميل البيانات من قاعدة البيانات

                console.log('✅ Request update completed - Subcategories should now display correctly in request cards');

            } catch (error) {
                console.error('Error updating request:', error);
                alert('حدث خطأ في تحديث الطلب: ' + error.message);
            }
        }

        // تحميل البيانات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            // انتظار تحميل Supabase
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            console.log('Loading dashboard data...');
            await loadUserInfo();
            await loadDashboardData();
            await loadRecentActivity();

            // ===== ربط نموذج تعديل الطلب =====
            
            // ربط تقديم النموذج
            const editRequestForm = document.getElementById('editRequestForm');
            if (editRequestForm) {
                editRequestForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveEditRequestChanges();
                });
            }

            // تغيير الفئة في نموذج التعديل
            const editRequestCategory = document.getElementById('edit-request-category');
            if (editRequestCategory) {
                editRequestCategory.addEventListener('change', function() {
                    populateEditRequestSubcategories(this.value, []);
                });
            }

            // رفع الصور في نموذج التعديل
            const editRequestImageUploadArea = document.getElementById('edit-request-image-upload-area');
            const editRequestNewImagesInput = document.getElementById('edit-request-new-images');
            
            if (editRequestImageUploadArea && editRequestNewImagesInput) {
                editRequestImageUploadArea.addEventListener('click', () => editRequestNewImagesInput.click());
                
                editRequestNewImagesInput.addEventListener('change', function(e) {
                    handleEditRequestNewImages(e.target.files);
                });
            }

            // إغلاق النوافذ المنبثقة عند النقر خارجها
            window.onclick = function(event) {
                const editRequestModal = document.getElementById('editRequestModal');
                
                if (event.target === editRequestModal) {
                    closeEditRequestModal();
                }
            }

            // تهيئة فلتر المدن عند تحميل الصفحة
            console.log('🔍 DOM Content Loaded - Initializing cities filter for edit request');
            setTimeout(() => {
                initializeEditRequestCitiesFilter();
            }, 100);
        });

        // ===== معالجة الصور الجديدة في نموذج التعديل =====

        // معالجة الصور الجديدة في نموذج التعديل
        function handleEditRequestNewImages(files) {
            const container = document.getElementById('edit-request-current-images');
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = `
                            position: relative;
                            display: inline-block;
                            margin: 5px;
                        `;
                        imgDiv.innerHTML = `
                            <img src="${e.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e1e5e9; cursor: pointer;" onclick="previewEditRequestImage('${e.target.result}')">
                            <button onclick="this.parentElement.remove()" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">×</button>
                        `;
                        container.appendChild(imgDiv);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // تحديث البيانات كل 5 دقائق
        setInterval(async function() {
            console.log('Refreshing dashboard data...');
            await loadDashboardData();
            await loadRecentActivity();
        }, 5 * 60 * 1000);

        // تهيئة فلتر المدن عند تحميل النافذة
        window.addEventListener('load', function() {
            console.log('🔍 Window Loaded - Initializing cities filter for edit request');
            setTimeout(() => {
                initializeEditRequestCitiesFilter();
            }, 200);
        });

        // ===== نظام المسارات الجديد =====
        
        // تعريف المسارات المتاحة
        const ADMIN_ROUTES = {
            'dashboard': {
                title: 'لوحة التحكم الرئيسية',
                handler: showDashboardHome
            },
            'advertising': {
                title: 'إدارة الإعلانات',
                handler: showAdvertisingPanel
            },
            'product-requests': {
                title: 'طلبات المنتجات',
                handler: showProductRequests
            },
            'reports': {
                title: 'التقارير',
                handler: showReports
            }
        };
        
        // تحديث URL بدون إعادة تحميل الصفحة
        function updateURL(route) {
            try {
                const newURL = `/admin/${route === 'dashboard' ? '' : route}`;
                window.history.pushState({ route }, ADMIN_ROUTES[route]?.title || 'لوحة التحكم', newURL);
                console.log(`تم تحديث URL إلى: ${newURL}`);
            } catch (error) {
                console.error('خطأ في تحديث URL:', error);
            }
        }
        
        // حفظ المسار الحالي في localStorage
        function saveCurrentRoute(route) {
            try {
                localStorage.setItem('adminCurrentRoute', route);
                localStorage.setItem('adminRouteTimestamp', Date.now().toString());
                console.log(`تم حفظ المسار: ${route}`);
            } catch (error) {
                console.error('خطأ في حفظ المسار:', error);
            }
        }
        
        // استعادة المسار المحفوظ
        function restoreRoute() {
            try {
                // أولاً: محاولة قراءة من URL
                const path = window.location.pathname;
                let route = 'dashboard';
                
                if (path.includes('/admin/')) {
                    const routePart = path.split('/admin/')[1];
                    if (routePart && ADMIN_ROUTES[routePart]) {
                        route = routePart;
                    }
                }
                
                // إذا كان URL لا يحتوي على مسار محدد، استخدم localStorage
                if (route === 'dashboard') {
                    const savedRoute = localStorage.getItem('adminCurrentRoute');
                    const timestamp = localStorage.getItem('adminRouteTimestamp');
                    
                    if (savedRoute && timestamp) {
                        const timeDiff = Date.now() - parseInt(timestamp);
                        if (timeDiff < 3600000 && ADMIN_ROUTES[savedRoute]) { // أقل من ساعة
                            route = savedRoute;
                            console.log(`استعادة المسار المحفوظ: ${route}`);
                        }
                    }
                }
                
                console.log(`المسار النهائي: ${route}`);
                
                // عرض الصفحة المناسبة
                if (ADMIN_ROUTES[route] && ADMIN_ROUTES[route].handler) {
                    ADMIN_ROUTES[route].handler();
                    updateURL(route);
                } else {
                    console.log('المسار غير معروف، عرض الصفحة الرئيسية');
                    showDashboardHome();
                    updateURL('dashboard');
                }
                
            } catch (error) {
                console.error('خطأ في استعادة المسار:', error);
                showDashboardHome();
                updateURL('dashboard');
            }
        }
        
        // معالج تغيير المسار
        function navigateToRoute(route) {
            if (!ADMIN_ROUTES[route]) {
                console.error(`المسار غير موجود: ${route}`);
                return;
            }
            
            console.log(`الانتقال إلى: ${route}`);
            
            // عرض الصفحة
            ADMIN_ROUTES[route].handler();
            
            // تحديث URL
            updateURL(route);
            
            // حفظ المسار
            saveCurrentRoute(route);
        }
        
        // إظهار الصفحة الرئيسية للوحة التحكم
        function showDashboardHome() {
            // إظهار جميع الأقسام الأصلية
            document.querySelector('.welcome-section').style.display = 'block';
            document.querySelector('.stats-grid').style.display = 'grid';
            document.querySelector('.quick-actions').style.display = 'block';
            document.querySelector('.recent-activity').style.display = 'block';
            
            // إخفاء الأقسام الأخرى
            document.getElementById('advertising-panel').style.display = 'none';
            document.getElementById('product-requests-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            console.log('تم عرض الصفحة الرئيسية');
        }
        
        // ===== وظائف الإعلانات =====

        // دالة مساعدة لمعالجة الصور
        function getAdImageUrl(ad) {
            console.log('🚨 DEBUG: بداية معالجة الصورة للإعلان:', ad);
            console.log('🚨 DEBUG: بيانات الإعلان الكاملة:', JSON.stringify(ad, null, 2));
            
            let imageUrl = '';
            
            // محاولة الحصول على الصورة من المنتج أولاً
            if (ad.product && ad.has_product) {
                console.log('🚨 DEBUG: الإعلان مرتبط بمنتج:', ad.product);
                console.log('🚨 DEBUG: product.image_urls:', ad.product.image_urls);
                console.log('🚨 DEBUG: product.image_url:', ad.product.image_url);
                console.log('🚨 DEBUG: product.image_urls type:', typeof ad.product.image_urls);
                console.log('🚨 DEBUG: product.image_urls length:', ad.product.image_urls?.length);
                
                if (ad.product.image_urls && ad.product.image_urls.length > 0) {
                    imageUrl = ad.product.image_urls[0];
                    console.log('🚨 DEBUG: تم العثور على صورة من image_urls:', imageUrl);
                } else if (ad.product.image_url) {
                    imageUrl = ad.product.image_url;
                    console.log('🚨 DEBUG: تم العثور على صورة من image_url:', imageUrl);
                } else {
                    console.log('🚨 DEBUG: لا توجد صور في المنتج');
                }
            } else {
                console.log('🚨 DEBUG: الإعلان غير مرتبط بمنتج أو has_product = false');
                console.log('🚨 DEBUG: ad.product:', ad.product);
                console.log('🚨 DEBUG: ad.has_product:', ad.has_product);
                console.log('🚨 DEBUG: ad.product_id:', ad.product_id);
                console.log('🚨 DEBUG: ad.product_category:', ad.product_category);
            }
            
            // إذا لم توجد صورة في المنتج، استخدم صورة الإعلان
            if (!imageUrl && ad.image_url) {
                imageUrl = ad.image_url;
                console.log('🚨 DEBUG: تم استخدام صورة الإعلان:', imageUrl);
            } else if (!imageUrl) {
                console.log('🚨 DEBUG: لا توجد صورة في الإعلان أيضاً');
            }
            
            // إذا لم توجد أي صورة، استخدم الصورة الافتراضية
            if (!imageUrl) {
                imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo=';
                console.log('🚨 DEBUG: تم استخدام الصورة الافتراضية');
            }
            
            console.log('🚨 DEBUG: النتيجة النهائية للصورة:', imageUrl);
            return imageUrl;
        }

        // إظهار لوحة الإعلانات
        function showAdvertisingPanel() {
            // إخفاء جميع الأقسام الأخرى
            document.querySelector('.welcome-section').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.quick-actions').style.display = 'none';
            document.querySelector('.recent-activity').style.display = 'none';
            document.getElementById('product-requests-section').style.display = 'none';
            document.getElementById('reports-section').style.display = 'none';
            
            // إظهار لوحة الإعلانات
            document.getElementById('advertising-panel').style.display = 'block';
            
            // تحميل بيانات الإعلانات
            loadAdvertisingData();
        }

        // إخفاء لوحة الإعلانات
        function hideAdvertisingPanel() {
            showDashboardHome();
        }

        // تبديل التبويبات
        function switchAdvertisingTab(tabName) {
            // إخفاء جميع التبويبات
            document.getElementById('active-ads-tab').style.display = 'none';
            document.getElementById('ad-requests-tab').style.display = 'none';
            document.getElementById('system-stats-tab').style.display = 'none';
            
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.advertising-tabs .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التبويب المطلوب
            if (tabName === 'active-ads') {
                document.getElementById('active-ads-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:first-child').classList.add('active');
                loadActiveAdvertisements();
            } else if (tabName === 'ad-requests') {
                document.getElementById('ad-requests-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:nth-child(2)').classList.add('active');
                loadAdRequests();
            } else if (tabName === 'system-stats') {
                document.getElementById('system-stats-tab').style.display = 'block';
                document.querySelector('.advertising-tabs .filter-btn:nth-child(4)').classList.add('active');
                loadSystemStatistics();
            }
        }
        
        // إظهار تبويب الإحصائيات الشاملة
        function showSystemStatistics() {
            switchAdvertisingTab('system-stats');
        }

        // دالة اختبار لفحص بيانات الإعلانات
        async function debugAdvertisementsData() {
            try {
                console.log('🚨 DEBUG: بداية فحص بيانات الإعلانات من قاعدة البيانات');
                
                if (!window.supabaseClient) {
                    console.error('🚨 DEBUG: Supabase client غير متوفر');
                    return;
                }

                // جلب جميع الإعلانات
                const { data: ads, error: adsError } = await window.supabaseClient
                    .from('advertisements')
                    .select('*');
                
                if (adsError) {
                    console.error('🚨 DEBUG: خطأ في جلب الإعلانات:', adsError);
                    return;
                }

                console.log('🚨 DEBUG: جميع الإعلانات من قاعدة البيانات:', ads);

                // فحص كل إعلان
                for (const ad of ads || []) {
                    console.log(`🚨 DEBUG: فحص الإعلان ${ad.id}:`, {
                        id: ad.id,
                        product_id: ad.product_id,
                        product_category: ad.product_category,
                        has_product: ad.has_product,
                        image_url: ad.image_url
                    });

                    if (ad.product_id && ad.product_category) {
                        // تحديد اسم الجدول
                        let tableName = 'products_other';
                        switch (ad.product_category) {
                            case 'cake': tableName = 'products_cake'; break;
                            case 'koshat': tableName = 'products_koshat'; break;
                            case 'mirr': tableName = 'products_mirr'; break;
                            case 'other': tableName = 'products_other'; break;
                            case 'invitations': tableName = 'products_invitations'; break;
                        }

                        console.log(`🚨 DEBUG: محاولة جلب المنتج من ${tableName} بمعرف ${ad.product_id}`);

                        // جلب المنتج
                        const { data: product, error: productError } = await window.supabaseClient
                            .from(tableName)
                            .eq('id', ad.product_id)
                            .select('id, description, price, image_urls, category, subcategory, governorate, cities, whatsapp, facebook, instagram, created_at, updated_at')
                            .single();

                        if (productError) {
                            console.error(`🚨 DEBUG: خطأ في جلب المنتج من ${tableName}:`, productError);
                        } else {
                            console.log(`🚨 DEBUG: المنتج من ${tableName}:`, product);
                            console.log(`🚨 DEBUG: صور المنتج:`, {
                                image_urls: product.image_urls,
                                image_url: product.image_url,
                                image_urls_type: typeof product.image_urls,
                                image_urls_length: product.image_urls?.length
                            });
                        }
                    }
                }

                // فحص خدمة الإعلانات
                console.log('🚨 DEBUG: فحص خدمة الإعلانات...');
                if (window.advertisingService) {
                    console.log('🚨 DEBUG: خدمة الإعلانات متوفرة');
                    try {
                        const adsWithProducts = await window.advertisingService.getAllAdvertisementsWithProducts();
                        console.log('🚨 DEBUG: نتيجة خدمة الإعلانات:', adsWithProducts);
                        
                        if (adsWithProducts && adsWithProducts.length > 0) {
                            adsWithProducts.forEach((ad, index) => {
                                console.log(`🚨 DEBUG: الإعلان ${index + 1} من الخدمة:`, {
                                    id: ad.id,
                                    product_id: ad.product_id,
                                    has_product: ad.has_product,
                                    product: ad.product ? {
                                        id: ad.product.id,
                                        image_urls: ad.product.image_urls,
                                        image_url: ad.product.image_url
                                    } : null
                                });
                            });
                        }
                    } catch (error) {
                        console.error('🚨 DEBUG: خطأ في خدمة الإعلانات:', error);
                    }
                } else {
                    console.error('🚨 DEBUG: خدمة الإعلانات غير متوفرة');
                }

            } catch (error) {
                console.error('🚨 DEBUG: خطأ في فحص البيانات:', error);
            }
        }

        // تحميل بيانات الإعلانات
        async function loadAdvertisingData() {
            try {
                await loadActiveAdvertisements();
                await loadAdRequests();
                await loadAdStatistics();
            } catch (error) {
                console.error('خطأ في تحميل بيانات الإعلانات:', error);
            }
        }

        // تحميل الإعلانات النشطة
        async function loadActiveAdvertisements() {
            try {
                console.log('🚨 DEBUG: بداية تحميل الإعلانات النشطة');
                console.log('🚨 DEBUG: window.advertisingService موجود:', !!window.advertisingService);
                
                if (!window.advertisingService) {
                    console.error('🚨 DEBUG: خدمة الإعلانات غير متوفرة');
                    return;
                }

                console.log('🚨 DEBUG: جلب الإعلانات مع تفاصيل المنتجات...');
                
                // استخدام الدالة الجديدة لجلب الإعلانات مع المنتجات
                const advertisements = await window.advertisingService.getAllAdvertisementsWithProducts();
                
                console.log('🚨 DEBUG: تم جلب الإعلانات:', advertisements);
                console.log('🚨 DEBUG: نوع البيانات:', typeof advertisements);
                console.log('🚨 DEBUG: هل هي مصفوفة:', Array.isArray(advertisements));
                
                // معالجة إضافية للصور قبل العرض
                if (advertisements && advertisements.length > 0) {
                    console.log('🚨 DEBUG: عدد الإعلانات:', advertisements.length);
                    advertisements.forEach((ad, index) => {
                        console.log(`🚨 DEBUG: الإعلان رقم ${index + 1}:`, ad);
                        if (ad.product && ad.has_product) {
                            console.log(`🚨 DEBUG: معالجة الإعلان ${ad.id}:`, {
                                product_id: ad.product.id,
                                image_urls: ad.product.image_urls,
                                image_url: ad.product.image_url,
                                has_product: ad.has_product
                            });
                        } else {
                            console.log(`🚨 DEBUG: الإعلان ${ad.id} بدون منتج مرتبط`);
                        }
                    });
                } else {
                    console.log('🚨 DEBUG: لا توجد إعلانات أو المصفوفة فارغة');
                }
                
                displayActiveAdvertisements(advertisements);
            } catch (error) {
                console.error('🚨 DEBUG: خطأ في تحميل الإعلانات النشطة:', error);
                console.error('🚨 DEBUG: تفاصيل الخطأ:', error.message);
                console.error('🚨 DEBUG: stack trace:', error.stack);
            }
        }

        // عرض الإعلانات النشطة كبطاقات
        function displayActiveAdvertisements(advertisements) {
            console.log('🚨 DEBUG: بداية عرض الإعلانات النشطة');
            console.log('🚨 DEBUG: عدد الإعلانات:', advertisements?.length);
            
            const cardsContainer = document.getElementById('active-ads-cards');
            const noAdsMessage = document.getElementById('no-ads-message');
            
            if (!cardsContainer) {
                console.error('🚨 DEBUG: لم يتم العثور على حاوية البطاقات');
                return;
            }

            if (!advertisements || advertisements.length === 0) {
                console.log('🚨 DEBUG: لا توجد إعلانات للعرض');
                cardsContainer.style.display = 'none';
                if (noAdsMessage) noAdsMessage.style.display = 'block';
                return;
            }

            console.log('🚨 DEBUG: سيتم عرض', advertisements.length, 'إعلان');
            
            cardsContainer.style.display = 'grid';
            if (noAdsMessage) noAdsMessage.style.display = 'none';

            // إنشاء البطاقات مع تسجيل مفصل
            const cards = advertisements.map((ad, index) => {
                console.log(`🚨 DEBUG: إنشاء البطاقة رقم ${index + 1} للإعلان:`, ad.id);
                return createAdCard(ad);
            }).join('');
            
            console.log('🚨 DEBUG: تم إنشاء جميع البطاقات، سيتم إدراجها في DOM');
            cardsContainer.innerHTML = cards;
            console.log('🚨 DEBUG: تم إدراج البطاقات في DOM بنجاح');
        }

        // إنشاء بطاقة إعلان أنيقة
        function createAdCard(ad) {
            console.log('🚨 DEBUG: بداية إنشاء بطاقة الإعلان:', ad.id);
            
            const statusClass = getAdStatusClass(ad);
            const statusText = getAdStatusText(ad);
            const typeText = getAdTypeText(ad);
            const positionText = getAdPositionText(ad);
            
            console.log('🚨 DEBUG: البيانات المستخرجة:', {
                statusClass,
                statusText,
                typeText,
                positionText
            });
            
            // تحديد الصورة الرئيسية باستخدام الدالة المساعدة
            const mainImage = getAdImageUrl(ad);
            console.log('🚨 DEBUG: الصورة النهائية المحددة:', mainImage);
            
            // معلومات مختصرة للمنتج
            let productName = 'إعلان بدون منتج';
            let productPrice = '';
            let productCategory = '';
            
            if (ad.product && ad.has_product) {
                console.log('🚨 DEBUG: معالجة بيانات المنتج:', ad.product);
                productName = ad.product.name || ad.product.description || 'منتج مرتبط';
                productPrice = ad.product.price ? `💰 ${ad.product.price} ج.م` : '';
                productCategory = ad.product_category ? `🏷️ ${ad.product_category}` : '';
                
                console.log('🚨 DEBUG: بيانات المنتج المعالجة:', {
                    productName,
                    productPrice,
                    productCategory
                });
            } else {
                console.log('🚨 DEBUG: لا توجد بيانات منتج مرتبط');
            }
            
            console.log('🚨 DEBUG: إنشاء HTML البطاقة للإعلان:', ad.id);
            
            const cardHtml = `
                <div class="ad-card-elegant" data-ad-id="${ad.id}" onclick="openAdDetails('${ad.id}')">
                    <div class="ad-card-image-container">
                        <img src="${mainImage}" alt="صورة الإعلان" class="ad-card-main-image" 
                             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo='; console.log('❌ فشل تحميل الصورة:', this.src);"
                             onload="console.log('✅ تم تحميل الصورة بنجاح:', this.src)"
                             loading="lazy">
                        <div class="ad-card-overlay">
                            <div class="ad-card-badges">
                                <span class="ad-type-badge-elegant">${typeText}</span>
                                <span class="ad-status-badge-elegant ${statusClass}">${statusText}</span>
                            </div>
                            <div class="ad-card-hover-info">
                                <span class="hover-text">اضغط لعرض التفاصيل</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ad-card-content">
                        <div class="ad-card-header-elegant">
                            <h3 class="ad-card-title-elegant">${ad.title || 'إعلان بدون عنوان'}</h3>
                            <p class="ad-card-subtitle-elegant">${positionText}</p>
                        </div>
                        
                        <div class="ad-card-product-info">
                            <h4 class="product-name-elegant">${productName}</h4>
                            ${productPrice ? `<p class="product-price-elegant">${productPrice}</p>` : ''}
                            ${productCategory ? `<p class="product-category-elegant">${productCategory}</p>` : ''}
                        </div>
                        
                        <div class="ad-card-meta">
                            <div class="meta-item">
                                <span class="meta-icon">🚀</span>
                                <span class="meta-text">يبدأ: ${formatDate(ad.start_date)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">⏰</span>
                                <span class="meta-text">ينتهي: ${ad.end_date ? formatDate(ad.end_date) : 'غير محدد'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-icon">⭐</span>
                                <span class="meta-text">الأولوية: ${ad.priority || 1}</span>
                            </div>
                        </div>
                        
                        <div class="ad-card-actions-elegant">
                            <button class="ad-action-btn-elegant edit" onclick="event.stopPropagation(); editAdvertisement('${ad.id}')">
                                <span>✏️</span>
                                تعديل
                            </button>
                            <button class="ad-action-btn-elegant delete" onclick="event.stopPropagation(); deleteAdvertisement('${ad.id}')">
                                <span>🗑️</span>
                                حذف
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('🚨 DEBUG: تم إنشاء HTML البطاقة بنجاح للإعلان:', ad.id);
            console.log('🚨 DEBUG: HTML البطاقة:', cardHtml);
            
            return cardHtml;
        }

        // دوال مساعدة للإعلانات
        function getAdStatusClass(ad) {
            if (ad.is_active === true) return 'active';
            if (ad.is_active === false) return 'paused';
            return 'active';
        }

        function getAdStatusText(ad) {
            if (ad.is_active === true) return 'نشط';
            if (ad.is_active === false) return 'متوقف مؤقتاً';
            return 'نشط';
        }

        function getAdTypeText(type) {
            const types = {
                'featured': 'مميز',
                'recommended': 'موصى به',
                'banner': 'بانر',
                'category_sections': 'أقسام التصنيفات في الصفحة الرئيسية'
            };
            return types[type] || 'غير محدد';
        }

        function getAdPositionText(position) {
            const positions = {
                'homepage_featured': 'الصفحة الرئيسية - مميز',
                'homepage_recommended': 'الصفحة الرئيسية - موصى به',
                'category_featured': 'صفحة التصنيف - مميز',
                'sidebar': 'الشريط الجانبي',
                'homepage_featured': 'أقسام التصنيفات في الصفحة الرئيسية'
            };
            return positions[position] || 'غير محدد';
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'غير محدد';
            }
        }

        // دوال إدارة الإعلانات
        async function editAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                // جلب بيانات الإعلان من الجدول مباشرة
                const { data: ad, error } = await window.supabaseClient
                    .from('advertisements')
                    .select('*')
                    .eq('id', adId)
                    .single();
                
                if (error || !ad) {
                    alert('لم يتم العثور على الإعلان');
                    return;
                }

                // ملء نموذج التعديل
                document.getElementById('edit-ad-id').value = ad.id;
                document.getElementById('edit-ad-title').value = ad.title || '';
                document.getElementById('edit-ad-description').value = ad.description || '';
                document.getElementById('edit-ad-category').value = ad.product_category || '';
                document.getElementById('edit-ad-section').value = ad.category_section || '';
                document.getElementById('edit-ad-type').value = ad.ad_type || '';
                document.getElementById('edit-ad-position').value = ad.position || '';
                document.getElementById('edit-ad-start-date').value = ad.start_date ? ad.start_date.slice(0, 16) : '';
                document.getElementById('edit-ad-end-date').value = ad.end_date ? ad.end_date.slice(0, 16) : '';
                document.getElementById('edit-ad-priority').value = ad.priority || 1;
                document.getElementById('edit-ad-status').value = ad.is_active ? 'active' : 'paused';
                
                // تحديث أقسام الإعلانات حسب التصنيف
                updateEditAdSections();
                
                // تحميل المنتجات للتصنيف المحدد
                await loadProductsForEditCategory();

                // إظهار النافذة
                document.getElementById('edit-ad-modal').style.display = 'flex';
            } catch (error) {
                console.error('خطأ في تحميل بيانات الإعلان:', error);
                alert('حدث خطأ في تحميل بيانات الإعلان');
            }
        }

        async function updateAdvertisement() {
            try {
                const adId = document.getElementById('edit-ad-id').value;
                const formData = {
                    title: document.getElementById('edit-ad-title').value,
                    description: document.getElementById('edit-ad-description').value,
                    image_url: null, // سيتم تعيينه تلقائياً من المنتج
                    link_url: null, // سيتم تعيينه تلقائياً من المنتج
                    category: document.getElementById('edit-ad-category').value,
                    category_section: document.getElementById('edit-ad-section').value, // القسم الجديد
                    product_id: document.getElementById('edit-ad-product').value,
                    ad_type: document.getElementById('edit-ad-type').value,
                    position: document.getElementById('edit-ad-position').value,
                    start_date: document.getElementById('edit-ad-start-date').value,
                    end_date: document.getElementById('edit-ad-end-date').value,
                    priority: parseInt(document.getElementById('edit-ad-priority').value),
                    budget: parseFloat(document.getElementById('edit-ad-budget').value) || 0,
                    status: document.getElementById('edit-ad-status').value
                };

                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisement(adId, formData);
                if (result.success) {
                    alert('تم تحديث الإعلان بنجاح');
                    hideEditAdModal();
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في تحديث الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في تحديث الإعلان:', error);
                alert('حدث خطأ في تحديث الإعلان');
            }
        }

        async function deleteAdvertisement(adId) {
            if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }

            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.deleteAdvertisement(adId);
                if (result.success) {
                    alert('تم حذف الإعلان بنجاح');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في حذف الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في حذف الإعلان:', error);
                alert('حدث خطأ في حذف الإعلان');
            }
        }

        async function pauseAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisementStatus(adId, 'paused');
                if (result.success) {
                    alert('تم إيقاف الإعلان مؤقتاً');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في إيقاف الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في إيقاف الإعلان:', error);
                alert('حدث خطأ في إيقاف الإعلان');
            }
        }

        async function activateAdvertisement(adId) {
            try {
                if (!window.advertisingService) {
                    alert('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.updateAdvertisementStatus(adId, 'active');
                if (result.success) {
                    alert('تم تفعيل الإعلان بنجاح');
                    loadActiveAdvertisements();
                } else {
                    alert('خطأ في تفعيل الإعلان: ' + result.error);
                }
            } catch (error) {
                console.error('خطأ في تفعيل الإعلان:', error);
                alert('حدث خطأ في تفعيل الإعلان');
            }
        }

        function hideEditAdModal() {
            document.getElementById('edit-ad-modal').style.display = 'none';
        }

        async function loadProductsForEditCategory() {
            const category = document.getElementById('edit-ad-category').value;
            const productSelect = document.getElementById('edit-ad-product');
            
            if (!category) {
                productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                productSelect.disabled = true;
                return;
            }

            try {
                if (!window.productService) {
                    console.error('خدمة المنتجات غير متوفرة');
                    return;
                }

                const products = await window.productService.getProductsByCategory(category);
                productSelect.innerHTML = '<option value="">اختر المنتج</option>' +
                    products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                productSelect.disabled = false;
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                productSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
            }
        }

        async function updateEditAdPositions() {
            const adType = document.getElementById('edit-ad-type').value;
            const positionSelect = document.getElementById('edit-ad-position');
            
            // إعادة تعيين الحقل
            positionSelect.innerHTML = '<option value="">اختر الموضع</option>';
            positionSelect.disabled = true; // تعطيل الحقل أولاً
            
            if (!adType) {
                return;
            }

            const positions = {
                'featured': [
                    { value: 'homepage_featured', text: 'الصفحة الرئيسية - مميز' },
                    { value: 'category_featured', text: 'صفحة التصنيف - مميز' }
                ],
                'recommended': [
                    { value: 'homepage_recommended', text: 'الصفحة الرئيسية - موصى به' }
                ],
                'banner': [
                    { value: 'sidebar', text: 'الشريط الجانبي' }
                ],
                'category_sections': [
                    { value: 'homepage_featured', text: 'أقسام التصنيفات في الصفحة الرئيسية' }
                ]
            };

            const availablePositions = positions[adType] || [];
            positionSelect.innerHTML = '<option value="">اختر الموضع</option>' +
                availablePositions.map(p => `<option value="${p.value}">${p.text}</option>`).join('');
            
            // تفعيل الحقل بعد إضافة الخيارات
            positionSelect.disabled = false;
        }

        // تحميل طلبات الإعلانات
        async function loadAdRequests() {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                // لا توجد طلبات إعلانات في النظام المبسط
                displayAdRequests([]);
            } catch (error) {
                console.error('خطأ في تحميل طلبات الإعلانات:', error);
            }
        }

        // عرض طلبات الإعلانات
        function displayAdRequests(requests) {
            const tableBody = document.getElementById('ad-requests-table');
            if (!tableBody) return;

            if (!requests || requests.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">لا توجد طلبات إعلانات</td></tr>';
                return;
            }

            const rows = requests.map(request => `
                <tr>
                    <td>${request.products?.name || 'غير محدد'}</td>
                    <td>${request.seller_email || 'غير محدد'}</td>
                    <td>${getAdTypeText(request.ad_type)}</td>
                    <td>${getAdPositionText(request.position)}</td>
                    <td>${request.duration_days}</td>
                    <td>${request.budget} ج.م</td>
                    <td>${request.message || 'لا توجد رسالة'}</td>
                    <td>${getRequestStatusText(request.status)}</td>
                    <td>${formatDate(request.created_at)}</td>
                    <td>
                        <button onclick="reviewAdRequest('${request.id}')" class="btn-review">مراجعة</button>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = rows;
        }

        // تحميل إحصائيات الإعلانات
        async function loadAdStatistics() {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const stats = await window.advertisingService.getActiveAdvertisements();
                updateAdStatistics(stats);
            } catch (error) {
                console.error('خطأ في تحميل إحصائيات الإعلانات:', error);
            }
        }

        // تحديث إحصائيات الإعلانات
        function updateAdStatistics(stats) {
            if (!stats || stats.length === 0) return;

            const totalClicks = stats.reduce((sum, ad) => sum + (ad.clicks_count || 0), 0);
            const totalImpressions = stats.reduce((sum, ad) => sum + (ad.impressions_count || 0), 0);
            const activeAds = stats.filter(ad => ad.is_active === true).length;

            document.getElementById('active-ads-count').textContent = activeAds;
            document.getElementById('total-clicks').textContent = totalClicks;
            document.getElementById('total-impressions').textContent = totalImpressions;
        }

        // إظهار نموذج إضافة إعلان
        function showAddAdForm() {
            try {
                const modal = document.getElementById('add-ad-form');
                if (!modal) {
                    console.error('لم يتم العثور على النافذة المنبثقة');
                    return;
                }
                
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                modal.style.visibility = 'visible';
                modal.classList.add('show');
                
                // إعادة تعيين النموذج
                const form = document.getElementById('new-ad-form');
                if (form) form.reset();
                
                const productSelect = document.getElementById('ad-product');
                if (productSelect) {
                    productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                    productSelect.disabled = true;
                }
                
                const positionSelect = document.getElementById('ad-position');
                if (positionSelect) {
                    positionSelect.innerHTML = '<option value="">اختر النوع أولاً</option>';
                    positionSelect.disabled = true; // تعطيل الحقل
                }
                
                console.log('تم فتح النافذة المنبثقة بنجاح');
            } catch (error) {
                console.error('خطأ في فتح النافذة المنبثقة:', error);
            }
        }

        // إخفاء نموذج إضافة إعلان
        function hideAddAdForm() {
            const modal = document.getElementById('add-ad-form');
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';
            modal.classList.remove('show');
        }

        // تحميل المنتجات حسب التصنيف
        async function loadProductsForCategory() {
            try {
                const category = document.getElementById('ad-category').value;
                const productSelect = document.getElementById('ad-product');
                
                if (!category) {
                    productSelect.innerHTML = '<option value="">اختر التصنيف أولاً</option>';
                    productSelect.disabled = true;
                    return;
                }
                
                // تحديد اسم الجدول
                let tableName = 'products_other';
                switch (category) {
                    case 'cake':
                        tableName = 'products_cake';
                        break;
                    case 'koshat':
                        tableName = 'products_koshat';
                        break;
                    case 'mirr':
                        tableName = 'products_mirr';
                        break;
                    case 'other':
                        tableName = 'products_other';
                        break;
                    case 'invitations':
                        tableName = 'products_invitations';
                        break;
                }
                
                // جلب المنتجات من الجدول المحدد
                const { data: products, error } = await window.supabaseClient
                    .from(tableName)
                    .select('id, description, price')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('خطأ في جلب المنتجات:', error);
                    productSelect.innerHTML = '<option value="">خطأ في تحميل المنتجات</option>';
                    return;
                }
                
                // ملء قائمة المنتجات
                productSelect.innerHTML = '<option value="">اختر المنتج</option>';
                if (products && products.length > 0) {
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.description} - ${product.price > 0 ? product.price + ' ج.م' : 'السعر عند الطلب'}`;
                        option.setAttribute('data-category', category);
                        productSelect.appendChild(option);
                    });
                } else {
                    productSelect.innerHTML = '<option value="">لا توجد منتجات في هذا التصنيف</option>';
                }
                
                productSelect.disabled = false;
            } catch (error) {
                console.error('خطأ في تحميل المنتجات:', error);
                const productSelect = document.getElementById('ad-product');
                productSelect.innerHTML = '<option value="">خطأ في تحميل المنتجات</option>';
            }
        }

        // تحديث أقسام الإعلانات حسب التصنيف
        function updateAdSections() {
            const category = document.getElementById('ad-category').value;
            const sectionSelect = document.getElementById('ad-section');
            
            // إعادة تعيين القسم
            sectionSelect.innerHTML = '<option value="">اختر القسم</option>';
            sectionSelect.disabled = true;
            
            if (!category) {
                return;
            }
            
            // تحديد الأقسام المتاحة حسب التصنيف
            const sections = getAvailableSections(category);
            
            if (sections && sections.length > 0) {
                sections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.value;
                    option.textContent = section.label;
                    sectionSelect.appendChild(option);
                });
                sectionSelect.disabled = false;
            }
        }

        // تحديث أقسام الإعلانات في نموذج التعديل
        function updateEditAdSections() {
            const category = document.getElementById('edit-ad-category').value;
            const sectionSelect = document.getElementById('edit-ad-section');
            
            // إعادة تعيين القسم
            sectionSelect.innerHTML = '<option value="">اختر القسم</option>';
            sectionSelect.disabled = true;
            
            if (!category) {
                return;
            }
            
            // تحديد الأقسام المتاحة حسب التصنيف
            const sections = getAvailableSections(category);
            
            if (sections && sections.length > 0) {
                sections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.value;
                    option.textContent = section.label;
                    sectionSelect.appendChild(option);
                });
                sectionSelect.disabled = false;
            }
        }

        // الحصول على الأقسام المتاحة حسب التصنيف
        function getAvailableSections(category) {
            const sections = {
                'koshat': [
                    { value: 'koshat', label: 'قسم الكوشات في الصفحة الرئيسية' }
                ],
                'cake': [
                    { value: 'cake', label: 'قسم التورتات في الصفحة الرئيسية' }
                ],
                'mirr': [
                    { value: 'mirr', label: 'قسم المرايا في الصفحة الرئيسية' }
                ],
                'other': [
                    { value: 'other', label: 'قسم الديكورات في الصفحة الرئيسية' }
                ],
                'invitations': [
                    { value: 'invitations', label: 'قسم الدعوات في الصفحة الرئيسية' }
                ]
            };
            
            return sections[category] || [];
        }

        // تحديث مواضع الإعلانات حسب النوع
        function updateAdPositions() {
            const adType = document.getElementById('ad-type').value;
            const positionSelect = document.getElementById('ad-position');
            
            // إعادة تعيين الحقل
            positionSelect.innerHTML = '<option value="">اختر الموضع</option>';
            positionSelect.disabled = true; // تعطيل الحقل أولاً
            
            if (!adType) {
                return; // لا تفعل الحقل إذا لم يتم اختيار نوع
            }
            
            if (adType === 'featured') {
                positionSelect.innerHTML += '<option value="homepage_featured">الصفحة الرئيسية - مميز</option>';
                positionSelect.innerHTML += '<option value="category_featured">صفحة التصنيف - مميز</option>';
                positionSelect.disabled = false; // تفعيل الحقل
            } else if (adType === 'recommended') {
                positionSelect.innerHTML += '<option value="homepage_recommended">الصفحة الرئيسية - موصى به</option>';
                positionSelect.disabled = false; // تفعيل الحقل
            } else if (adType === 'banner') {
                positionSelect.innerHTML += '<option value="sidebar">الشريط الجانبي</option>';
                positionSelect.disabled = false; // تفعيل الحقل
            } else if (adType === 'category_sections') {
                // للنوع الجديد - استخدام موضع صحيح من قاعدة البيانات
                positionSelect.innerHTML += '<option value="homepage_featured">أقسام التصنيفات في الصفحة الرئيسية</option>';
                // تعيين القيمة تلقائياً
                positionSelect.value = 'homepage_featured';
                positionSelect.disabled = true; // تعطيل التعديل
            }
        }





        // إنشاء إعلان جديد
        async function createNewAdvertisement() {
            try {
                const category = document.getElementById('ad-category').value;
                const section = document.getElementById('ad-section').value;
                const productSelect = document.getElementById('ad-product');
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                
                const formData = {
                    title: document.getElementById('ad-title').value,
                    description: document.getElementById('ad-description').value,
                    image_url: null, // سيتم تعيينه تلقائياً من المنتج
                    link_url: null, // سيتم تعيينه تلقائياً من المنتج
                    product_id: document.getElementById('ad-product').value,
                    product_category: category,
                    category_section: section, // القسم الجديد
                    ad_type: document.getElementById('ad-type').value,
                    position: document.getElementById('ad-position').value,
                    start_date: document.getElementById('ad-start-date').value,
                    end_date: document.getElementById('ad-end-date').value,
                    priority: document.getElementById('ad-priority').value,
                    budget: document.getElementById('ad-budget').value
                };
                
                // التحقق من صحة البيانات
                if (!category || !section || !formData.product_id || !formData.ad_type || !formData.position || !formData.start_date) {
                    alert('يرجى ملء جميع الحقول المطلوبة (التصنيف، القسم، المنتج، نوع الإعلان، الموضع، تاريخ البداية)');
                    return;
                }

                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }

                const result = await window.advertisingService.createAdvertisement(formData);
                if (result) {
                    if (result.is_request) {
                        // تم إنشاء طلب إعلان بدلاً من الإعلان المباشر
                        alert(`تم إنشاء طلب إعلان بنجاح!\n\n${result.message}\n\nسيتم مراجعته من قبل الإدارة قريباً.`);
                        hideAddAdForm();
                        loadAdRequests(); // تحديث قائمة طلبات الإعلانات
                    } else {
                        // تم إنشاء الإعلان مباشرة
                        alert('تم إنشاء الإعلان بنجاح');
                        hideAddAdForm();
                        loadActiveAdvertisements();
                    }
                }
            } catch (error) {
                console.error('خطأ في إنشاء الإعلان:', error);
                alert('حدث خطأ أثناء إنشاء الإعلان');
            }
        }

        // مراجعة طلب إعلان
        function reviewAdRequest(requestId) {
            // هنا يمكنك إظهار تفاصيل الطلب
            document.getElementById('review-request-modal').style.display = 'flex';
        }

        // إخفاء نموذج مراجعة الطلب
        function hideReviewRequestModal() {
            document.getElementById('review-request-modal').style.display = 'none';
        }

        // قبول طلب إعلان
        async function approveAdRequest() {
            // هنا يمكنك تنفيذ منطق قبول الطلب
            alert('تم قبول الطلب بنجاح');
            hideReviewRequestModal();
            loadAdRequests();
        }

        // رفض طلب إعلان
        async function rejectAdRequest() {
            // هنا يمكنك تنفيذ منطق رفض الطلب
            alert('تم رفض الطلب بنجاح');
            hideReviewRequestModal();
            loadAdRequests();
        }

        // فلترة طلبات الإعلانات
        function filterAdRequests() {
            const status = document.getElementById('request-status-filter').value;
            // هنا يمكنك تنفيذ منطق الفلترة
        }

        // دوال مساعدة
        function getAdTypeText(type) {
            const typeMap = {
                'featured': 'مميز',
                'recommended': 'موصى به',
                'banner': 'بانر'
            };
            return typeMap[type] || type;
        }

        function getAdPositionText(position) {
            const positionMap = {
                'homepage_featured': 'الصفحة الرئيسية - مميز',
                'homepage_recommended': 'الصفحة الرئيسية - موصى به',
                'category_featured': 'صفحة التصنيف - مميز',
                'sidebar': 'الشريط الجانبي'
            };
            return positionMap[position] || position;
        }
        
        // ===== دوال الإحصائيات الشاملة =====
        
        // تحميل الإحصائيات الشاملة
        async function loadSystemStatistics() {
            try {
                console.log('📊 تحميل الإحصائيات الشاملة...');
                console.log('🔍 فحص توفر الخدمات...');
                
                // فحص توفر خدمة الإعلانات
                if (!window.advertisingService) {
                    console.error('❌ خدمة الإعلانات غير متوفرة');
                    console.log('🔍 محاولة انتظار تحميل الخدمة...');
                    
                    // انتظار تحميل الخدمة
                    let attempts = 0;
                    while (!window.advertisingService && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                        console.log(`محاولة ${attempts}: انتظار تحميل خدمة الإعلانات...`);
                    }
                    
                    if (!window.advertisingService) {
                        console.error('❌ فشل في تحميل خدمة الإعلانات بعد 50 محاولة');
                        alert('خطأ: خدمة الإعلانات غير متوفرة. يرجى تحديث الصفحة.');
                        return;
                    }
                }
                
                console.log('✅ خدمة الإعلانات متوفرة:', window.advertisingService);
                
                // فحص توفر دوال الإحصائيات
                if (!window.advertisingService.getSystemStatistics) {
                    console.error('❌ دالة getSystemStatistics غير متوفرة');
                    alert('خطأ: دالة الإحصائيات غير متوفرة. يرجى تحديث الصفحة.');
                    return;
                }
                
                console.log('✅ دالة getSystemStatistics متوفرة');
                
                // جلب الإحصائيات الشاملة
                console.log('🔄 جلب الإحصائيات من قاعدة البيانات...');
                const stats = await window.advertisingService.getSystemStatistics();
                
                console.log('📊 الإحصائيات المستلمة:', stats);
                
                if (stats) {
                    console.log('✅ تم جلب الإحصائيات بنجاح، عرض البيانات...');
                    displaySystemStatistics(stats);
                } else {
                    console.error('❌ فشل في جلب الإحصائيات - البيانات فارغة');
                    alert('تحذير: لم يتم العثور على بيانات إعلانات. قد تكون قاعدة البيانات فارغة.');
                }
                
            } catch (error) {
                console.error('❌ خطأ في تحميل الإحصائيات الشاملة:', error);
                alert(`خطأ في تحميل الإحصائيات: ${error.message}`);
            }
        }
        
        // عرض الإحصائيات الشاملة
        function displaySystemStatistics(stats) {
            // الإحصائيات الرئيسية
            document.getElementById('total-ads-stat').textContent = stats.total_advertisements;
            document.getElementById('active-ads-stat').textContent = stats.active_advertisements;
            document.getElementById('total-impressions-stat').textContent = stats.total_impressions.toLocaleString('ar-EG');
            document.getElementById('total-clicks-stat').textContent = stats.total_clicks.toLocaleString('ar-EG');
            
            // معدلات الأداء
            document.getElementById('overall-ctr-stat').textContent = stats.overall_ctr + '%';
            document.getElementById('avg-impressions-stat').textContent = stats.average_impressions_per_ad;
            document.getElementById('avg-clicks-stat').textContent = stats.average_clicks_per_ad;
            
            // عرض الإحصائيات التفصيلية
            displayTypeStatistics(stats.by_type);
            displayPositionStatistics(stats.by_position);
            displayCategoryStatistics(stats.by_category);
        }
        
        // عرض إحصائيات النوع
        function displayTypeStatistics(typeStats) {
            const container = document.getElementById('type-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>النوع</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(typeStats).forEach(([type, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td>${getAdTypeText(type)}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // عرض إحصائيات الموضع
        function displayPositionStatistics(positionStats) {
            const container = document.getElementById('position-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>الموضع</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(positionStats).forEach(([position, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td>${getAdPositionText(position)}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // عرض إحصائيات التصنيف
        function displayCategoryStatistics(categoryStats) {
            const container = document.getElementById('category-stats');
            if (!container) return;
            
            let html = '<table class="stats-table">';
            html += '<thead><tr><th>التصنيف</th><th>العدد</th><th>الظهورات</th><th>النقرات</th><th>معدل النقر</th></tr></thead><tbody>';
            
            Object.entries(categoryStats).forEach(([category, data]) => {
                const ctr = data.impressions > 0 ? ((data.clicks / data.impressions) * 100).toFixed(2) : '0.00';
                const categoryText = getCategoryText(category);
                html += `<tr>
                    <td>${categoryText}</td>
                    <td>${data.count}</td>
                    <td>${data.impressions.toLocaleString('ar-EG')}</td>
                    <td>${data.clicks.toLocaleString('ar-EG')}</td>
                    <td>${ctr}%</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // تحديث الإحصائيات
        function refreshSystemStatistics() {
            loadSystemStatistics();
        }
        
        // تصدير الإحصائيات
        function exportStatistics() {
            // يمكن إضافة منطق التصدير هنا
            alert('سيتم إضافة ميزة تصدير الإحصائيات قريباً');
        }
        
        // دالة مساعدة للحصول على نص التصنيف
        function getCategoryText(category) {
            const categoryMap = {
                'cake': 'تورتات',
                'koshat': 'كشات',
                'mirr': 'مير',
                'other': 'أخرى',
                'invitations': 'دعوات وتوزيعات'
            };
            return categoryMap[category] || category;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'paid': 'مدفوع',
                'expired': 'منتهي الصلاحية',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function getRequestStatusText(status) {
            const statusMap = {
                'pending': 'في الانتظار',
                'approved': 'مقبول',
                'rejected': 'مرفوض',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        // فتح صفحة تفاصيل الإعلان
        async function openAdDetails(adId) {
            try {
                if (!window.advertisingService) {
                    console.error('خدمة الإعلانات غير متوفرة');
                    return;
                }
                
                console.log('🔍 فتح تفاصيل الإعلان:', adId);
                
                // جلب تفاصيل الإعلان مع المنتج
                const adWithProduct = await window.advertisingService.getAdvertisementWithProduct(adId);
                
                // فتح نافذة جديدة مع التفاصيل
                const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (detailsWindow) {
                    detailsWindow.document.write(createAdDetailsPage(adWithProduct));
                    detailsWindow.document.close();
                } else {
                    // إذا فشل فتح النافذة، اعرض في نفس الصفحة
                    showAdDetailsModal(adWithProduct);
                }
                
            } catch (error) {
                console.error('❌ خطأ في فتح تفاصيل الإعلان:', error);
                alert('حدث خطأ في فتح تفاصيل الإعلان');
            }
        }

        // إنشاء صفحة تفاصيل الإعلان
        function createAdDetailsPage(ad) {
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>تفاصيل الإعلان - ${ad.title}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: #f8fafc;
                            color: #1f2937;
                            line-height: 1.6;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 30px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                            text-align: center;
                        }
                        
                        .header h1 {
                            font-size: 2.5em;
                            margin-bottom: 10px;
                        }
                        
                        .header .subtitle {
                            font-size: 1.2em;
                            opacity: 0.9;
                        }
                        
                        .content-section {
                            background: white;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        }
                        
                        .section-title {
                            font-size: 1.5em;
                            color: #374151;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #e5e7eb;
                            padding-bottom: 10px;
                        }
                        
                        .product-images {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .product-image {
                            width: 100%;
                            height: 200px;
                            object-fit: cover;
                            border-radius: 8px;
                            border: 2px solid #e5e7eb;
                        }
                        
                        .product-details {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                        }
                        
                        .detail-item {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            padding: 10px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        
                        .detail-icon {
                            font-size: 1.2em;
                        }
                        
                        .detail-label {
                            font-weight: 600;
                            color: #374151;
                        }
                        
                        .detail-value {
                            color: #6b7280;
                        }
                        
                        .social-links {
                            display: flex;
                            gap: 15px;
                            flex-wrap: wrap;
                        }
                        
                        .social-link {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 10px 15px;
                            background: #dbeafe;
                            color: #1e40af;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 500;
                            transition: all 0.3s ease;
                        }
                        
                        .social-link:hover {
                            background: #bfdbfe;
                            transform: translateY(-2px);
                        }
                        
                        .ad-info {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-card {
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                        }
                        
                        .info-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #3b82f6;
                            margin-bottom: 5px;
                        }
                        
                        .info-label {
                            color: #6b7280;
                            font-size: 0.9em;
                        }
                        
                        .close-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            padding: 10px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1.1em;
                            transition: all 0.3s ease;
                        }
                        
                        .close-btn:hover {
                            background: #dc2626;
                            transform: scale(1.1);
                        }
                    </style>
                </head>
                <body>
                    <button class="close-btn" onclick="window.close()">❌ إغلاق</button>
                    
                    <div class="container">
                        <div class="header">
                            <h1>${ad.title || 'تفاصيل الإعلان'}</h1>
                            <p class="subtitle">${ad.description || 'وصف الإعلان'}</p>
                        </div>
                        
                        ${ad.product && ad.has_product ? `
                            <div class="content-section">
                                <h2 class="section-title">🖼️ صور المنتج</h2>
                                <div class="product-images">
                                    ${ad.product.image_urls && ad.product.image_urls.length > 0 ? 
                                        ad.product.image_urls.map(img => `<img src="${img}" alt="صورة المنتج" class="product-image">`).join('') :
                                        `<img src="${ad.product.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE2Ni41NDkgMTAwIDE4MCA4Ni41NDkgMTgwIDcwQzE4MCA1My40NTEgMTY2LjU0OSA0MCAxNTAgNDBDMTMzLjQ1MSA0MCAxMjAgNTMuNDUxIDEyMCA3MEMxMjAgODYuNTQ5IDEzMy40NTEgMTAwIDE1MCAxMDBaIiBmaWxsPSIjOUI5QkEwIi8+CjxwYXRoIGQ9Ik0xNTAgMTIwQzEzMy40NTEgMTIwIDEyMCAxMzMuNDUxIDEyMCAxNTBDMTIwIDE2Ni41NDkgMTMzLjQ1MSAxODAgMTUwIDE4MEMxNjYuNTQ5IDE4MCAxODAgMTY2LjU0OSAxODAgMTUwQzE4MCAxMzMuNDUxIDE2Ni41NDkgMTIwIDE1MCAxMjBaIiBmaWxsPSIjOUI5QkEwIi8+Cjwvc3ZnPgo='}" alt="صورة المنتج" class="product-image">`
                                    }
                                </div>
                            </div>
                            
                            <div class="content-section">
                                <h2 class="section-title">🛍️ تفاصيل المنتج</h2>
                                <div class="product-details">
                                    <div class="detail-item">
                                        <span class="detail-icon">📝</span>
                                        <span class="detail-label">الاسم:</span>
                                        <span class="detail-value">${ad.product.name || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">💰</span>
                                        <span class="detail-label">السعر:</span>
                                        <span class="detail-value">${ad.product.price || 0} ج.م</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏷️</span>
                                        <span class="detail-label">التصنيف:</span>
                                        <span class="detail-value">${ad.product.category || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">📂</span>
                                        <span class="detail-label">الفئة الفرعية:</span>
                                        <span class="detail-value">${ad.product.subcategory || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏛️</span>
                                        <span class="detail-label">المحافظة:</span>
                                        <span class="detail-value">${ad.product.governorate || 'غير محدد'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-icon">🏙️</span>
                                        <span class="detail-label">المدينة:</span>
                                        <span class="detail-value">${ad.product.cities || 'غير محدد'}</span>
                                    </div>
                                </div>
                                
                                ${ad.product.description ? `
                                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                        <h3 style="margin-bottom: 10px; color: #374151;">📖 الوصف</h3>
                                        <p style="color: #6b7280; line-height: 1.6;">${ad.product.description}</p>
                                    </div>
                                ` : ''}
                                
                                ${(ad.product.whatsapp || ad.product.facebook || ad.product.instagram) ? `
                                    <div style="margin-top: 20px;">
                                        <h3 style="margin-bottom: 15px; color: #374151;">📱 وسائل التواصل</h3>
                                        <div class="social-links">
                                            ${ad.product.whatsapp ? `<a href="https://wa.me/${ad.product.whatsapp}" target="_blank" class="social-link">📱 واتساب: ${ad.product.whatsapp}</a>` : ''}
                                            ${ad.product.facebook ? `<a href="${ad.product.facebook}" target="_blank" class="social-link">📘 فيسبوك</a>` : ''}
                                            ${ad.product.instagram ? `<a href="https://instagram.com/${ad.product.instagram}" target="_blank" class="social-link">📷 إنستغرام: @${ad.product.instagram}</a>` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="content-section">
                                <h2 class="section-title">⚠️ لا يوجد منتج مرتبط</h2>
                                <p style="text-align: center; color: #6b7280; font-size: 1.1em;">هذا الإعلان غير مرتبط بمنتج حقيقي</p>
                            </div>
                        `}
                        
                        <div class="content-section">
                            <h2 class="section-title">📊 معلومات الإعلان</h2>
                            <div class="ad-info">
                                <div class="info-card">
                                    <div class="info-value">${ad.ad_type || 'غير محدد'}</div>
                                    <div class="info-label">نوع الإعلان</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.position || 'غير محدد'}</div>
                                    <div class="info-label">الموقع</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.priority || 1}</div>
                                    <div class="info-label">الأولوية</div>
                                </div>
                                <div class="info-card">
                                    <div class="info-value">${ad.is_active ? 'نشط' : 'متوقف'}</div>
                                    <div class="info-label">الحالة</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="detail-item">
                                    <span class="detail-icon">📅</span>
                                    <span class="detail-label">تاريخ البداية:</span>
                                    <span class="detail-value">${formatDate(ad.start_date)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">⏰</span>
                                    <span class="detail-label">تاريخ الانتهاء:</span>
                                    <span class="detail-value">${ad.end_date ? formatDate(ad.end_date) : 'غير محدد'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${ad.link_url ? `
                            <div class="content-section">
                                <h2 class="section-title">🔗 رابط الإعلان</h2>
                                <a href="${ad.link_url}" target="_blank" style="display: inline-block; padding: 15px 25px; background: #3b82f6; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                                    🌐 فتح الرابط
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `;
        }
    </script>

    <!-- ملف تحسين التمرير -->
    <script src="../js/scroll-optimization.js?v=2025-08-22-1" defer></script>
</body>
</html> 