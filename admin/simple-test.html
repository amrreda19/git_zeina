<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار بسيط - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js?v=2025-08-22-1"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            direction: rtl;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .test-button.success {
            background: #10b981;
        }
        .test-button.success:hover {
            background: #059669;
        }
        .test-button.danger {
            background: #ef4444;
        }
        .test-button.danger:hover {
            background: #dc2626;
        }
        .test-button.warning {
            background: #f59e0b;
        }
        .test-button.warning:hover {
            background: #d97706;
        }
        .log-area {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
        }
        .log-success {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10b981;
        }
        .log-error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
        }
        .log-info {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid #3b82f6;
        }
        .log-warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 4px solid #f59e0b;
        }
        .status-bar {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .status-connected {
            background: #10b981;
        }
        .status-disconnected {
            background: #ef4444;
        }
        .status-loading {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .clear-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
        }
        .clear-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 اختبار بسيط - Supabase</h1>
        
        <!-- شريط الحالة -->
        <div class="status-bar">
            <strong>حالة الاتصال:</strong>
            <span id="connection-status" class="status-indicator status-loading"></span>
            <span id="status-text">جاري الاتصال...</span>
        </div>
        
        <!-- أزرار الاختبار -->
        <button class="test-button" onclick="testConnection()">
            🔌 اختبار الاتصال
        </button>
        
        <button class="test-button" onclick="checkAllTables()">
            📊 فحص جميع الجداول
        </button>
        
        <button class="test-button success" onclick="testProductRequests()">
            📝 اختبار جدول طلبات المنتجات
        </button>
        
        <button class="test-button warning" onclick="testUpdateRandom()">
            🔄 اختبار تحديث عشوائي
        </button>
        
        <button class="test-button" onclick="testInsertRandom()">
            ➕ إضافة منتج اختبار
        </button>
        
        <button class="test-button danger" onclick="testDeleteRandom()">
            🗑️ حذف منتج اختبار
        </button>
        
        <button class="test-button" onclick="testComplexQueries()">
            🔍 استعلامات معقدة
        </button>
        
        <!-- زر مسح السجل -->
        <button class="clear-btn" onclick="clearLog()">
            🧹 مسح السجل
        </button>
        
        <!-- سجل الاختبارات -->
        <div class="log-area">
            <div class="log-entry log-info">🚀 صفحة الاختبار جاهزة. اضغط "اختبار الاتصال" للبدء.</div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let testProductId = null;

        // تهيئة الصفحة
        window.onload = async function() {
            log('📱 تهيئة صفحة الاختبار...', 'info');
            
            // انتظار تحميل Supabase
            let attempts = 0;
            const maxAttempts = 50;
            
            while (!window.supabaseClient && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.supabaseClient) {
                supabaseClient = window.supabaseClient;
                log('✅ تم تحميل Supabase client', 'success');
                updateConnectionStatus('connected');
            } else {
                log('❌ فشل في تحميل Supabase client', 'error');
                updateConnectionStatus('disconnected');
            }
        };

        // تحديث حالة الاتصال
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            indicator.className = `status-indicator status-${status}`;
            
            if (status === 'connected') {
                statusText.textContent = 'متصل';
                statusText.style.color = '#10b981';
            } else if (status === 'disconnected') {
                statusText.textContent = 'غير متصل';
                statusText.style.color = '#ef4444';
            } else {
                statusText.textContent = 'جاري الاتصال...';
                statusText.style.color = '#f59e0b';
            }
        }

        // إضافة رسالة للسجل
        function log(message, type = 'info') {
            const logArea = document.querySelector('.log-area');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // اختبار الاتصال
        async function testConnection() {
            log('🔍 اختبار الاتصال بـ Supabase...', 'info');
            updateConnectionStatus('loading');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client غير متاح');
                }
                
                log('📡 Supabase client متاح', 'success');
                
                // اختبار استعلام بسيط
                const { data, error } = await supabaseClient
                    .from('product_requests')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                log('✅ الاتصال ناجح! تم الوصول لقاعدة البيانات', 'success');
                updateConnectionStatus('connected');
                
            } catch (error) {
                log(`❌ فشل الاتصال: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // فحص جميع الجداول
        async function checkAllTables() {
            log('🔍 فحص جميع الجداول...', 'info');
            
            const tables = [
                'product_requests', 
                'products_koshat', 
                'products_cake', 
                'products_mirr', 
                'products_other', 
                'products_invitations'
            ];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('count')
                        .limit(1);
                    
                    if (error) {
                        log(`❌ جدول ${table}: ${error.message}`, 'error');
                    } else {
                        log(`✅ جدول ${table}: متاح`, 'success');
                    }
                } catch (tableError) {
                    log(`❌ جدول ${table}: ${tableError.message}`, 'error');
                }
            }
        }

        // اختبار جدول طلبات المنتجات
        async function testProductRequests() {
            log('🔍 اختبار جدول طلبات المنتجات...', 'info');
            
            try {
                // جلب عدد الطلبات
                const { count, error: countError } = await supabaseClient
                    .from('product_requests')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    throw countError;
                }
                
                log(`📊 عدد طلبات المنتجات: ${count}`, 'success');
                
                // جلب آخر 3 طلبات
                const { data: recentRequests, error: recentError } = await supabaseClient
                    .from('product_requests')
                    .select('id, description, created_at')
                    .order('created_at', { ascending: false })
                    .limit(3);
                
                if (recentError) {
                    throw recentError;
                }
                
                log('📋 آخر 3 طلبات:', 'info');
                recentRequests.forEach((request, index) => {
                    log(`   ${index + 1}. ID: ${request.id}, الوصف: ${request.description}`, 'info');
                });
                
                // حفظ معرف أول طلب للاختبار
                if (recentRequests.length > 0) {
                    testProductId = recentRequests[0].id;
                    log(`💾 تم حفظ معرف المنتج للاختبار: ${testProductId}`, 'success');
                }
                
            } catch (error) {
                log(`❌ فشل في اختبار جدول طلبات المنتجات: ${error.message}`, 'error');
            }
        }

        // اختبار تحديث عشوائي
        async function testUpdateRandom() {
            if (!testProductId) {
                log('❌ لا يوجد معرف منتج للاختبار. اضغط "اختبار جدول طلبات المنتجات" أولاً', 'error');
                return;
            }
            
            log(`🔍 اختبار تحديث المنتج ${testProductId}...`, 'info');
            
            try {
                // جلب البيانات الحالية
                const { data: currentData, error: fetchError } = await supabaseClient
                    .from('product_requests')
                    .select('*')
                    .eq('id', testProductId)
                    .single();
                
                if (fetchError) {
                    throw new Error(`فشل في جلب البيانات: ${fetchError.message}`);
                }
                
                log('✅ تم جلب البيانات الحالية', 'success');
                
                // تحديث الوصف
                const newDescription = `تم تحديثه في ${new Date().toLocaleString('ar-EG')}`;
                const updateData = {
                    description: newDescription,
                    updated_at: new Date().toISOString()
                };
                
                log(`📝 تحديث الوصف إلى: ${newDescription}`, 'info');
                
                // تنفيذ التحديث
                const { data: updateResult, error: updateError } = await supabaseClient
                    .from('product_requests')
                    .update(updateData)
                    .eq('id', testProductId)
                    .select();
                
                if (updateError) {
                    throw new Error(`فشل في التحديث: ${updateError.message}`);
                }
                
                log('✅ تم التحديث بنجاح!', 'success');
                
                // التحقق من التحديث
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('product_requests')
                    .select('*')
                    .eq('id', testProductId)
                    .single();
                
                if (verifyError) {
                    log(`⚠️ فشل في التحقق: ${verifyError.message}`, 'warning');
                } else {
                    log('✅ تم التحقق من التحديث', 'success');
                    log(`📊 البيانات بعد التحديث: ${JSON.stringify(verifyData, null, 2)}`, 'info');
                }
                
            } catch (error) {
                log(`❌ فشل في اختبار التحديث: ${error.message}`, 'error');
            }
        }

        // إضافة منتج اختبار
        async function testInsertRandom() {
            log('🔍 إضافة منتج اختبار...', 'info');
            
            try {
                const testData = {
                    description: `منتج اختبار - ${new Date().toLocaleString('ar-EG')}`,
                    price: Math.floor(Math.random() * 1000) + 100,
                    category: 'test',
                    governorate: 'القاهرة',
                    created_at: new Date().toISOString()
                };
                
                log(`📝 بيانات المنتج الجديد: ${JSON.stringify(testData, null, 2)}`, 'info');
                
                const { data, error } = await supabaseClient
                    .from('product_requests')
                    .insert(testData)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log('✅ تم إضافة المنتج بنجاح!', 'success');
                log(`📊 المنتج المضاف: ${JSON.stringify(data[0], null, 2)}`, 'info');
                
                // تحديث معرف المنتج للاختبار
                testProductId = data[0].id;
                log(`💾 تم تحديث معرف المنتج للاختبار: ${testProductId}`, 'success');
                
            } catch (error) {
                log(`❌ فشل في إضافة المنتج: ${error.message}`, 'error');
            }
        }

        // حذف منتج اختبار
        async function testDeleteRandom() {
            if (!testProductId) {
                log('❌ لا يوجد معرف منتج للحذف. اضغط "إضافة منتج اختبار" أولاً', 'error');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من حذف المنتج ${testProductId}؟`)) {
                return;
            }
            
            log(`🔍 حذف المنتج ${testProductId}...`, 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from('product_requests')
                    .delete()
                    .eq('id', testProductId)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log('✅ تم حذف المنتج بنجاح!', 'success');
                log(`📊 المنتج المحذوف: ${JSON.stringify(data[0], null, 2)}`, 'info');
                
                // مسح معرف المنتج
                testProductId = null;
                log('💾 تم مسح معرف المنتج', 'info');
                
            } catch (error) {
                log(`❌ فشل في حذف المنتج: ${error.message}`, 'error');
            }
        }

        // استعلامات معقدة
        async function testComplexQueries() {
            log('🔍 اختبار استعلامات معقدة...', 'info');
            
            try {
                // جلب عدد المنتجات في كل جدول
                const tables = ['product_requests', 'products_koshat', 'products_cake'];
                
                for (const table of tables) {
                    try {
                        const { count, error } = await supabaseClient
                            .from(table)
                            .select('*', { count: 'exact', head: true });
                        
                        if (error) {
                            log(`❌ فشل في عد ${table}: ${error.message}`, 'error');
                        } else {
                            log(`📊 جدول ${table}: ${count} منتج`, 'success');
                        }
                    } catch (tableError) {
                        log(`❌ خطأ في ${table}: ${tableError.message}`, 'error');
                    }
                }
                
                // جلب أحدث 5 طلبات
                const { data: recentRequests, error: recentError } = await supabaseClient
                    .from('product_requests')
                    .select('id, description, created_at, price')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (recentError) {
                    throw recentError;
                }
                
                log('📋 أحدث 5 طلبات:', 'info');
                recentRequests.forEach((request, index) => {
                    const price = request.price ? `${request.price} جنيه` : 'غير محدد';
                    log(`   ${index + 1}. ID: ${request.id}, السعر: ${price}, التاريخ: ${new Date(request.created_at).toLocaleDateString('ar-EG')}`, 'info');
                });
                
            } catch (error) {
                log(`❌ فشل في الاستعلامات المعقدة: ${error.message}`, 'error');
            }
        }

        // مسح السجل
        function clearLog() {
            const logArea = document.querySelector('.log-area');
            logArea.innerHTML = '<div class="log-entry log-info">🧹 تم مسح السجل</div>';
        }
    </script>
</body>
</html>

