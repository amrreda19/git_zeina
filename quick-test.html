<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار سريع - إعلانات التورتات</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .btn { padding: 10px 20px; margin: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        .result { margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        .ad-preview { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 اختبار سريع - إعلانات التورتات</h1>
        
        <button class="btn" onclick="testCakeAds()">اختبار إعلانات التورتات</button>
        <button class="btn" onclick="testHomepageDisplay()">اختبار العرض في الصفحة الرئيسية</button>
        
        <div id="results"></div>
    </div>

    <script>
        let supabase = null;
        
        function waitForSupabase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.supabaseClient) {
                        supabase = window.supabaseClient;
                        resolve(supabase);
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        async function testCakeAds() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>🔍 اختبار إعلانات التورتات...</h3>';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    results.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                console.log('🔍 اختبار getCategorySectionAdvertisements...');
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    results.innerHTML = `
                        <h3><span class="success">✅ تم جلب ${ads.length} إعلان!</span></h3>
                        <h4>📊 تفاصيل الإعلانات:</h4>
                        ${ads.map((ad, index) => `
                            <div class="ad-preview">
                                <h5>الإعلان ${index + 1}:</h5>
                                <ul>
                                    <li><strong>ID:</strong> ${ad.id}</li>
                                    <li><strong>العنوان:</strong> ${ad.title || 'غير محدد'}</li>
                                    <li><strong>الوصف:</strong> ${ad.description || 'غير محدد'}</li>
                                    <li><strong>الصورة:</strong> ${ad.image_url || 'غير محدد'}</li>
                                    <li><strong>المنتج مرتبط:</strong> ${ad.product ? '✅ نعم' : '❌ لا'}</li>
                                    ${ad.product ? `
                                        <li><strong>اسم المنتج:</strong> ${ad.product.name || 'غير محدد'}</li>
                                        <li><strong>وصف المنتج:</strong> ${ad.product.description || 'غير محدد'}</li>
                                        <li><strong>سعر المنتج:</strong> ${ad.product.price || 'غير محدد'}</li>
                                        <li><strong>صور المنتج:</strong> ${ad.product.image_urls ? ad.product.image_urls.length : 0}</li>
                                    ` : ''}
                                </ul>
                                <details>
                                    <summary>البيانات الخام</summary>
                                    <pre style="font-size: 10px; background: #f1f5f9; padding: 10px; border-radius: 5px;">${JSON.stringify(ad, null, 2)}</pre>
                                </details>
                            </div>
                        `).join('')}
                    `;
                } else {
                    results.innerHTML = '<span class="warning">⚠️ لا توجد إعلانات للتورتات</span>';
                }
                
            } catch (error) {
                results.innerHTML = `<span class="error">❌ خطأ: ${error.message}</span>`;
                console.error('خطأ في الاختبار:', error);
            }
        }

        async function testHomepageDisplay() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>🏠 اختبار العرض في الصفحة الرئيسية...</h3>';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    results.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    // محاكاة دالة createCategoryAdHTML
                    const html = ads.map(ad => createTestAdHTML(ad)).join('');
                    
                    results.innerHTML = `
                        <h3><span class="success">✅ تم إنشاء HTML بنجاح!</span></h3>
                        <h4>🎨 معاينة الإعلانات:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0;">
                            ${html}
                        </div>
                    `;
                } else {
                    results.innerHTML = '<span class="warning">⚠️ لا توجد إعلانات للعرض</span>';
                }
                
            } catch (error) {
                results.innerHTML = `<span class="error">❌ خطأ: ${error.message}</span>`;
                console.error('خطأ في الاختبار:', error);
            }
        }

        // فتح الواتساب
        function openWhatsApp(phone, productName) {
            const message = `مرحباً، أريد معلومات أكثر عن: ${productName}`;
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function createTestAdHTML(ad) {
            // تحديد الصورة الرئيسية
            let imageUrl = '';
            if (ad.image_url) {
                imageUrl = ad.image_url;
            } else if (ad.product && ad.product.image_url) {
                imageUrl = ad.product.image_url;
            } else if (ad.product && ad.product.image_urls && ad.product.image_urls.length > 0) {
                imageUrl = ad.product.image_urls[0];
            } else {
                imageUrl = 'assets/images/placeholder.jpg';
            }
            
            // تحديد العنوان والوصف
            let title = 'إعلان مميز';
            let description = 'منتج مميز في هذا التصنيف';
            let price = '';
            
            // الأولوية للعنوان: ad.title -> ad.product.name -> fallback
            if (ad.title && ad.title !== 'إعلان جديد') {
                title = ad.title;
            } else if (ad.product && ad.product.name) {
                title = ad.product.name;
            } else if (ad.product && ad.product.description) {
                title = ad.product.description;
            }
            
            // الأولوية للوصف: ad.description -> ad.product.description -> fallback
            if (ad.description && ad.description !== 'إعلان جديد') {
                description = ad.description;
            } else if (ad.product && ad.product.description) {
                description = ad.product.description;
            }
            
            // السعر من المنتج فقط
            if (ad.product && ad.product.price && ad.product.price > 0) {
                price = `${ad.product.price} ج.م`;
            }
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:scale-105" style="width: 280px;">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover" onerror="this.src='assets/images/placeholder.jpg'">
                        <div class="absolute top-2 left-2 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                            🎯 إعلان مميز
                        </div>
                    </div>
                                            <div class="p-4">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">${title}</h3>
                            <p class="text-gray-600 text-sm mb-3">${description}</p>
                            
                            <!-- تفاصيل المنتج -->
                            <div class="space-y-2 mb-3">
                                ${price ? `<div class="text-yellow-600 font-bold text-lg">${price}</div>` : ''}
                                
                                ${ad.product && ad.product.governorate ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-blue-500 ml-1">📍</span>
                                        <span>${ad.product.governorate}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.cities ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-green-500 ml-1">🏙️</span>
                                        <span>${ad.product.cities}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.subcategory ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-purple-500 ml-1">🏷️</span>
                                        <span>${Array.isArray(ad.product.subcategory) ? ad.product.subcategory.join(', ') : ad.product.subcategory}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.whatsapp ? `
                                    <div class="flex items-center text-sm text-green-600">
                                        <span class="ml-1">📱</span>
                                        <span>واتساب متوفر</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">إعلان مميز</span>
                                <div class="flex gap-2">
                                    ${ad.product && ad.product.whatsapp ? `
                                        <button onclick="openWhatsApp('${ad.product.whatsapp}', '${title}')" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition-all duration-200">
                                            📱 اتصل الآن
                                        </button>
                                    ` : ''}
                                    <button class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-yellow-600 hover:to-yellow-700 transition-all duration-200">
                                        عرض التفاصيل
                                    </button>
                                </div>
                            </div>
                        </div>
                </div>
            `;
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 صفحة الاختبار السريع جاهزة');
        });
    </script>
</body>
</html>
