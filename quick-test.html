<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ - Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙˆØ±ØªØ§Øª</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .btn { padding: 10px 20px; margin: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        .result { margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        .ad-preview { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ - Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙˆØ±ØªØ§Øª</h1>
        
        <button class="btn" onclick="testCakeAds()">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙˆØ±ØªØ§Øª</button>
        <button class="btn" onclick="testHomepageDisplay()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        
        <div id="results"></div>
    </div>

    <script>
        let supabase = null;
        
        function waitForSupabase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.supabaseClient) {
                        supabase = window.supabaseClient;
                        resolve(supabase);
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        async function testCakeAds() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙˆØ±ØªØ§Øª...</h3>';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    results.innerHTML = '<span class="error">âŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                    return;
                }
                
                console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± getCategorySectionAdvertisements...');
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    results.innerHTML = `
                        <h3><span class="success">âœ… ØªÙ… Ø¬Ù„Ø¨ ${ads.length} Ø¥Ø¹Ù„Ø§Ù†!</span></h3>
                        <h4>ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª:</h4>
                        ${ads.map((ad, index) => `
                            <div class="ad-preview">
                                <h5>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ${index + 1}:</h5>
                                <ul>
                                    <li><strong>ID:</strong> ${ad.id}</li>
                                    <li><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${ad.title || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                    <li><strong>Ø§Ù„ÙˆØµÙ:</strong> ${ad.description || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                    <li><strong>Ø§Ù„ØµÙˆØ±Ø©:</strong> ${ad.image_url || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                    <li><strong>Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±ØªØ¨Ø·:</strong> ${ad.product ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</li>
                                    ${ad.product ? `
                                        <li><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${ad.product.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                        <li><strong>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${ad.product.description || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                        <li><strong>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${ad.product.price || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</li>
                                        <li><strong>ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${ad.product.image_urls ? ad.product.image_urls.length : 0}</li>
                                    ` : ''}
                                </ul>
                                <details>
                                    <summary>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù…</summary>
                                    <pre style="font-size: 10px; background: #f1f5f9; padding: 10px; border-radius: 5px;">${JSON.stringify(ad, null, 2)}</pre>
                                </details>
                            </div>
                        `).join('')}
                    `;
                } else {
                    results.innerHTML = '<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„Ù„ØªÙˆØ±ØªØ§Øª</span>';
                }
                
            } catch (error) {
                results.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£: ${error.message}</span>`;
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
            }
        }

        async function testHomepageDisplay() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>ğŸ  Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</h3>';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    results.innerHTML = '<span class="error">âŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                    return;
                }
                
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¯Ø§Ù„Ø© createCategoryAdHTML
                    const html = ads.map(ad => createTestAdHTML(ad)).join('');
                    
                    results.innerHTML = `
                        <h3><span class="success">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ HTML Ø¨Ù†Ø¬Ø§Ø­!</span></h3>
                        <h4>ğŸ¨ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0;">
                            ${html}
                        </div>
                    `;
                } else {
                    results.innerHTML = '<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</span>';
                }
                
            } catch (error) {
                results.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£: ${error.message}</span>`;
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
            }
        }

        // ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        function openWhatsApp(phone, productName) {
            const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙƒØ«Ø± Ø¹Ù†: ${productName}`;
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function createTestAdHTML(ad) {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            let imageUrl = '';
            if (ad.image_url) {
                imageUrl = ad.image_url;
            } else if (ad.product && ad.product.image_url) {
                imageUrl = ad.product.image_url;
            } else if (ad.product && ad.product.image_urls && ad.product.image_urls.length > 0) {
                imageUrl = ad.product.image_urls[0];
            } else {
                imageUrl = 'assets/images/placeholder.jpg';
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙˆØµÙ
            let title = 'Ø¥Ø¹Ù„Ø§Ù† Ù…Ù…ÙŠØ²';
            let description = 'Ù…Ù†ØªØ¬ Ù…Ù…ÙŠØ² ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ';
            let price = '';
            
            // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¹Ù†ÙˆØ§Ù†: ad.title -> ad.product.name -> fallback
            if (ad.title && ad.title !== 'Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯') {
                title = ad.title;
            } else if (ad.product && ad.product.name) {
                title = ad.product.name;
            } else if (ad.product && ad.product.description) {
                title = ad.product.description;
            }
            
            // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„ÙˆØµÙ: ad.description -> ad.product.description -> fallback
            if (ad.description && ad.description !== 'Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯') {
                description = ad.description;
            } else if (ad.product && ad.product.description) {
                description = ad.product.description;
            }
            
            // Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·
            if (ad.product && ad.product.price && ad.product.price > 0) {
                price = `${ad.product.price} Ø¬.Ù…`;
            }
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:scale-105" style="width: 280px;">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover" onerror="this.src='assets/images/placeholder.jpg'">
                        <div class="absolute top-2 left-2 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                            ğŸ¯ Ø¥Ø¹Ù„Ø§Ù† Ù…Ù…ÙŠØ²
                        </div>
                    </div>
                                            <div class="p-4">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">${title}</h3>
                            <p class="text-gray-600 text-sm mb-3">${description}</p>
                            
                            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
                            <div class="space-y-2 mb-3">
                                ${price ? `<div class="text-yellow-600 font-bold text-lg">${price}</div>` : ''}
                                
                                ${ad.product && ad.product.governorate ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-blue-500 ml-1">ğŸ“</span>
                                        <span>${ad.product.governorate}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.cities ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-green-500 ml-1">ğŸ™ï¸</span>
                                        <span>${ad.product.cities}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.subcategory ? `
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="text-purple-500 ml-1">ğŸ·ï¸</span>
                                        <span>${Array.isArray(ad.product.subcategory) ? ad.product.subcategory.join(', ') : ad.product.subcategory}</span>
                                    </div>
                                ` : ''}
                                
                                ${ad.product && ad.product.whatsapp ? `
                                    <div class="flex items-center text-sm text-green-600">
                                        <span class="ml-1">ğŸ“±</span>
                                        <span>ÙˆØ§ØªØ³Ø§Ø¨ Ù…ØªÙˆÙØ±</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">Ø¥Ø¹Ù„Ø§Ù† Ù…Ù…ÙŠØ²</span>
                                <div class="flex gap-2">
                                    ${ad.product && ad.product.whatsapp ? `
                                        <button onclick="openWhatsApp('${ad.product.whatsapp}', '${title}')" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition-all duration-200">
                                            ğŸ“± Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù†
                                        </button>
                                    ` : ''}
                                    <button class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-yellow-600 hover:to-yellow-700 transition-all duration-200">
                                        Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                                    </button>
                                </div>
                            </div>
                        </div>
                </div>
            `;
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”§ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¬Ø§Ù‡Ø²Ø©');
        });
    </script>
</body>
</html>
