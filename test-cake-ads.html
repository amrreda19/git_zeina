<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إعلانات التورتات المُحدثة</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 اختبار إعلانات التورتات المُحدثة</h1>
        
        <div class="test-section">
            <h3>1️⃣ اختبار دالة getCategorySectionAdvertisements المُحدثة</h3>
            <button class="btn" onclick="testUpdatedFunction()">اختبار الدالة المُحدثة</button>
            <div id="test1-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2️⃣ اختبار عرض الإعلانات في الصفحة الرئيسية</h3>
            <button class="btn" onclick="testHomepageDisplay()">اختبار العرض</button>
            <div id="test2-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3️⃣ اختبار إنشاء HTML للإعلانات</h3>
            <button class="btn" onclick="testHTMLCreation()">اختبار إنشاء HTML</button>
            <div id="test3-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4️⃣ اختبار شامل</h3>
            <button class="btn btn-success" onclick="runFullTest()">تشغيل اختبار شامل</button>
            <div id="test4-result" class="result"></div>
        </div>
    </div>

    <script>
        let supabase = null;
        
        // انتظار تحميل Supabase
        function waitForSupabase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.supabaseClient) {
                        supabase = window.supabaseClient;
                        resolve(supabase);
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // اختبار الدالة المُحدثة
        async function testUpdatedFunction() {
            const result = document.getElementById('test1-result');
            result.innerHTML = '⏳ جاري الاختبار...';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    result.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                console.log('🔍 اختبار getCategorySectionAdvertisements المُحدثة...');
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    result.innerHTML = `
                        <span class="success">✅ تم جلب ${ads.length} إعلان بنجاح!</span><br>
                        <strong>تفاصيل الإعلانات:</strong><br>
                        ${ads.map((ad, index) => `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <strong>الإعلان ${index + 1}:</strong><br>
                                - العنوان: ${ad.title || 'غير محدد'}<br>
                                - الوصف: ${ad.description || 'غير محدد'}<br>
                                - الصورة: ${ad.image_url || 'غير محدد'}<br>
                                - المنتج: ${ad.product ? '✅ مرتبط' : '❌ غير مرتبط'}<br>
                                - البيانات الخام: <pre style="font-size: 10px;">${JSON.stringify(ad, null, 2)}</pre>
                            </div>
                        `).join('')}
                    `;
                } else {
                    result.innerHTML = '<span class="warning">⚠️ لا توجد إعلانات للتورتات</span>';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">❌ خطأ: ${error.message}</span>`;
                console.error('خطأ في الاختبار:', error);
            }
        }

        // اختبار العرض في الصفحة الرئيسية
        async function testHomepageDisplay() {
            const result = document.getElementById('test2-result');
            result.innerHTML = '⏳ جاري الاختبار...';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    result.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                // محاكاة عرض الإعلانات
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (ads && ads.length > 0) {
                    // محاكاة دالة displayCategoryAds
                    const container = document.createElement('div');
                    container.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${ads.map(ad => createTestAdHTML(ad)).join('')}
                        </div>
                    `;
                    
                    result.innerHTML = `
                        <span class="success">✅ تم إنشاء HTML بنجاح!</span><br>
                        <strong>معاينة الإعلانات:</strong><br>
                        <div style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            ${container.innerHTML}
                        </div>
                    `;
                } else {
                    result.innerHTML = '<span class="warning">⚠️ لا توجد إعلانات للعرض</span>';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">❌ خطأ: ${error.message}</span>`;
                console.error('خطأ في الاختبار:', error);
            }
        }

        // إنشاء HTML للاختبار
        function createTestAdHTML(ad) {
            let imageUrl = '';
            if (ad.image_url) {
                imageUrl = ad.image_url;
            } else if (ad.product && ad.product.image_url) {
                imageUrl = ad.product.image_url;
            } else if (ad.product && ad.product.image_urls && ad.product.image_urls.length > 0) {
                imageUrl = ad.product.image_urls[0];
            } else {
                imageUrl = 'assets/images/placeholder.jpg';
            }
            
            let title = 'إعلان مميز';
            let description = 'منتج مميز في هذا التصنيف';
            let price = '';
            
            if (ad.title) {
                title = ad.title;
            } else if (ad.product && ad.product.name) {
                title = ad.product.name;
            }
            
            if (ad.description) {
                description = ad.description;
            } else if (ad.product && ad.product.description) {
                description = ad.product.description;
            }
            
            if (ad.product && ad.product.price) {
                price = `${ad.product.price} ج.م`;
            }
            
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:scale-105" style="width: 280px;">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover" onerror="this.src='assets/images/placeholder.jpg'">
                        <div class="absolute top-2 left-2 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                            🎯 إعلان مميز
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600 text-sm mb-3">${description}</p>
                        ${price ? `<div class="text-yellow-600 font-bold text-lg mb-2">${price}</div>` : ''}
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">إعلان</span>
                            <button class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                عرض التفاصيل
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // اختبار إنشاء HTML
        async function testHTMLCreation() {
            const result = document.getElementById('test3-result');
            result.innerHTML = '⏳ جاري الاختبار...';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    result.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 1);
                
                if (ads && ads.length > 0) {
                    const ad = ads[0];
                    const html = createTestAdHTML(ad);
                    
                    result.innerHTML = `
                        <span class="success">✅ تم إنشاء HTML بنجاح!</span><br>
                        <strong>HTML المُنشأ:</strong><br>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 10px;">${html}</pre>
                    `;
                } else {
                    result.innerHTML = '<span class="warning">⚠️ لا توجد إعلانات لاختبار HTML</span>';
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">❌ خطأ: ${error.message}</span>`;
                console.error('خطأ في الاختبار:', error);
            }
        }

        // اختبار شامل
        async function runFullTest() {
            const result = document.getElementById('test4-result');
            result.innerHTML = '🚀 بدء الاختبار الشامل...';
            
            try {
                await waitForSupabase();
                
                if (!window.advertisingService) {
                    result.innerHTML = '<span class="error">❌ خدمة الإعلانات غير متوفرة</span>';
                    return;
                }
                
                // اختبار 1: جلب الإعلانات
                result.innerHTML += '<br>1️⃣ جلب الإعلانات...';
                const ads = await window.advertisingService.getCategorySectionAdvertisements('cake', 3);
                
                if (!ads || ads.length === 0) {
                    result.innerHTML += '<span class="warning"> ⚠️ لا توجد إعلانات</span>';
                    return;
                }
                
                result.innerHTML += '<span class="success"> ✅ تم جلب ' + ads.length + ' إعلان</span>';
                
                // اختبار 2: فحص البيانات
                result.innerHTML += '<br>2️⃣ فحص البيانات...';
                let dataValid = true;
                ads.forEach((ad, index) => {
                    if (!ad.title && !ad.product) {
                        dataValid = false;
                    }
                });
                
                if (dataValid) {
                    result.innerHTML += '<span class="success"> ✅ البيانات صحيحة</span>';
                } else {
                    result.innerHTML += '<span class="warning"> ⚠️ بعض البيانات مفقودة</span>';
                }
                
                // اختبار 3: إنشاء HTML
                result.innerHTML += '<br>3️⃣ إنشاء HTML...';
                try {
                    const html = ads.map(ad => createTestAdHTML(ad)).join('');
                    result.innerHTML += '<span class="success"> ✅ تم إنشاء HTML</span>';
                } catch (htmlError) {
                    result.innerHTML += '<span class="error"> ❌ فشل في إنشاء HTML</span>';
                }
                
                result.innerHTML += '<br><br><span class="success">🎉 تم الانتهاء من الاختبار الشامل!</span>';
                
            } catch (error) {
                result.innerHTML += `<br><span class="error">❌ خطأ في الاختبار الشامل: ${error.message}</span>`;
                console.error('خطأ في الاختبار الشامل:', error);
            }
        }

        // تحميل تلقائي عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 صفحة اختبار إعلانات التورتات جاهزة');
        });
    </script>
</body>
</html>
